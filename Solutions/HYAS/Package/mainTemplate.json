{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Nikhil Tripathi - v-ntripathi@microsoft.com",
    "comments": "Solution template for HYAS"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[parameters('location')]",
      "metadata": {
        "description": "Region to deploy solution resources"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "playbook1-PlaybookName": {
      "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook1-UserName": {
      "defaultValue": "<username>@<domain>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username to connect to HYAS API"
      }
    },
    "playbook2-PlaybookName": {
      "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook2-UserName": {
      "defaultValue": "<username>@<domain>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username to connect to HYAS API"
      }
    },
    "playbook3-PlaybookName": {
      "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook3-UserName": {
      "defaultValue": "<username>@<domain>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username to connect to HYAS API"
      }
    },
    "playbook4-PlaybookName": {
      "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook4-UserName": {
      "defaultValue": "<username>@<domain>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username to connect to HYAS API"
      }
    },
    "playbook5-PlaybookName": {
      "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook5-UserName": {
      "defaultValue": "<username>@<domain>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username to connect to HYAS API"
      }
    },
    "playbook6-PlaybookName": {
      "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook6-UserName": {
      "defaultValue": "<username>@<domain>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username to connect to HYAS API"
      }
    },
    "playbook7-PlaybookName": {
      "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook7-UserName": {
      "defaultValue": "<username>@<domain>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username to connect to HYAS API"
      }
    },
    "playbook8-PlaybookName": {
      "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook8-UserName": {
      "defaultValue": "<username>@<domain>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username to connect to HYAS API"
      }
    },
    "playbook9-PlaybookName": {
      "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook9-UserName": {
      "defaultValue": "<username>@<domain>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username to connect to HYAS API"
      }
    },
    "playbook10-PlaybookName": {
      "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook10-UserName": {
      "defaultValue": "<username>@<domain>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username to connect to HYAS API"
      }
    },
    "playbook11-PlaybookName": {
      "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook11-UserName": {
      "defaultValue": "<username>@<domain>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username to connect to HYAS API"
      }
    },
    "playbook12-PlaybookName": {
      "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook12-UserName": {
      "defaultValue": "<username>@<domain>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username to connect to HYAS API"
      }
    },
    "playbook13-PlaybookName": {
      "defaultValue": "Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook13-UserName": {
      "defaultValue": "<username>@<domain>",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Username to connect to HYAS API"
      }
    }
  },
  "variables": {
    "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS')]",
    "playbook1-HYASInsightApiKey": "[concat('hyasinsight-', parameters('playbook1-PlaybookName'))]",
    "playbook1-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook1-PlaybookName'))]",
    "playbook-1-connection-1": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]",
    "_playbook-1-connection-1": "[variables('playbook-1-connection-1')]",
    "playbook-1-connection-2": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]",
    "_playbook-1-connection-2": "[variables('playbook-1-connection-2')]",
    "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS')]",
    "playbook2-HYASInsightApiKey": "[concat('hyasinsight-', parameters('playbook2-PlaybookName'))]",
    "playbook2-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook2-PlaybookName'))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS": "Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS')]",
    "playbook3-HYASInsightApiKey": "[concat('hyasinsight-', parameters('playbook3-PlaybookName'))]",
    "playbook3-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook3-PlaybookName'))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS')]",
    "playbook4-HYASInsightApiKey": "[concat('hyasinsight-', parameters('playbook4-PlaybookName'))]",
    "playbook4-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook4-PlaybookName'))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS": "Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS')]",
    "playbook5-HYASInsightApiKey": "[concat('hyasinsight-', parameters('playbook5-PlaybookName'))]",
    "playbook5-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook5-PlaybookName'))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS')]",
    "playbook6-HYASInsightApiKey": "[concat('hyasinsight-', parameters('playbook6-PlaybookName'))]",
    "playbook6-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook6-PlaybookName'))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS')]",
    "playbook7-HYASInsightApiKey": "[concat('hyasinsight-', parameters('playbook7-PlaybookName'))]",
    "playbook7-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook7-PlaybookName'))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash')]",
    "playbook8-HYASInsightApiKey": "[concat('hyasinsight-', parameters('playbook8-PlaybookName'))]",
    "playbook8-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook8-PlaybookName'))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate": "Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate')]",
    "playbook9-HYASInsightApiKey": "[concat('hyasinsight-', parameters('playbook9-PlaybookName'))]",
    "playbook9-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook9-PlaybookName'))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole": "Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole')]",
    "playbook10-HYASInsightApiKey": "[concat('hyasinsight-', parameters('playbook10-PlaybookName'))]",
    "playbook10-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook10-PlaybookName'))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo": "Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo')]",
    "playbook11-HYASInsightApiKey": "[concat('hyasinsight-', parameters('playbook11-PlaybookName'))]",
    "playbook11-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook11-PlaybookName'))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo": "Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo",
    "_Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo')]",
    "playbook12-HYASInsightApiKey": "[concat('hyasinsight-', parameters('playbook12-PlaybookName'))]",
    "playbook12-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook12-PlaybookName'))]",
    "Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS": "Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS",
    "_Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS": "[variables('Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS')]",
    "playbook13-HYASInsightApiKey": "[concat('hyasinsight-', parameters('playbook13-PlaybookName'))]",
    "playbook13-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook13-PlaybookName'))]",
    "sourceId": "hyas.a-hyas-insight-azure-sentinel-solutions-gallery",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook1-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook1-HYASInsightApiKey')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[parameters('playbook1-UserName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook1-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook1-HYASInsightApiKey'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "Contact_Info_Variable": {
              "runAfter": {
                "Sentinel_Incident_Comment_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Contact Info",
                    "type": "array"
                  }
                ]
              }
            },
            "Entities_-_Get_Hosts": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              }
            },
            "JSON_Output_Variable": {
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Json Output",
                    "type": "array"
                  }
                ]
              }
            },
            "Looping_through_Hosts_Object": {
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "actions": {
                "Add_comment_to_incident_(V2)_2": {
                  "runAfter": {
                    "Checking_If_the_Response_Returned_Data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "Value": "HYAS Insight Current WHOIS enrichment data for the domain \"@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}\" :  @{replace(replace(replace(replace(replace(variables('Comment'),'&quot;',''),'{',''),'}',''),'[',''),']','')}  For detailed information, see https://insight.hyas.com/static/details?domain=@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                  }
                },
                "Checking_If_the_Response_Returned_Data": {
                  "actions": {
                    "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "Comment",
                        "value": "@body('Create_HTML_table')"
                      }
                    },
                    "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                      "actions": {
                        "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Comment",
                            "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                          }
                        }
                      },
                      "runAfter": {
                        "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Create_HTML_table'))",
                              3000
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "Looping_Through_Response_Object": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Json Output')"
                      }
                    },
                    "Looping_Through_Response_Object": {
                      "foreach": "@body('Retrieve_Current_WHOIS_information_for_domain')?['items']",
                      "actions": {
                        "Creating_Contact_Object": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "Contact Info",
                            "value": {
                              "Email": "@items('Looping_Through_Response_Object')?['email']",
                              "Phone Number": "@items('Looping_Through_Response_Object')?['phone']"
                            }
                          }
                        },
                        "Creating_JSON_Output_Variable_Object": {
                          "runAfter": {
                            "Creating_Contact_Object": [
                              "Succeeded"
                            ]
                          },
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "Json Output",
                            "value": {
                              "Contact Info": "@variables('Contact Info')",
                              "Creation Date": "@items('Looping_Through_Response_Object')?['domain_created_datetime']",
                              "Expire Date": "@items('Looping_Through_Response_Object')?['domain_expires_datetime']",
                              "Nameservers": "@items('Looping_Through_Response_Object')?['nameserver']",
                              "Registrar": "@items('Looping_Through_Response_Object')?['registrar']"
                            }
                          }
                        }
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Setting_Response_Length_Variable": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "No_Records_Found": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Comment",
                          "value": "No records found in HYAS Insight for domain \"@{items('Looping_through_Hosts_Object')?['HostName']}@{items('Looping_through_Hosts_Object')?['DnsDomain']}.\""
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@variables('RecordsLength')",
                          0
                        ]
                      }
                    ]
                  },
                  "type": "If"
                },
                "Retrieve_Current_WHOIS_information_for_domain": {
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "applied_filters": {
                        "current": true,
                        "domain": "@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                      }
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/whois"
                  }
                },
                "Setting_Response_Length_Variable": {
                  "runAfter": {
                    "Retrieve_Current_WHOIS_information_for_domain": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "RecordsLength",
                    "value": "@length(body('Retrieve_Current_WHOIS_information_for_domain')?['items'])"
                  }
                }
              },
              "runAfter": {
                "Contact_Info_Variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Response_Length_Variable": {
              "runAfter": {
                "JSON_Output_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "RecordsLength",
                    "type": "integer",
                    "value": 0
                  }
                ]
              }
            },
            "Sentinel_Incident_Comment_Variable": {
              "runAfter": {
                "Response_Length_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Comment",
                    "type": "string"
                  }
                ]
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook1-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "hyasinsight": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-HYASInsightApiKey'))]",
                "connectionName": "[variables('playbook1-HYASInsightApiKey')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook2-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook2-HYASInsightApiKey')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[parameters('playbook2-UserName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook2-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook2-HYASInsightApiKey'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook2-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "Entities_-_Get_Hosts": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              }
            },
            "JSON_Output_Variable": {
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Json Output",
                    "type": "array"
                  }
                ]
              }
            },
            "Looping_through_Hosts_Object": {
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "actions": {
                "Add_comment_to_incident_(V2)_2": {
                  "runAfter": {
                    "Checking_If_the_Response_Returned_Data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "Value": "HYAS Insight Historic WHOIS enrichment data for the domain \"@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}\" :  @{replace(variables('Comment'), '&quot;', '')}  For detailed information, see https://insight.hyas.com/static/details?domain=@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                  }
                },
                "Checking_If_the_Response_Returned_Data": {
                  "actions": {
                    "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "Comment",
                        "value": "@body('Create_HTML_table')"
                      }
                    },
                    "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                      "actions": {
                        "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Comment",
                            "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                          }
                        }
                      },
                      "runAfter": {
                        "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Create_HTML_table'))",
                              3000
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "Looping_Through_Response_Object": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Json Output')"
                      }
                    },
                    "Looping_Through_Response_Object": {
                      "foreach": "@body('Retrieve_Historic_WHOIS_information_for_domain')",
                      "actions": {
                        "For_each_through_Phone_Object": {
                          "foreach": "@items('Looping_Through_Response_Object')['phone']",
                          "actions": {
                            "Creating_JSON_Output_Variable_Object": {
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "Json Output",
                                "value": {
                                  "Email": "@items('Looping_Through_Response_Object')?['email']",
                                  "Phone": "@items('For_each_through_Phone_Object')?['phone']",
                                  "Registrant": "@items('Looping_Through_Response_Object')?['name']",
                                  "Registrar": "@items('Looping_Through_Response_Object')?['registrar']"
                                }
                              }
                            }
                          },
                          "type": "Foreach"
                        }
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Setting_Response_Length_Variable": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "No_Records_Found": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Comment",
                          "value": "No records found in HYAS Insight for domain \"@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}\""
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@variables('RecordsLength')",
                          0
                        ]
                      }
                    ]
                  },
                  "type": "If"
                },
                "Retrieve_Historic_WHOIS_information_for_domain": {
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "applied_filters": {
                        "domain": "@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                      }
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/whois/domain"
                  }
                },
                "Setting_Response_Length_Variable": {
                  "runAfter": {
                    "Retrieve_Historic_WHOIS_information_for_domain": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "RecordsLength",
                    "value": "@length(body('Retrieve_Historic_WHOIS_information_for_domain'))"
                  }
                }
              },
              "runAfter": {
                "Sentinel_Incident_Comment_Variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Response_Length_Variable": {
              "runAfter": {
                "JSON_Output_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "RecordsLength",
                    "type": "integer",
                    "value": 0
                  }
                ]
              }
            },
            "Sentinel_Incident_Comment_Variable": {
              "runAfter": {
                "Response_Length_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Comment",
                    "type": "string"
                  }
                ]
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook2-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook2-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "hyasinsight": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook2-HYASInsightApiKey'))]",
                "connectionName": "[variables('playbook2-HYASInsightApiKey')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook3-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook3-HYASInsightApiKey')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[parameters('playbook3-UserName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook3-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook3-HYASInsightApiKey'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook3-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "Entities_-_Get_Hosts": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              }
            },
            "JSON_Output_Variable": {
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Json Output",
                    "type": "array"
                  }
                ]
              }
            },
            "Looping_through_Hosts_Object": {
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "actions": {
                "Add_comment_to_incident_(V2)_2": {
                  "runAfter": {
                    "Checking_If_the_Response_Returned_Data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "Value": "HYAS Insight Passive DNS enrichment data for the domain \"@{items('Looping_through_Hosts_Object')?['HostName']}@{items('Looping_through_Hosts_Object')?['DnsDomain']}.\" :  @{replace(variables('Comment'), '&quot;', '')}  For detailed information, see https://insight.hyas.com/static/details?domain=@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                  }
                },
                "Checking_If_the_Response_Returned_Data": {
                  "actions": {
                    "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "Comment",
                        "value": "@body('Create_HTML_table')"
                      }
                    },
                    "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                      "actions": {
                        "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Comment",
                            "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                          }
                        }
                      },
                      "runAfter": {
                        "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Create_HTML_table'))",
                              3000
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "Looping_Through_Response_Object": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Json Output')"
                      }
                    },
                    "Looping_Through_Response_Object": {
                      "foreach": "@body('Retrieve_Passive_DNS_information_for_domain')",
                      "actions": {
                        "Creating_JSON_Output_Variable_Object": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "Json Output",
                            "value": {
                              "Count": "@items('Looping_Through_Response_Object')?['count']",
                              "First Seen": "@items('Looping_Through_Response_Object')?['first_seen']",
                              "IP": "@items('Looping_Through_Response_Object')?['ipv4']",
                              "Last Seen": "@items('Looping_Through_Response_Object')?['last_seen']"
                            }
                          }
                        }
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Setting_Response_Length_Variable": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "No_Records_Found": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Comment",
                          "value": "No records found in HYAS Insight for domain \"@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}\""
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@variables('RecordsLength')",
                          0
                        ]
                      }
                    ]
                  },
                  "type": "If"
                },
                "Retrieve_Passive_DNS_information_for_domain": {
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "applied_filters": {
                        "domain": "@{items('Looping_through_Hosts_Object')?['HostName']}.@{items('Looping_through_Hosts_Object')?['DnsDomain']}"
                      }
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/passivedns"
                  }
                },
                "Setting_Response_Length_Variable": {
                  "runAfter": {
                    "Retrieve_Passive_DNS_information_for_domain": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "RecordsLength",
                    "value": "@length(body('Retrieve_Passive_DNS_information_for_domain'))"
                  }
                }
              },
              "runAfter": {
                "Sentinel_Incident_Comment_Variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Response_Length_Variable": {
              "runAfter": {
                "JSON_Output_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "RecordsLength",
                    "type": "integer",
                    "value": 0
                  }
                ]
              }
            },
            "Sentinel_Incident_Comment_Variable": {
              "runAfter": {
                "Response_Length_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Comment",
                    "type": "string"
                  }
                ]
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook3-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook3-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "hyasinsight": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook3-HYASInsightApiKey'))]",
                "connectionName": "[variables('playbook3-HYASInsightApiKey')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook4-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook4-HYASInsightApiKey')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[parameters('playbook4-UserName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook4-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook4-HYASInsightApiKey'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook4-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "Account_Name_Variable": {
              "runAfter": {
                "Sentinel_Incident_Comment_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Email1",
                    "type": "string"
                  }
                ]
              }
            },
            "Account_UPN_Suffix_Variable": {
              "runAfter": {
                "Account_Name_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Email2",
                    "type": "string"
                  }
                ]
              }
            },
            "Email_Connector_Variable": {
              "runAfter": {
                "Account_UPN_Suffix_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Connector",
                    "type": "string",
                    "value": "@"
                  }
                ]
              }
            },
            "Entities_-_Get_Accounts": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/account"
              }
            },
            "JSON_Output_Variable": {
              "runAfter": {
                "Entities_-_Get_Accounts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Json Output",
                    "type": "array"
                  }
                ]
              }
            },
            "Looping_Through_Account_Object_for_Accounts_Name": {
              "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
              "actions": {
                "Add_comment_to_incident_(V2)_2": {
                  "runAfter": {
                    "Checking_If_the_Response_Returned_Data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "Value": "HYAS Insight Dynamic DNS enrichment data for the email \"@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}\" :  @{replace(variables('Comment'), '&quot;', '')}  For detailed information, see https://insight.hyas.com/static/details?email=@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                  }
                },
                "Checking_If_the_Response_Returned_Data": {
                  "actions": {
                    "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "Comment",
                        "value": "@body('Create_HTML_table')"
                      }
                    },
                    "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                      "actions": {
                        "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Comment",
                            "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                          }
                        }
                      },
                      "runAfter": {
                        "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Create_HTML_table'))",
                              3000
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "Looping_Through_Response_Object": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Json Output')"
                      }
                    },
                    "Looping_Through_Response_Object": {
                      "foreach": "@body('Retrieve_Dynamic_DNS_information_for_email_address')",
                      "actions": {
                        "Creating_JSON_Output_Variable_Object": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "Json Output",
                            "value": {
                              "A Record": "@items('Looping_Through_Response_Object')?['a_record']",
                              "Created IP": "@items('Looping_Through_Response_Object')?['created_ip']",
                              "Domain": "@items('Looping_Through_Response_Object')?['domain']",
                              "Domain Creator IP": "@items('Looping_Through_Response_Object')?['domain_creator_ip']",
                              "Timestamp": "@items('Looping_Through_Response_Object')?['created']"
                            }
                          }
                        }
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Setting_Response_Length_Variable": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "No_Records_Found": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Comment",
                          "value": "No records found in HYAS Insight for email \"@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}\"."
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@variables('RecordsLength')",
                          0
                        ]
                      }
                    ]
                  },
                  "type": "If"
                },
                "Retrieve_Dynamic_DNS_information_for_email_address": {
                  "runAfter": {
                    "Setting_Accounts_UPN_suffix_variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "applied_filters": {
                        "email": "@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}"
                      }
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/dynamicdns/email"
                  }
                },
                "Setting_Accounts_Name_Variable": {
                  "type": "SetVariable",
                  "inputs": {
                    "name": "Email1",
                    "value": "@items('Looping_Through_Account_Object_for_Accounts_Name')?['Name']"
                  }
                },
                "Setting_Accounts_UPN_suffix_variable": {
                  "runAfter": {
                    "Setting_Accounts_Name_Variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "Email2",
                    "value": "@items('Looping_Through_Account_Object_for_Accounts_Name')?['UPNSuffix']"
                  }
                },
                "Setting_Response_Length_Variable": {
                  "runAfter": {
                    "Retrieve_Dynamic_DNS_information_for_email_address": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "RecordsLength",
                    "value": "@length(body('Retrieve_Dynamic_DNS_information_for_email_address'))"
                  }
                }
              },
              "runAfter": {
                "Email_Connector_Variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Response_Length_Variable": {
              "runAfter": {
                "JSON_Output_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "RecordsLength",
                    "type": "integer",
                    "value": 0
                  }
                ]
              }
            },
            "Sentinel_Incident_Comment_Variable": {
              "runAfter": {
                "Response_Length_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Comment",
                    "type": "string"
                  }
                ]
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook4-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook4-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "hyasinsight": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook4-HYASInsightApiKey'))]",
                "connectionName": "[variables('playbook4-HYASInsightApiKey')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook5-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook5-HYASInsightApiKey')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[parameters('playbook5-UserName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook5-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook5-HYASInsightApiKey'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook5-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "Account_Name_Variable": {
              "runAfter": {
                "Sentinel_Incident_Comment_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Email1",
                    "type": "string"
                  }
                ]
              }
            },
            "Account_UPN_Suffix_Variable": {
              "runAfter": {
                "Account_Name_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Email2",
                    "type": "string"
                  }
                ]
              }
            },
            "Email_Connector_Variable": {
              "runAfter": {
                "Account_UPN_Suffix_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Connector",
                    "type": "string",
                    "value": "@"
                  }
                ]
              }
            },
            "Entities_-_Get_Accounts": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/account"
              }
            },
            "JSON_Output_Variable": {
              "runAfter": {
                "Entities_-_Get_Accounts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Json Output",
                    "type": "array"
                  }
                ]
              }
            },
            "Looping_Through_Account_Object_for_Accounts_Name": {
              "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
              "actions": {
                "Add_comment_to_incident_(V2)_2": {
                  "runAfter": {
                    "Checking_If_the_Response_Returned_Data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "Value": "HYAS Insight Historic WHOIS enrichment data for the email \"@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}\" :  @{replace(variables('Comment'), '&quot;', '')}  For detailed information, see https://insight.hyas.com/static/details?email=@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                  }
                },
                "Checking_If_the_Response_Returned_Data": {
                  "actions": {
                    "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "Comment",
                        "value": "@body('Create_HTML_table')"
                      }
                    },
                    "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                      "actions": {
                        "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Comment",
                            "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                          }
                        }
                      },
                      "runAfter": {
                        "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Create_HTML_table'))",
                              3000
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "Looping_Through_Response_Object": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Json Output')"
                      }
                    },
                    "Looping_Through_Response_Object": {
                      "foreach": "@body('Retrieve_Historic_WHOIS_information_for_email_address')",
                      "actions": {
                        "For_each_through_Phone_Object": {
                          "foreach": "@items('Looping_Through_Response_Object')['phone']",
                          "actions": {
                            "Creating_JSON_Output_Variable_Object": {
                              "type": "AppendToArrayVariable",
                              "inputs": {
                                "name": "Json Output",
                                "value": {
                                  "Domain": "@items('Looping_Through_Response_Object')?['domain']",
                                  "Phone": "@items('For_each_through_Phone_Object')?['phone']",
                                  "Registrant": "@items('Looping_Through_Response_Object')?['name']",
                                  "Registrar": "@items('Looping_Through_Response_Object')?['registrar']"
                                }
                              }
                            }
                          },
                          "type": "Foreach"
                        }
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Setting_Response_Length_Variable": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "No_Records_Found": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Comment",
                          "value": "No records found in HYAS Insight for email \"@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}\"."
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@variables('RecordsLength')",
                          0
                        ]
                      }
                    ]
                  },
                  "type": "If"
                },
                "Looping_Through_Account_Object_for_UPN_suffix": {
                  "runAfter": {
                    "Setting_Accounts_Name_Variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "Email2",
                    "value": "@items('Looping_Through_Account_Object_for_Accounts_Name')?['UPNSuffix']"
                  }
                },
                "Retrieve_Historic_WHOIS_information_for_email_address": {
                  "runAfter": {
                    "Looping_Through_Account_Object_for_UPN_suffix": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "applied_filters": {
                        "email": "@{concat(variables('Email1'),variables('Connector'),variables('Email2'))}"
                      }
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/whois/email"
                  }
                },
                "Setting_Accounts_Name_Variable": {
                  "type": "SetVariable",
                  "inputs": {
                    "name": "Email1",
                    "value": "@items('Looping_Through_Account_Object_for_Accounts_Name')?['Name']"
                  }
                },
                "Setting_Response_Length_Variable": {
                  "runAfter": {
                    "Retrieve_Historic_WHOIS_information_for_email_address": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "RecordsLength",
                    "value": "@length(body('Retrieve_Historic_WHOIS_information_for_email_address'))"
                  }
                }
              },
              "runAfter": {
                "Email_Connector_Variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Response_Length_Variable": {
              "runAfter": {
                "JSON_Output_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "RecordsLength",
                    "type": "integer",
                    "value": 0
                  }
                ]
              }
            },
            "Sentinel_Incident_Comment_Variable": {
              "runAfter": {
                "Response_Length_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Comment",
                    "type": "string"
                  }
                ]
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook5-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook5-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "hyasinsight": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook5-HYASInsightApiKey'))]",
                "connectionName": "[variables('playbook5-HYASInsightApiKey')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook6-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook6-HYASInsightApiKey')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[parameters('playbook6-UserName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook6-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook6-HYASInsightApiKey'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook6-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "Entities_-_Get_IPs": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              }
            },
            "JSON_Output_Variable": {
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Json Output",
                    "type": "array"
                  }
                ]
              }
            },
            "Looping_Through_Sentinel_IPs": {
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "actions": {
                "Add_comment_to_incident_(V2)_2": {
                  "runAfter": {
                    "Checking_If_the_Response_Returned_Data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "Value": "HYAS Insight Dynamic DNS enrichment data for the IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :  @{replace(variables('Comment'), '&quot;', '')}  For detailed information, see https://insight.hyas.com/static/details?ip=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                  }
                },
                "Checking_If_the_Response_Returned_Data": {
                  "actions": {
                    "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "Comment",
                        "value": "@body('Create_HTML_table')"
                      }
                    },
                    "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                      "actions": {
                        "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Comment",
                            "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                          }
                        }
                      },
                      "runAfter": {
                        "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Create_HTML_table'))",
                              3000
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "Looping_Through_Response_Object": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Json Output')"
                      }
                    },
                    "Looping_Through_Response_Object": {
                      "foreach": "@body('Retrieve_Dynamic_DNS_information_for_IP_address')",
                      "actions": {
                        "Creating_JSON_Output_Variable_Object": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "Json Output",
                            "value": {
                              "A Record": "@items('Looping_Through_Response_Object')?['a_record']",
                              "Created IP": "@items('Looping_Through_Response_Object')?['created_ip']",
                              "Domain Creator IP": "@items('Looping_Through_Response_Object')?['domain_creator_ip']",
                              "Email": "@items('Looping_Through_Response_Object')?['email']",
                              "Timestamp": "@items('Looping_Through_Response_Object')?['created']"
                            }
                          }
                        }
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Setting_Response_Length_Variable": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "No_Records_Found": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Comment",
                          "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@variables('RecordsLength')",
                          0
                        ]
                      }
                    ]
                  },
                  "type": "If"
                },
                "Retrieve_Dynamic_DNS_information_for_IP_address": {
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "applied_filters": {
                        "ip": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                      }
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/dynamicdns"
                  }
                },
                "Setting_Response_Length_Variable": {
                  "runAfter": {
                    "Retrieve_Dynamic_DNS_information_for_IP_address": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "RecordsLength",
                    "value": "@length(body('Retrieve_Dynamic_DNS_information_for_IP_address'))"
                  }
                }
              },
              "runAfter": {
                "Sentinel_Incident_Comment_Variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Response_Length_Variable": {
              "runAfter": {
                "JSON_Output_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "RecordsLength",
                    "type": "integer",
                    "value": 0
                  }
                ]
              }
            },
            "Sentinel_Incident_Comment_Variable": {
              "runAfter": {
                "Response_Length_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Comment",
                    "type": "string"
                  }
                ]
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook6-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook6-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "hyasinsight": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook6-HYASInsightApiKey'))]",
                "connectionName": "[variables('playbook6-HYASInsightApiKey')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook7-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook7-HYASInsightApiKey')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[parameters('playbook7-UserName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook7-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook7-HYASInsightApiKey'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook7-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "Entities_-_Get_IPs": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              }
            },
            "JSON_Output_Variable": {
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Json Output",
                    "type": "array"
                  }
                ]
              }
            },
            "Looping_Through_Sentinel_IPs": {
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "actions": {
                "Add_comment_to_incident_(V2)_2": {
                  "runAfter": {
                    "Checking_If_the_Response_Returned_Data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "Value": "HYAS Insight Passive DNS enrichment data for the IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :  @{replace(variables('Comment'), '&quot;', '')}  For detailed information, see https://insight.hyas.com/static/details?ipv4=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                  }
                },
                "Checking_If_the_Response_Returned_Data": {
                  "actions": {
                    "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "Comment",
                        "value": "@body('Create_HTML_table')"
                      }
                    },
                    "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                      "actions": {
                        "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Comment",
                            "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                          }
                        }
                      },
                      "runAfter": {
                        "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Create_HTML_table'))",
                              3000
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "Looping_Through_Response_Object": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Json Output')"
                      }
                    },
                    "Looping_Through_Response_Object": {
                      "foreach": "@body('Retrieve_Passive_DNS_information_for_IP_address')",
                      "actions": {
                        "Creating_JSON_Output_Variable_Object": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "Json Output",
                            "value": {
                              "Count": "@items('Looping_Through_Response_Object')?['count']",
                              "Domain": "@items('Looping_Through_Response_Object')?['domain']",
                              "First Seen": "@items('Looping_Through_Response_Object')?['first_seen']",
                              "Last Seen": "@items('Looping_Through_Response_Object')?['last_seen']"
                            }
                          }
                        }
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Setting_Response_Length_Variable": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "No_Records_Found": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Comment",
                          "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@variables('RecordsLength')",
                          0
                        ]
                      }
                    ]
                  },
                  "type": "If"
                },
                "Retrieve_Passive_DNS_information_for_IP_address": {
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "applied_filters": {
                        "ipv4": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                      }
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/passivedns/ip"
                  }
                },
                "Setting_Response_Length_Variable": {
                  "runAfter": {
                    "Retrieve_Passive_DNS_information_for_IP_address": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "RecordsLength",
                    "value": "@length(body('Retrieve_Passive_DNS_information_for_IP_address'))"
                  }
                }
              },
              "runAfter": {
                "Sentinel_Incident_Comment_Variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Response_Length_Variable": {
              "runAfter": {
                "JSON_Output_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "RecordsLength",
                    "type": "integer",
                    "value": 0
                  }
                ]
              }
            },
            "Sentinel_Incident_Comment_Variable": {
              "runAfter": {
                "Response_Length_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Comment",
                    "type": "string"
                  }
                ]
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook7-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook7-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "hyasinsight": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook7-HYASInsightApiKey'))]",
                "connectionName": "[variables('playbook7-HYASInsightApiKey')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook8-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook8-HYASInsightApiKey')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[parameters('playbook8-UserName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook8-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook8-HYASInsightApiKey'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook8-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "Entities_-_Get_IPs": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              }
            },
            "JSON_Output_Variable": {
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Json Output",
                    "type": "array"
                  }
                ]
              }
            },
            "Looping_Through_Sentinel_IPs": {
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "actions": {
                "Add_comment_to_incident_(V2)_2": {
                  "runAfter": {
                    "Checking_If_the_Response_Returned_Data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "Value": "HYAS Insight Passive Hash enrichment data for the IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :  @{replace(variables('Comment'), '&quot;', '')}  For detailed information, see https://insight.hyas.com/static/details?ipv4=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                  }
                },
                "Checking_If_the_Response_Returned_Data": {
                  "actions": {
                    "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "Comment",
                        "value": "@body('Create_HTML_table')"
                      }
                    },
                    "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                      "actions": {
                        "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Comment",
                            "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                          }
                        }
                      },
                      "runAfter": {
                        "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Create_HTML_table'))",
                              3000
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "Looping_Through_Response_Object": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Json Output')"
                      }
                    },
                    "Looping_Through_Response_Object": {
                      "foreach": "@body('Retrieve_Passive_Hash_information_for_IP_address')",
                      "actions": {
                        "Creating_JSON_Output_Variable_Object": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "Json Output",
                            "value": {
                              "Domain": "@items('Looping_Through_Response_Object')?['domain']",
                              "MD5 Count": "@items('Looping_Through_Response_Object')?['md5_count']"
                            }
                          }
                        }
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Setting_Response_Length_Variable": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "No_Records_Found": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Comment",
                          "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@variables('RecordsLength')",
                          0
                        ]
                      }
                    ]
                  },
                  "type": "If"
                },
                "Retrieve_Passive_Hash_information_for_IP_address": {
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "applied_filters": {
                        "ipv4": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                      }
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/passivehash"
                  }
                },
                "Setting_Response_Length_Variable": {
                  "runAfter": {
                    "Retrieve_Passive_Hash_information_for_IP_address": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "RecordsLength",
                    "value": "@length(body('Retrieve_Passive_Hash_information_for_IP_address'))"
                  }
                }
              },
              "runAfter": {
                "Sentinel_Incident_Comment_Variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Response_Length_Variable": {
              "runAfter": {
                "JSON_Output_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "RecordsLength",
                    "type": "integer",
                    "value": 0
                  }
                ]
              }
            },
            "Sentinel_Incident_Comment_Variable": {
              "runAfter": {
                "Response_Length_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Comment",
                    "type": "string"
                  }
                ]
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook8-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook8-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "hyasinsight": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook8-HYASInsightApiKey'))]",
                "connectionName": "[variables('playbook8-HYASInsightApiKey')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook9-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook9-HYASInsightApiKey')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[parameters('playbook9-UserName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook9-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook9-HYASInsightApiKey'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook9-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "Entities_-_Get_IPs": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              }
            },
            "JSON_Output_Variable": {
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Json Output",
                    "type": "array"
                  }
                ]
              }
            },
            "Looping_Through_Sentinel_IPs": {
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "actions": {
                "Add_comment_to_incident_(V2)_2": {
                  "runAfter": {
                    "Checking_If_the_Response_Returned_Data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "Value": "HYAS Insight SSL certificate enrichment data for the IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :  @{replace(variables('Comment'), '&quot;', '')}  For detailed information, see https://insight.hyas.com/static/details?ip=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                  }
                },
                "Checking_If_the_Response_Returned_Data": {
                  "actions": {
                    "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "Comment",
                        "value": "@body('Create_HTML_table')"
                      }
                    },
                    "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                      "actions": {
                        "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Comment",
                            "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                          }
                        }
                      },
                      "runAfter": {
                        "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Create_HTML_table'))",
                              3000
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "Looping_Through_Response_Object": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Json Output')"
                      }
                    },
                    "Looping_Through_Response_Object": {
                      "foreach": "@body('Retrieve_SSL_certificate_information_for_IP_address')?['ssl_certs']",
                      "actions": {
                        "Creating_JSON_Output_Variable_Object": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "Json Output",
                            "value": {
                              "Expire Date": "@items('Looping_Through_Response_Object')?['ssl_cert']?['expire_date']",
                              "Issue Date": "@items('Looping_Through_Response_Object')?['ssl_cert']?['issue_date']",
                              "Issuer": "@items('Looping_Through_Response_Object')?['ssl_cert']?['issuer_commonName']",
                              "SHA1": "@items('Looping_Through_Response_Object')?['ssl_cert']?['sha1']",
                              "Subject": "@items('Looping_Through_Response_Object')?['ssl_cert']?['subject_commonName']",
                              "Subject Org": "@items('Looping_Through_Response_Object')?['ssl_cert']?['subject_organizationName']"
                            }
                          }
                        }
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Setting_Response_Length_Variable": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "No_Records_Found": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Comment",
                          "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@variables('RecordsLength')",
                          0
                        ]
                      }
                    ]
                  },
                  "type": "If"
                },
                "Retrieve_SSL_certificate_information_for_IP_address": {
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "applied_filters": {
                        "ip": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                      }
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/ssl_certificate"
                  }
                },
                "Setting_Response_Length_Variable": {
                  "runAfter": {
                    "Retrieve_SSL_certificate_information_for_IP_address": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "RecordsLength",
                    "value": "@length(body('Retrieve_SSL_certificate_information_for_IP_address')?['ssl_certs'])"
                  }
                }
              },
              "runAfter": {
                "Sentinel_Incident_Comment_Variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Response_Length_Variable": {
              "runAfter": {
                "JSON_Output_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "RecordsLength",
                    "type": "integer",
                    "value": 0
                  }
                ]
              }
            },
            "Sentinel_Incident_Comment_Variable": {
              "runAfter": {
                "Response_Length_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Comment",
                    "type": "string"
                  }
                ]
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook9-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook9-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "hyasinsight": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook9-HYASInsightApiKey'))]",
                "connectionName": "[variables('playbook9-HYASInsightApiKey')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook10-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook10-HYASInsightApiKey')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[parameters('playbook10-UserName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook10-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook10-HYASInsightApiKey'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook10-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "Entities_-_Get_IPs": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              }
            },
            "JSON_Output_Variable": {
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Json Output",
                    "type": "array"
                  }
                ]
              }
            },
            "Looping_Through_Sentinel_IPs": {
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "actions": {
                "Add_comment_to_incident_(V2)_2": {
                  "runAfter": {
                    "Checking_If_the_Response_Returned_Data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "Value": "HYAS Insight Sinkhole enrichment data for the IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :  @{replace(variables('Comment'), '&quot;', '')}  For detailed information, see https://insight.hyas.com/static/details?ipv4=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                  }
                },
                "Checking_If_the_Response_Returned_Data": {
                  "actions": {
                    "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "Comment",
                        "value": "@body('Create_HTML_table')"
                      }
                    },
                    "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                      "actions": {
                        "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Comment",
                            "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                          }
                        }
                      },
                      "runAfter": {
                        "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Create_HTML_table'))",
                              3000
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "Looping_Through_Response_Object": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Json Output')"
                      }
                    },
                    "Looping_Through_Response_Object": {
                      "foreach": "@body('Retrieve_Sinkhole_information_for_IP_address')",
                      "actions": {
                        "Creating_JSON_Output_Variable_Object": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "Json Output",
                            "value": {
                              "Count": "@items('Looping_Through_Response_Object')?['count']",
                              "Country": "@items('Looping_Through_Response_Object')?['country_name']",
                              "First Seen": "@items('Looping_Through_Response_Object')?['datetime']",
                              "Last Seen": "@items('Looping_Through_Response_Object')?['last_seen']",
                              "Org": "@items('Looping_Through_Response_Object')?['organization_name']"
                            }
                          }
                        }
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Setting_Response_Length_Variable": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "No_Records_Found": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Comment",
                          "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@variables('RecordsLength')",
                          0
                        ]
                      }
                    ]
                  },
                  "type": "If"
                },
                "Retrieve_Sinkhole_information_for_IP_address": {
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "applied_filters": {
                        "ipv4": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                      }
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/sinkhole"
                  }
                },
                "Setting_Response_Length_Variable": {
                  "runAfter": {
                    "Retrieve_Sinkhole_information_for_IP_address": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "RecordsLength",
                    "value": "@length(body('Retrieve_Sinkhole_information_for_IP_address'))"
                  }
                }
              },
              "runAfter": {
                "Sentinel_Incident_Comment_Variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Response_Length_Variable": {
              "runAfter": {
                "JSON_Output_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "RecordsLength",
                    "type": "integer",
                    "value": 0
                  }
                ]
              }
            },
            "Sentinel_Incident_Comment_Variable": {
              "runAfter": {
                "Response_Length_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Comment",
                    "type": "string"
                  }
                ]
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook10-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook10-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "hyasinsight": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook10-HYASInsightApiKey'))]",
                "connectionName": "[variables('playbook10-HYASInsightApiKey')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook11-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook11-HYASInsightApiKey')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[parameters('playbook11-UserName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook11-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook11-HYASInsightApiKey'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook11-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "Entities_-_Get_IPs": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              }
            },
            "JSON_Output_Variable": {
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Json Output",
                    "type": "array"
                  }
                ]
              }
            },
            "Looping_Through_Sentinel_IPs": {
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "actions": {
                "Add_comment_to_incident_(V2)_2": {
                  "runAfter": {
                    "Checking_If_the_Response_Returned_Data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "Value": "HYAS Insight Device Geo enrichment data for the IPv4 \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :  @{replace(variables('Comment'), '&quot;', '')}  For detailed information, see https://insight.hyas.com/static/details?ipv4=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                  }
                },
                "Checking_If_the_Response_Returned_Data": {
                  "actions": {
                    "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "Comment",
                        "value": "@body('Create_HTML_table')"
                      }
                    },
                    "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                      "actions": {
                        "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Comment",
                            "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                          }
                        }
                      },
                      "runAfter": {
                        "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Create_HTML_table'))",
                              3000
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "Looping_Through_Response_Object": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Json Output')"
                      }
                    },
                    "Looping_Through_Response_Object": {
                      "foreach": "@body('Retrieve_Device_Geo_information_for_IPv4_address')",
                      "actions": {
                        "Creating_JSON_Output_Variable_Object": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "Json Output",
                            "value": {
                              "BSSID": "@items('Looping_Through_Response_Object')?['wifi_bssid']",
                              "Timestamp": "@items('Looping_Through_Response_Object')?['datetime']"
                            }
                          }
                        }
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Setting_Response_Length_Variable": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "No_Records_Found": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Comment",
                          "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@variables('RecordsLength')",
                          0
                        ]
                      }
                    ]
                  },
                  "type": "If"
                },
                "Retrieve_Device_Geo_information_for_IPv4_address": {
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "applied_filters": {
                        "ipv4": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                      }
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/device_geo"
                  }
                },
                "Setting_Response_Length_Variable": {
                  "runAfter": {
                    "Retrieve_Device_Geo_information_for_IPv4_address": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "RecordsLength",
                    "value": "@length(body('Retrieve_Device_Geo_information_for_IPv4_address'))"
                  }
                }
              },
              "runAfter": {
                "Sentinel_Incident_Comment_Variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Response_Length_Variable": {
              "runAfter": {
                "JSON_Output_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "RecordsLength",
                    "type": "integer",
                    "value": 0
                  }
                ]
              }
            },
            "Sentinel_Incident_Comment_Variable": {
              "runAfter": {
                "Response_Length_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Comment",
                    "type": "string"
                  }
                ]
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook11-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook11-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "hyasinsight": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook11-HYASInsightApiKey'))]",
                "connectionName": "[variables('playbook11-HYASInsightApiKey')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook12-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook12-HYASInsightApiKey')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[parameters('playbook12-UserName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook12-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook12-HYASInsightApiKey'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook12-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "Entities_-_Get_IPs": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              }
            },
            "JSON_Output_Variable": {
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Json Output",
                    "type": "array"
                  }
                ]
              }
            },
            "Looping_Through_Sentinel_IPs": {
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "actions": {
                "Add_comment_to_incident_(V2)_2": {
                  "runAfter": {
                    "Checking_If_the_Response_Returned_Data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "Value": "HYAS Insight Device Geo enrichment data for the IPv6 \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\" :  @{replace(variables('Comment'), '&quot;', '')}  For detailed information, see https://insight.hyas.com/static/details?ipv6=@{items('Looping_Through_Sentinel_IPs')?['Address']}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                  }
                },
                "Checking_If_the_Response_Returned_Data": {
                  "actions": {
                    "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "Comment",
                        "value": "@body('Create_HTML_table')"
                      }
                    },
                    "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                      "actions": {
                        "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Comment",
                            "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                          }
                        }
                      },
                      "runAfter": {
                        "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Create_HTML_table'))",
                              3000
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "Looping_Through_Response_Object": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Json Output')"
                      }
                    },
                    "Looping_Through_Response_Object": {
                      "foreach": "@body('Retrieve_Device_Geo_information_for_IPv6_address')",
                      "actions": {
                        "Creating_JSON_Output_Variable_Object": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "Json Output",
                            "value": {
                              "BSSID": "@items('Looping_Through_Response_Object')?['wifi_bssid']",
                              "Timestamp": "@items('Looping_Through_Response_Object')?['datetime']"
                            }
                          }
                        }
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Setting_Response_Length_Variable": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "No_Records_Found": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Comment",
                          "value": "No records found in HYAS Insight for IP \"@{items('Looping_Through_Sentinel_IPs')?['Address']}\"."
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@variables('RecordsLength')",
                          0
                        ]
                      }
                    ]
                  },
                  "type": "If"
                },
                "Retrieve_Device_Geo_information_for_IPv6_address": {
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "applied_filters": {
                        "ipv6": "@items('Looping_Through_Sentinel_IPs')?['Address']"
                      }
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/device_geo/ipv6"
                  }
                },
                "Setting_Response_Length_Variable": {
                  "runAfter": {
                    "Retrieve_Device_Geo_information_for_IPv6_address": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "RecordsLength",
                    "value": "@length(body('Retrieve_Device_Geo_information_for_IPv6_address'))"
                  }
                }
              },
              "runAfter": {
                "Sentinel_Incident_Comment_Variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Response_Length_Variable": {
              "runAfter": {
                "JSON_Output_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "RecordsLength",
                    "type": "integer",
                    "value": 0
                  }
                ]
              }
            },
            "Sentinel_Incident_Comment_Variable": {
              "runAfter": {
                "Response_Length_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Comment",
                    "type": "string"
                  }
                ]
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook12-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook12-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "hyasinsight": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook12-HYASInsightApiKey'))]",
                "connectionName": "[variables('playbook12-HYASInsightApiKey')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook13-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook13-HYASInsightApiKey')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[parameters('playbook13-UserName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook13-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook13-HYASInsightApiKey'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook13-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "type": "ApiConnectionWebhook",
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              }
            }
          },
          "actions": {
            "Entities_-_Get_Accounts": {
              "type": "ApiConnection",
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/account"
              }
            },
            "JSON_Output_Variable": {
              "runAfter": {
                "Entities_-_Get_Accounts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Json Output",
                    "type": "array"
                  }
                ]
              }
            },
            "Looping_Through_Sentinel_Accounts": {
              "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
              "actions": {
                "Add_comment_to_incident_(V2)_2": {
                  "runAfter": {
                    "Checking_If_the_Response_Returned_Data": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "Value": "HYAS Insight Historic WHOIS enrichment data for the phone number \"@{items('Looping_Through_Sentinel_Accounts')?['Name']}\" :  @{replace(variables('Comment'), '&quot;', '')}  For detailed information, see https://insight.hyas.com/static/details?phone=@{items('Looping_Through_Sentinel_Accounts')?['Name']}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/Comment/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/@{encodeURIComponent('Alert')}/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
                  }
                },
                "Checking_If_the_Response_Returned_Data": {
                  "actions": {
                    "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": {
                      "runAfter": {
                        "Create_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable",
                      "inputs": {
                        "name": "Comment",
                        "value": "@body('Create_HTML_table')"
                      }
                    },
                    "Checking_If_The_Length_Of_The_Data_Is_More_Than_Max_Comment_Length": {
                      "actions": {
                        "Truncating_the_Table_to_Match_the_Required_Length_for_the_Incident_Comment": {
                          "type": "SetVariable",
                          "inputs": {
                            "name": "Comment",
                            "value": "@{concat(substring(body('Create_HTML_table'), 0, 2800), '...')}"
                          }
                        }
                      },
                      "runAfter": {
                        "Assigning_Table_Formatted_Output_to_Incident_Comment_Variable": [
                          "Succeeded"
                        ]
                      },
                      "expression": {
                        "and": [
                          {
                            "greater": [
                              "@length(body('Create_HTML_table'))",
                              3000
                            ]
                          }
                        ]
                      },
                      "type": "If"
                    },
                    "Create_HTML_table": {
                      "runAfter": {
                        "Looping_Through_Response_Object": [
                          "Succeeded"
                        ]
                      },
                      "type": "Table",
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('Json Output')"
                      }
                    },
                    "Looping_Through_Response_Object": {
                      "foreach": "@body('Retrieve_Historic_WHOIS_information_for_phone_number')",
                      "actions": {
                        "Creating_JSON_Output_Variable_Object": {
                          "type": "AppendToArrayVariable",
                          "inputs": {
                            "name": "Json Output",
                            "value": {
                              "Domain": "@items('Looping_Through_Response_Object')?['domain']",
                              "Email": "@items('Looping_Through_Response_Object')?['email']",
                              "Registrant": "@items('Looping_Through_Response_Object')?['name']",
                              "Registrar": "@items('Looping_Through_Response_Object')?['registrar']"
                            }
                          }
                        }
                      },
                      "type": "Foreach"
                    }
                  },
                  "runAfter": {
                    "Setting_Response_Length_Variable": [
                      "Succeeded"
                    ]
                  },
                  "else": {
                    "actions": {
                      "No_Records_Found": {
                        "type": "SetVariable",
                        "inputs": {
                          "name": "Comment",
                          "value": "No records found in HYAS Insight for phone number \"@{items('Looping_Through_Sentinel_Accounts')?['Name']}\"."
                        }
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@variables('RecordsLength')",
                          0
                        ]
                      }
                    ]
                  },
                  "type": "If"
                },
                "Retrieve_Historic_WHOIS_information_for_phone_number": {
                  "type": "ApiConnection",
                  "inputs": {
                    "body": {
                      "applied_filters": {
                        "phone": "@items('Looping_Through_Sentinel_Accounts')?['Name']"
                      }
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['hyasinsight']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/whois/phone"
                  }
                },
                "Setting_Response_Length_Variable": {
                  "runAfter": {
                    "Retrieve_Historic_WHOIS_information_for_phone_number": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable",
                  "inputs": {
                    "name": "RecordsLength",
                    "value": "@length(body('Retrieve_Historic_WHOIS_information_for_phone_number'))"
                  }
                }
              },
              "runAfter": {
                "Sentinel_Incident_Comment_Variable": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Response_Length_Variable": {
              "runAfter": {
                "JSON_Output_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "RecordsLength",
                    "type": "integer",
                    "value": 0
                  }
                ]
              }
            },
            "Sentinel_Incident_Comment_Variable": {
              "runAfter": {
                "Response_Length_Variable": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable",
              "inputs": {
                "variables": [
                  {
                    "name": "Comment",
                    "type": "string"
                  }
                ]
              }
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook13-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook13-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "hyasinsight": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook13-HYASInsightApiKey'))]",
                "connectionName": "[variables('playbook13-HYASInsightApiKey')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/hyasinsight')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "version": "1.1.0",
        "kind": "Solution",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "HYAS",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Nikhil Tripathi",
          "email": "v-ntripathi@microsoft.com"
        },
        "support": {
          "name": "HYAS",
          "tier": "Partner",
          "link": "https://www.hyas.com/contact"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Domain-Current-WHOIS')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Domain-Historic-WHOIS')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Domain-Passive-DNS')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Email-Dynamic-DNS')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Email-Historic-WHOIS')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IP-Dynamic-DNS')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-DNS')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IP-Passive-Hash')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IP-SSL-Certificate')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IP-Sinkhole')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IPv4-Device-Geo')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-IPv6-Device-Geo')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_Enrich-Sentinel-Incident-HYAS-Insight-Phone-Number-Historic-WHOIS')]",
              "version": "1.1.0"
            }
          ]
        },
        "firstPublishDate": "2021-10-20",
        "providers": [
          "HYAS"
        ],
        "categories": {
          "domains": [
            "Security - Threat Intelligence",
            "Security – Automation (SOAR)"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
