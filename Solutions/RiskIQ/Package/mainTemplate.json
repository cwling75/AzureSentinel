{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Nikhil Tripathi - v-ntripathi@microsoft.com",
    "comments": "Solution template for RiskIQ"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[parameters('location')]",
      "metadata": {
        "description": "Region to deploy solution resources"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "playbook1-PlaybookName": {
      "defaultValue": "RiskIQ-Base",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook1-RiskiqEmail": {
      "defaultValue": "<your-email-here@example.com>",
      "type": "string",
      "minLength": 1
    },
    "playbook1-RiskiqApiKey": {
      "defaultValue": "<your-api-key-here>",
      "type": "string",
      "minLength": 1
    },
    "playbook2-PlaybookName": {
      "defaultValue": "RiskIQ-Automated-Triage-Alert-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook3-PlaybookName": {
      "defaultValue": "RiskIQ-Automated-Triage-Incident-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook4-PlaybookName": {
      "defaultValue": "RiskIQ-Data-PassiveDns-Domain",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook5-PlaybookName": {
      "defaultValue": "RiskIQ-Data-PassiveDns-Ip",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook6-PlaybookName": {
      "defaultValue": "RiskIQ-Data-PassiveDns",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook7-PlaybookName": {
      "defaultValue": "RiskIQ-Data-Summary-Domain-Alert-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook8-PlaybookName": {
      "defaultValue": "RiskIQ-Data-Summary-Domain-Incident-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook9-PlaybookName": {
      "defaultValue": "RiskIQ-Data-Summary-Ip-Alert-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook10-PlaybookName": {
      "defaultValue": "RiskIQ-Data-Summary-Ip-Incident-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook11-PlaybookName": {
      "defaultValue": "RiskIQ-Data-Summary-Alert-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook12-PlaybookName": {
      "defaultValue": "RiskIQ-Data-Summary-Incident-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook13-PlaybookName": {
      "defaultValue": "RiskIQ-Data-Whois-Domain",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook14-PlaybookName": {
      "defaultValue": "RiskIQ-Data-Whois-Ip",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook15-PlaybookName": {
      "defaultValue": "RiskIQ-Data-Whois",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook16-PlaybookName": {
      "defaultValue": "RiskIQ-Intel-Reputation-Domain-Alert-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook17-PlaybookName": {
      "defaultValue": "RiskIQ-Intel-Reputation-Domain-Incident-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook18-PlaybookName": {
      "defaultValue": "RiskIQ-Intel-Reputation-Ip-Alert-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook19-PlaybookName": {
      "defaultValue": "RiskIQ-Intel-Reputation-Ip-Incident-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook20-PlaybookName": {
      "defaultValue": "RiskIQ-Intel-Reputation-Alert-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook21-PlaybookName": {
      "defaultValue": "RiskIQ-Intel-Reputation-Incident-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook22-PlaybookName": {
      "defaultValue": "RiskIQ-Intel-Summary-Domain-Alert-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook23-PlaybookName": {
      "defaultValue": "RiskIQ-Intel-Summary-Domain-Incident-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook24-PlaybookName": {
      "defaultValue": "RiskIQ-Intel-Summary-Ip-Alert-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook25-PlaybookName": {
      "defaultValue": "RiskIQ-Intel-Summary-Ip-Incident-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook26-PlaybookName": {
      "defaultValue": "RiskIQ-Intel-Summary-Alert-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook27-PlaybookName": {
      "defaultValue": "RiskIQ-Intel-Summary-Incident-Trigger",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    }
  },
  "variables": {
    "RiskIQ-Baseazuredeploy1": "RiskIQ-Baseazuredeploy1",
    "_RiskIQ-Baseazuredeploy1": "[variables('RiskIQ-Baseazuredeploy1')]",
    "playbook1-RiskIQConnectionName": "riskiq-shared",
    "playbook-1-connection-1": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]",
    "_playbook-1-connection-1": "[variables('playbook-1-connection-1')]",
    "alert-triggerazuredeploy2": "alert-triggerazuredeploy2",
    "_alert-triggerazuredeploy2": "[variables('alert-triggerazuredeploy2')]",
    "playbook2-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook2-PlaybookName'))]",
    "playbook-2-connection-2": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]",
    "_playbook-2-connection-2": "[variables('playbook-2-connection-2')]",
    "incident-triggerazuredeploy3": "incident-triggerazuredeploy3",
    "_incident-triggerazuredeploy3": "[variables('incident-triggerazuredeploy3')]",
    "playbook3-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook3-PlaybookName'))]",
    "RiskIQ-Data-PassiveDns-Domainazuredeploy4": "RiskIQ-Data-PassiveDns-Domainazuredeploy4",
    "_RiskIQ-Data-PassiveDns-Domainazuredeploy4": "[variables('RiskIQ-Data-PassiveDns-Domainazuredeploy4')]",
    "playbook4-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook4-PlaybookName'))]",
    "RiskIQ-Data-PassiveDns-Ipazuredeploy5": "RiskIQ-Data-PassiveDns-Ipazuredeploy5",
    "_RiskIQ-Data-PassiveDns-Ipazuredeploy5": "[variables('RiskIQ-Data-PassiveDns-Ipazuredeploy5')]",
    "playbook5-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook5-PlaybookName'))]",
    "RiskIQ-Data-PassiveDnsazuredeploy6": "RiskIQ-Data-PassiveDnsazuredeploy6",
    "_RiskIQ-Data-PassiveDnsazuredeploy6": "[variables('RiskIQ-Data-PassiveDnsazuredeploy6')]",
    "playbook6-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook6-PlaybookName'))]",
    "alert-triggerazuredeploy7": "alert-triggerazuredeploy7",
    "_alert-triggerazuredeploy7": "[variables('alert-triggerazuredeploy7')]",
    "playbook7-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook7-PlaybookName'))]",
    "incident-triggerazuredeploy8": "incident-triggerazuredeploy8",
    "_incident-triggerazuredeploy8": "[variables('incident-triggerazuredeploy8')]",
    "playbook8-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook8-PlaybookName'))]",
    "alert-triggerazuredeploy9": "alert-triggerazuredeploy9",
    "_alert-triggerazuredeploy9": "[variables('alert-triggerazuredeploy9')]",
    "playbook9-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook9-PlaybookName'))]",
    "incident-triggerazuredeploy10": "incident-triggerazuredeploy10",
    "_incident-triggerazuredeploy10": "[variables('incident-triggerazuredeploy10')]",
    "playbook10-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook10-PlaybookName'))]",
    "alert-triggerazuredeploy11": "alert-triggerazuredeploy11",
    "_alert-triggerazuredeploy11": "[variables('alert-triggerazuredeploy11')]",
    "playbook11-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook11-PlaybookName'))]",
    "incident-triggerazuredeploy12": "incident-triggerazuredeploy12",
    "_incident-triggerazuredeploy12": "[variables('incident-triggerazuredeploy12')]",
    "playbook12-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook12-PlaybookName'))]",
    "RiskIQ-Data-Whois-Domainazuredeploy13": "RiskIQ-Data-Whois-Domainazuredeploy13",
    "_RiskIQ-Data-Whois-Domainazuredeploy13": "[variables('RiskIQ-Data-Whois-Domainazuredeploy13')]",
    "playbook13-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook13-PlaybookName'))]",
    "RiskIQ-Data-Whois-IPazuredeploy14": "RiskIQ-Data-Whois-IPazuredeploy14",
    "_RiskIQ-Data-Whois-IPazuredeploy14": "[variables('RiskIQ-Data-Whois-IPazuredeploy14')]",
    "playbook14-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook14-PlaybookName'))]",
    "RiskIQ-Data-Whoisazuredeploy15": "RiskIQ-Data-Whoisazuredeploy15",
    "_RiskIQ-Data-Whoisazuredeploy15": "[variables('RiskIQ-Data-Whoisazuredeploy15')]",
    "playbook15-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook15-PlaybookName'))]",
    "alert-triggerazuredeploy16": "alert-triggerazuredeploy16",
    "_alert-triggerazuredeploy16": "[variables('alert-triggerazuredeploy16')]",
    "playbook16-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook16-PlaybookName'))]",
    "incident-triggerazuredeploy17": "incident-triggerazuredeploy17",
    "_incident-triggerazuredeploy17": "[variables('incident-triggerazuredeploy17')]",
    "playbook17-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook17-PlaybookName'))]",
    "alert-triggerazuredeploy18": "alert-triggerazuredeploy18",
    "_alert-triggerazuredeploy18": "[variables('alert-triggerazuredeploy18')]",
    "playbook18-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook18-PlaybookName'))]",
    "incident-triggerazuredeploy19": "incident-triggerazuredeploy19",
    "_incident-triggerazuredeploy19": "[variables('incident-triggerazuredeploy19')]",
    "playbook19-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook19-PlaybookName'))]",
    "alert-triggerazuredeploy20": "alert-triggerazuredeploy20",
    "_alert-triggerazuredeploy20": "[variables('alert-triggerazuredeploy20')]",
    "playbook20-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook20-PlaybookName'))]",
    "incident-triggerazuredeploy21": "incident-triggerazuredeploy21",
    "_incident-triggerazuredeploy21": "[variables('incident-triggerazuredeploy21')]",
    "playbook21-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook21-PlaybookName'))]",
    "alert-triggerazuredeploy22": "alert-triggerazuredeploy22",
    "_alert-triggerazuredeploy22": "[variables('alert-triggerazuredeploy22')]",
    "playbook22-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook22-PlaybookName'))]",
    "incident-triggerazuredeploy23": "incident-triggerazuredeploy23",
    "_incident-triggerazuredeploy23": "[variables('incident-triggerazuredeploy23')]",
    "playbook23-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook23-PlaybookName'))]",
    "alert-triggerazuredeploy24": "alert-triggerazuredeploy24",
    "_alert-triggerazuredeploy24": "[variables('alert-triggerazuredeploy24')]",
    "playbook24-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook24-PlaybookName'))]",
    "incident-triggerazuredeploy25": "incident-triggerazuredeploy25",
    "_incident-triggerazuredeploy25": "[variables('incident-triggerazuredeploy25')]",
    "playbook25-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook25-PlaybookName'))]",
    "alert-triggerazuredeploy26": "alert-triggerazuredeploy26",
    "_alert-triggerazuredeploy26": "[variables('alert-triggerazuredeploy26')]",
    "playbook26-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook26-PlaybookName'))]",
    "incident-triggerazuredeploy27": "incident-triggerazuredeploy27",
    "_incident-triggerazuredeploy27": "[variables('incident-triggerazuredeploy27')]",
    "playbook27-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook27-PlaybookName'))]",
    "sourceId": "riskiq1592493552392.riskiq-sentinel-playbooks",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook1-RiskIQConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "RiskIQ-Shared",
        "parameterValues": {
          "username": "[parameters('playbook1-RiskiqEmail')]",
          "password": "[parameters('playbook1-RiskiqApiKey')]"
        },
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook1-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Get_account_metadata_and_settings": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/account"
              },
              "type": "ApiConnection"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "manual": {
              "kind": "Http",
              "type": "Request"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook2-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook2-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook2-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "runAfter": {
                "Init_Classification_Bit": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "runAfter": {
                "Init_Classification_Bit": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>RiskIQ Reputation: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br> Classification: @{body('Get_reputation_for_host')?['classification']} (@{body('Get_reputation_for_host')?['score']})<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Append_host_classification": {
                  "inputs": {
                    "name": "classification_bit",
                    "value": "@body('Get_reputation_for_host')?['classification']"
                  },
                  "runAfter": {
                    "Set_host_variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "AppendToArrayVariable"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "Append_host_classification": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Get_reputation_for_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/reputation",
                    "queries": {
                      "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                    }
                  },
                  "type": "ApiConnection"
                },
                "Set_host_variable": {
                  "inputs": {
                    "name": "result_output_host",
                    "value": "@body('Get_reputation_for_host')?['rules']"
                  },
                  "runAfter": {
                    "Get_reputation_for_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>RiskIQ Reputation: @{items('For_each_IP_Address')?['Address']}<br> Classification: @{body('Get_reputation')?['classification']} (@{body('Get_reputation')?['score']})<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Append_ip_classification": {
                  "inputs": {
                    "name": "classification_bit",
                    "value": "@body('Get_reputation')?['classification']"
                  },
                  "runAfter": {
                    "Set_ip_variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "AppendToArrayVariable"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "Append_ip_classification": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Get_reputation": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/reputation",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                },
                "Set_ip_variable": {
                  "inputs": {
                    "name": "result_output_ip",
                    "value": "@body('Get_reputation')?['rules']"
                  },
                  "runAfter": {
                    "Get_reputation": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Classification_Bit": {
              "inputs": {
                "variables": [
                  {
                    "name": "classification_bit",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Malicious_or_Suspicious": {
              "actions": {
                "Condition_2": {
                  "actions": {
                    "Update_incident": {
                      "inputs": {
                        "body": {
                          "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                          "owner": "@body('Alert_-_Get_incident')?['properties']?['owner']?['objectId']",
                          "ownerAction": "Unassign",
                          "severity": "High",
                          "status": "Active",
                          "tagsToAdd": {
                            "TagsToAdd": [
                              {
                                "Tag": "RiskIQ Malicious"
                              }
                            ]
                          }
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "put",
                        "path": "/Incidents"
                      },
                      "type": "ApiConnection"
                    }
                  },
                  "else": {
                    "actions": {
                      "Update_incident_2": {
                        "inputs": {
                          "body": {
                            "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                            "owner": "@body('Alert_-_Get_incident')?['properties']?['owner']?['objectId']",
                            "ownerAction": "Unassign",
                            "severity": "Medium",
                            "status": "Active",
                            "tagsToAdd": {
                              "TagsToAdd": [
                                {
                                  "Tag": "RiskIQ Suspicious"
                                }
                              ]
                            }
                          },
                          "host": {
                            "connection": {
                              "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                            }
                          },
                          "method": "put",
                          "path": "/Incidents"
                        },
                        "type": "ApiConnection"
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "contains": [
                          "@variables('classification_bit')",
                          "MALICIOUS"
                        ]
                      }
                    ]
                  },
                  "type": "If"
                }
              },
              "expression": {
                "or": [
                  {
                    "contains": [
                      "@variables('classification_bit')",
                      "MALICIOUS"
                    ]
                  },
                  {
                    "contains": [
                      "@variables('classification_bit')",
                      "SUSPICIOUS"
                    ]
                  }
                ]
              },
              "runAfter": {
                "For_each_Host": [
                  "Succeeded"
                ],
                "For_each_IP_Address": [
                  "Succeeded"
                ]
              },
              "type": "If"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook2-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook2-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook3-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook3-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook3-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "runAfter": {
                "Init_Classification_Bit": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "runAfter": {
                "Init_Classification_Bit": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>RiskIQ Reputation: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br> Classification: @{body('Get_reputation_for_host')?['classification']} (@{body('Get_reputation_for_host')?['score']})<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Append_host_classification": {
                  "inputs": {
                    "name": "classification_bit",
                    "value": "@body('Get_reputation_for_host')?['classification']"
                  },
                  "runAfter": {
                    "Set_host_variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "AppendToArrayVariable"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "Append_host_classification": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Get_reputation_for_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/reputation",
                    "queries": {
                      "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                    }
                  },
                  "type": "ApiConnection"
                },
                "Set_host_variable": {
                  "inputs": {
                    "name": "result_output_host",
                    "value": "@body('Get_reputation_for_host')?['rules']"
                  },
                  "runAfter": {
                    "Get_reputation_for_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>RiskIQ Reputation: @{items('For_each_IP_Address')?['Address']}<br> Classification: @{body('Get_reputation')?['classification']} (@{body('Get_reputation')?['score']})<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Append_ip_classification": {
                  "inputs": {
                    "name": "classification_bit",
                    "value": "@body('Get_reputation')?['classification']"
                  },
                  "runAfter": {
                    "Set_ip_variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "AppendToArrayVariable"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "Append_ip_classification": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Get_reputation": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/reputation",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                },
                "Set_ip_variable": {
                  "inputs": {
                    "name": "result_output_ip",
                    "value": "@body('Get_reputation')?['rules']"
                  },
                  "runAfter": {
                    "Get_reputation": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Classification_Bit": {
              "inputs": {
                "variables": [
                  {
                    "name": "classification_bit",
                    "type": "array"
                  }
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Malicious_or_Suspicious": {
              "actions": {
                "Condition_2": {
                  "actions": {
                    "Update_incident": {
                      "inputs": {
                        "body": {
                          "incidentArmId": "@triggerBody()?['object']?['id']",
                          "owner": "@triggerBody()?['object']?['properties']?['owner']?['objectId']",
                          "ownerAction": "Unassign",
                          "severity": "High",
                          "status": "Active",
                          "tagsToAdd": {
                            "TagsToAdd": [
                              {
                                "Tag": "RiskIQ Malicious"
                              }
                            ]
                          }
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                          }
                        },
                        "method": "put",
                        "path": "/Incidents"
                      },
                      "type": "ApiConnection"
                    }
                  },
                  "else": {
                    "actions": {
                      "Update_incident_2": {
                        "inputs": {
                          "body": {
                            "incidentArmId": "@triggerBody()?['object']?['id']",
                            "owner": "@triggerBody()?['object']?['properties']?['owner']?['objectId']",
                            "ownerAction": "Unassign",
                            "severity": "Medium",
                            "status": "Active",
                            "tagsToAdd": {
                              "TagsToAdd": [
                                {
                                  "Tag": "RiskIQ Suspicious"
                                }
                              ]
                            }
                          },
                          "host": {
                            "connection": {
                              "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                            }
                          },
                          "method": "put",
                          "path": "/Incidents"
                        },
                        "type": "ApiConnection"
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "contains": [
                          "@variables('classification_bit')",
                          "MALICIOUS"
                        ]
                      }
                    ]
                  },
                  "type": "If"
                }
              },
              "expression": {
                "or": [
                  {
                    "contains": [
                      "@variables('classification_bit')",
                      "MALICIOUS"
                    ]
                  },
                  {
                    "contains": [
                      "@variables('classification_bit')",
                      "SUSPICIOUS"
                    ]
                  }
                ]
              },
              "runAfter": {
                "For_each_Host": [
                  "Succeeded"
                ],
                "For_each_IP_Address": [
                  "Succeeded"
                ]
              },
              "type": "If"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook3-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook3-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook4-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook4-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook4-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "runAfter": {
                "Init_Lookback_Period": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_host": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Last week of Passive DNS for @{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}<br> @{variables('domain_comment')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Condition": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Condition": {
                  "actions": {
                    "Create_Host_HTML_table": {
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('domain_results')"
                      },
                      "type": "Table"
                    },
                    "Set_domain_comment": {
                      "inputs": {
                        "name": "domain_comment",
                        "value": "@body('Create_Host_HTML_table')"
                      },
                      "runAfter": {
                        "Create_Host_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable"
                    }
                  },
                  "else": {
                    "actions": {
                      "Set_domain_comment_empty": {
                        "inputs": {
                          "name": "domain_comment",
                          "value": "No results found."
                        },
                        "type": "SetVariable"
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@length(variables('domain_results'))",
                          0
                        ]
                      }
                    ]
                  },
                  "runAfter": {
                    "For_each_host_resolve": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "For_each_host_resolve": {
                  "actions": {
                    "Append_to_array_variable": {
                      "inputs": {
                        "name": "domain_results",
                        "value": {
                          "First": "@body('Get_passive_DNS')?['firstSeen']",
                          "Last": "@body('Get_passive_DNS')?['lastSeen']",
                          "Type": "@items('For_each_host_resolve')?['recordType']",
                          "Value": "@items('For_each_host_resolve')?['resolve']"
                        }
                      },
                      "type": "AppendToArrayVariable"
                    }
                  },
                  "foreach": "@body('Get_passive_DNS')?['results']",
                  "runAfter": {
                    "Get_passive_DNS": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Get_passive_DNS": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/dns/passive",
                    "queries": {
                      "query": "@{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}",
                      "start": "@variables('lookback')",
                      "timeout": 7
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_domain_comment": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Lookback_Period": {
              "inputs": {
                "variables": [
                  {
                    "name": "lookback",
                    "type": "string",
                    "value": "@{formatDateTime(addDays(utcNow(), -7), 'yyyy-MM-dd')}"
                  }
                ]
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_domain_comment": {
              "inputs": {
                "variables": [
                  {
                    "name": "domain_comment",
                    "type": "string"
                  }
                ]
              },
              "runAfter": {
                "Init_domain_results": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_domain_results": {
              "inputs": {
                "variables": [
                  {
                    "name": "domain_results",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook4-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook4-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook5-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook5-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook5-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "runAfter": {
                "Init_Lookback_Period": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_ip": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Last week of Passive DNS for @{items('For_each_ip')?['Address']}<br> @{variables('ip_comment')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Condition_2": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Condition_2": {
                  "actions": {
                    "Create_IP_HTML_table": {
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('ip_results')"
                      },
                      "type": "Table"
                    },
                    "Set_ip_comment": {
                      "inputs": {
                        "name": "ip_comment",
                        "value": "@body('Create_IP_HTML_table')"
                      },
                      "runAfter": {
                        "Create_IP_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable"
                    }
                  },
                  "else": {
                    "actions": {
                      "Set_variable": {
                        "inputs": {
                          "name": "ip_comment",
                          "value": "No results found."
                        },
                        "type": "SetVariable"
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@length(variables('ip_results'))",
                          0
                        ]
                      }
                    ]
                  },
                  "runAfter": {
                    "For_each_ip_resolve": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "For_each_ip_resolve": {
                  "actions": {
                    "Append_to_array_variable_2": {
                      "inputs": {
                        "name": "ip_results",
                        "value": {
                          "First": "@item()?['firstSeen']",
                          "Last": "@item()?['lastSeen']",
                          "Type": "@items('For_each_ip_resolve')?['recordType']",
                          "Value": "@items('For_each_ip_resolve')?['resolve']"
                        }
                      },
                      "type": "AppendToArrayVariable"
                    }
                  },
                  "foreach": "@body('Get_passive_DNS_2')?['results']",
                  "runAfter": {
                    "Get_passive_DNS_2": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Get_passive_DNS_2": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/dns/passive",
                    "queries": {
                      "query": "@items('For_each_ip')?['Address']",
                      "start": "@variables('lookback')",
                      "timeout": 7
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_ip_comment": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Lookback_Period": {
              "inputs": {
                "variables": [
                  {
                    "name": "lookback",
                    "type": "string",
                    "value": "@{formatDateTime(addDays(utcNow(), -7), 'yyyy-MM-dd')}"
                  }
                ]
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_ip_comment": {
              "inputs": {
                "variables": [
                  {
                    "name": "ip_comment",
                    "type": "string"
                  }
                ]
              },
              "runAfter": {
                "Init_ip_results": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_ip_results": {
              "inputs": {
                "variables": [
                  {
                    "name": "ip_results",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook5-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook5-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook6-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook6-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook6-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "runAfter": {
                "Init_Lookback_Period": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "runAfter": {
                "Init_Lookback_Period": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_host": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Last week of Passive DNS for @{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}<br> @{variables('domain_comment')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Condition": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Condition": {
                  "actions": {
                    "Create_Host_HTML_table": {
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('domain_results')"
                      },
                      "type": "Table"
                    },
                    "Set_domain_comment": {
                      "inputs": {
                        "name": "domain_comment",
                        "value": "@body('Create_Host_HTML_table')"
                      },
                      "runAfter": {
                        "Create_Host_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable"
                    }
                  },
                  "else": {
                    "actions": {
                      "Set_domain_comment_empty": {
                        "inputs": {
                          "name": "domain_comment",
                          "value": "No results found."
                        },
                        "type": "SetVariable"
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@length(variables('domain_results'))",
                          0
                        ]
                      }
                    ]
                  },
                  "runAfter": {
                    "For_each_host_resolve": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "For_each_host_resolve": {
                  "actions": {
                    "Append_to_array_variable": {
                      "inputs": {
                        "name": "domain_results",
                        "value": {
                          "First": "@body('Get_passive_DNS')?['firstSeen']",
                          "Last": "@body('Get_passive_DNS')?['lastSeen']",
                          "Type": "@items('For_each_host_resolve')?['recordType']",
                          "Value": "@items('For_each_host_resolve')?['resolve']"
                        }
                      },
                      "type": "AppendToArrayVariable"
                    }
                  },
                  "foreach": "@body('Get_passive_DNS')?['results']",
                  "runAfter": {
                    "Get_passive_DNS": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Get_passive_DNS": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/dns/passive",
                    "queries": {
                      "query": "@{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}",
                      "start": "@variables('lookback')",
                      "timeout": 7
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_domain_comment": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "For_each_ip": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Last week of Passive DNS for @{items('For_each_ip')?['Address']}<br> @{variables('ip_comment')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Condition_2": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Condition_2": {
                  "actions": {
                    "Create_IP_HTML_table": {
                      "inputs": {
                        "format": "HTML",
                        "from": "@variables('ip_results')"
                      },
                      "type": "Table"
                    },
                    "Set_ip_comment": {
                      "inputs": {
                        "name": "ip_comment",
                        "value": "@body('Create_IP_HTML_table')"
                      },
                      "runAfter": {
                        "Create_IP_HTML_table": [
                          "Succeeded"
                        ]
                      },
                      "type": "SetVariable"
                    }
                  },
                  "else": {
                    "actions": {
                      "Set_variable": {
                        "inputs": {
                          "name": "ip_comment",
                          "value": "No results found."
                        },
                        "type": "SetVariable"
                      }
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@length(variables('ip_results'))",
                          0
                        ]
                      }
                    ]
                  },
                  "runAfter": {
                    "For_each_ip_resolve": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "For_each_ip_resolve": {
                  "actions": {
                    "Append_to_array_variable_2": {
                      "inputs": {
                        "name": "ip_results",
                        "value": {
                          "First": "@item()?['firstSeen']",
                          "Last": "@item()?['lastSeen']",
                          "Type": "@items('For_each_ip_resolve')?['recordType']",
                          "Value": "@items('For_each_ip_resolve')?['resolve']"
                        }
                      },
                      "type": "AppendToArrayVariable"
                    }
                  },
                  "foreach": "@body('Get_passive_DNS_2')?['results']",
                  "runAfter": {
                    "Get_passive_DNS_2": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Get_passive_DNS_2": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/dns/passive",
                    "queries": {
                      "query": "@items('For_each_ip')?['Address']",
                      "start": "@variables('lookback')",
                      "timeout": 7
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_ip_comment": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Lookback_Period": {
              "inputs": {
                "variables": [
                  {
                    "name": "lookback",
                    "type": "string",
                    "value": "@{formatDateTime(addDays(utcNow(), -7), 'yyyy-MM-dd')}"
                  }
                ]
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_domain_comment": {
              "inputs": {
                "variables": [
                  {
                    "name": "domain_comment",
                    "type": "string"
                  }
                ]
              },
              "runAfter": {
                "Init_domain_results": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_domain_results": {
              "inputs": {
                "variables": [
                  {
                    "name": "domain_results",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_ip_comment": {
              "inputs": {
                "variables": [
                  {
                    "name": "ip_comment",
                    "type": "string"
                  }
                ]
              },
              "runAfter": {
                "Init_ip_results": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_ip_results": {
              "inputs": {
                "variables": [
                  {
                    "name": "ip_results",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook6-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook6-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook7-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook7-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook7-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Host Summary<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "Format_Host_Record": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Format_Host_Record": {
                  "inputs": {
                    "name": "result_output_host",
                    "value": [
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['count']",
                        "Dataset": "Resolutions",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['count']",
                        "Dataset": "Certificates",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['count']",
                        "Dataset": "Trackers",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['count']",
                        "Dataset": "Components",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['count']",
                        "Dataset": "Host Pairs",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['count']",
                        "Dataset": "Cookies",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['count']",
                        "Dataset": "Hashes",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['count']",
                        "Dataset": "Articles",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['link']"
                      }
                    ]
                  },
                  "runAfter": {
                    "Get_summary_data_card_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                },
                "Get_summary_data_card_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/cards/summary",
                    "queries": {
                      "query": "@items('For_each_Host')?['DnsDomain']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook7-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook7-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook8-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook8-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook8-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>Host Summary<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "Format_Host_Record": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Format_Host_Record": {
                  "inputs": {
                    "name": "result_output_host",
                    "value": [
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['count']",
                        "Dataset": "Resolutions",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['count']",
                        "Dataset": "Certificates",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['count']",
                        "Dataset": "Trackers",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['count']",
                        "Dataset": "Components",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['count']",
                        "Dataset": "Host Pairs",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['count']",
                        "Dataset": "Cookies",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['count']",
                        "Dataset": "Hashes",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['count']",
                        "Dataset": "Articles",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['link']"
                      }
                    ]
                  },
                  "runAfter": {
                    "Get_summary_data_card_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                },
                "Get_summary_data_card_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/cards/summary",
                    "queries": {
                      "query": "@items('For_each_Host')?['DnsDomain']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook8-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook8-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook9-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook9-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook9-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>IP Summary<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "Format_IP_Record": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Format_IP_Record": {
                  "inputs": {
                    "name": "result_output_ip",
                    "value": [
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['count']",
                        "Dataset": "Resolutions",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['count']",
                        "Dataset": "Certificates",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['count']",
                        "Dataset": "Trackers",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['count']",
                        "Dataset": "Components",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['count']",
                        "Dataset": "Host Pairs",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['count']",
                        "Dataset": "Cookies",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['count']",
                        "Dataset": "Services",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['count']",
                        "Dataset": "DNS",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['count']",
                        "Dataset": "Hashes",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['count']",
                        "Dataset": "Articles",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['link']"
                      }
                    ]
                  },
                  "runAfter": {
                    "Get_summary_data_card_ip": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                },
                "Get_summary_data_card_ip": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/cards/summary",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook9-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook9-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook10-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook10-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook10-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "type": "ApiConnection"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>IP Summary<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "Format_IP_Record": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Format_IP_Record": {
                  "inputs": {
                    "name": "result_output_ip",
                    "value": [
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['count']",
                        "Dataset": "Resolutions",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['count']",
                        "Dataset": "Certificates",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['count']",
                        "Dataset": "Trackers",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['count']",
                        "Dataset": "Components",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['count']",
                        "Dataset": "Host Pairs",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['count']",
                        "Dataset": "Cookies",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['count']",
                        "Dataset": "Services",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['count']",
                        "Dataset": "DNS",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['count']",
                        "Dataset": "Hashes",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['count']",
                        "Dataset": "Articles",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['link']"
                      }
                    ]
                  },
                  "runAfter": {
                    "Get_summary_data_card_ip": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                },
                "Get_summary_data_card_ip": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/cards/summary",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook10-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook10-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook11-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook11-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook11-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Host Summary<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "Format_Host_Record": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Format_Host_Record": {
                  "inputs": {
                    "name": "result_output_host",
                    "value": [
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['count']",
                        "Dataset": "Resolutions",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['count']",
                        "Dataset": "Certificates",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['count']",
                        "Dataset": "Trackers",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['count']",
                        "Dataset": "Components",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['count']",
                        "Dataset": "Host Pairs",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['count']",
                        "Dataset": "Cookies",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['count']",
                        "Dataset": "Hashes",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['count']",
                        "Dataset": "Articles",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['link']"
                      }
                    ]
                  },
                  "runAfter": {
                    "Get_summary_data_card_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                },
                "Get_summary_data_card_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/cards/summary",
                    "queries": {
                      "query": "@items('For_each_Host')?['DnsDomain']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>IP Summary<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "Format_IP_Record": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Format_IP_Record": {
                  "inputs": {
                    "name": "result_output_ip",
                    "value": [
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['count']",
                        "Dataset": "Resolutions",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['count']",
                        "Dataset": "Certificates",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['count']",
                        "Dataset": "Trackers",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['count']",
                        "Dataset": "Components",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['count']",
                        "Dataset": "Host Pairs",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['count']",
                        "Dataset": "Cookies",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['count']",
                        "Dataset": "Services",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['count']",
                        "Dataset": "DNS",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['count']",
                        "Dataset": "Hashes",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['count']",
                        "Dataset": "Articles",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['link']"
                      }
                    ]
                  },
                  "runAfter": {
                    "Get_summary_data_card_ip": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                },
                "Get_summary_data_card_ip": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/cards/summary",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook11-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook11-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook12-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook12-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook12-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>Host Summary<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "Format_Host_Record": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Format_Host_Record": {
                  "inputs": {
                    "name": "result_output_host",
                    "value": [
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['count']",
                        "Dataset": "Resolutions",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['resolutions']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['count']",
                        "Dataset": "Certificates",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['certificates']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['count']",
                        "Dataset": "Trackers",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['trackers']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['count']",
                        "Dataset": "Components",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['components']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['count']",
                        "Dataset": "Host Pairs",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['host_pairs']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['count']",
                        "Dataset": "Cookies",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['cookies']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['count']",
                        "Dataset": "Hashes",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['hashes']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['count']",
                        "Dataset": "Articles",
                        "Link": "@body('Get_summary_data_card_host')?['data_summary']?['articles']?['link']"
                      }
                    ]
                  },
                  "runAfter": {
                    "Get_summary_data_card_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                },
                "Get_summary_data_card_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/cards/summary",
                    "queries": {
                      "query": "@items('For_each_Host')?['DnsDomain']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>IP Summary<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "Format_IP_Record": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Format_IP_Record": {
                  "inputs": {
                    "name": "result_output_ip",
                    "value": [
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['count']",
                        "Dataset": "Resolutions",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['resolutions']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['count']",
                        "Dataset": "Certificates",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['certificates']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['count']",
                        "Dataset": "Trackers",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['trackers']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['count']",
                        "Dataset": "Components",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['components']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['count']",
                        "Dataset": "Host Pairs",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['host_pairs']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['count']",
                        "Dataset": "Cookies",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['cookies']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['count']",
                        "Dataset": "Services",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['services']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['count']",
                        "Dataset": "DNS",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['reverse_dns']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['count']",
                        "Dataset": "Hashes",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['hashes']?['link']"
                      },
                      {
                        "Count": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['count']",
                        "Dataset": "Articles",
                        "Link": "@body('Get_summary_data_card_ip')?['data_summary']?['articles']?['link']"
                      }
                    ]
                  },
                  "runAfter": {
                    "Get_summary_data_card_ip": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                },
                "Get_summary_data_card_ip": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/cards/summary",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook12-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook12-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook13-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook13-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook13-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_host": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Associated WHOIS record for @{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}:<br> <br> Registrar: @{body('Get_WHOIS')?['registrar']}<br> Registered:@{body('Get_WHOIS')?['registered']}<br> Expires: @{body('Get_WHOIS')?['expiresAt']}<br> Contact: @{body('Get_WHOIS')?['contactEmail']}<br> Nameservers: @{body('Get_WHOIS')?['nameServers']}<br> <br> To search on WHOIS data or view historic records, see https://community.riskiq.com/search/@{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}/whois</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Get_WHOIS": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Get_WHOIS": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/whois",
                    "queries": {
                      "query": "@{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook13-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook13-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook14-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook14-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook14-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_ip": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Associated WHOIS record for @{items('For_each_ip')?['Address']}:<br> <br> Registrar: @{body('Get_WHOIS_IP')?['registrar']}<br> Registered:@{body('Get_WHOIS_IP')?['registered']}<br> Expires: @{body('Get_WHOIS_IP')?['expiresAt']}<br> Contact: @{body('Get_WHOIS_IP')?['contactEmail']}<br> Nameservers: @{body('Get_WHOIS_IP')?['nameServers']}<br> <br> To search on WHOIS data or view historic records, see https://community.riskiq.com/search/@{items('For_each_ip')?['Address']}/whois</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Get_WHOIS_IP": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Get_WHOIS_IP": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/whois",
                    "queries": {
                      "query": "@items('For_each_ip')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook14-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook14-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook15-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook15-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook15-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_host": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Associated WHOIS record for @{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}:<br> <br> Registrar: @{body('Get_WHOIS')?['registrar']}<br> Registered:@{body('Get_WHOIS')?['registered']}<br> Expires: @{body('Get_WHOIS')?['expiresAt']}<br> Contact: @{body('Get_WHOIS')?['contactEmail']}<br> Nameservers: @{body('Get_WHOIS')?['nameServers']}<br> <br> To search on WHOIS data or view historic records, see https://community.riskiq.com/search/@{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}/whois</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Get_WHOIS": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Get_WHOIS": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/whois",
                    "queries": {
                      "query": "@{items('For_each_host')?['HostName']}.@{items('For_each_host')?['DnsDomain']}"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "For_each_ip": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Associated WHOIS record for @{items('For_each_ip')?['Address']}:<br> <br> Registrar: @{body('Get_WHOIS_IP')?['registrar']}<br> Registered:@{body('Get_WHOIS_IP')?['registered']}<br> Expires: @{body('Get_WHOIS_IP')?['expiresAt']}<br> Contact: @{body('Get_WHOIS_IP')?['contactEmail']}<br> Nameservers: @{body('Get_WHOIS_IP')?['nameServers']}<br> <br> To search on WHOIS data or view historic records, see https://community.riskiq.com/search/@{items('For_each_ip')?['Address']}/whois</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Get_WHOIS_IP": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Get_WHOIS_IP": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/whois",
                    "queries": {
                      "query": "@items('For_each_ip')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook15-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook15-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook16-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook16-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook16-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>RiskIQ Reputation: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br> Classification: @{body('Get_reputation_for_host')?['classification']} (@{body('Get_reputation_for_host')?['score']})<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "Set_host_variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Get_reputation_for_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/reputation",
                    "queries": {
                      "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                    }
                  },
                  "type": "ApiConnection"
                },
                "Set_host_variable": {
                  "inputs": {
                    "name": "result_output_host",
                    "value": "@body('Get_reputation_for_host')?['rules']"
                  },
                  "runAfter": {
                    "Get_reputation_for_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook16-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook16-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook17-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook17-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook17-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>RiskIQ Reputation: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br> Classification: @{body('Get_reputation_for_host')?['classification']} (@{body('Get_reputation_for_host')?['score']})<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "Set_host_variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Get_reputation_for_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/reputation",
                    "queries": {
                      "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                    }
                  },
                  "type": "ApiConnection"
                },
                "Set_host_variable": {
                  "inputs": {
                    "name": "result_output_host",
                    "value": "@body('Get_reputation_for_host')?['rules']"
                  },
                  "runAfter": {
                    "Get_reputation_for_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook17-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook17-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook18-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook18-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook18-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>RiskIQ Reputation: @{items('For_each_IP_Address')?['Address']}<br> Classification: @{body('Get_reputation')?['classification']} (@{body('Get_reputation')?['score']})<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "Set_ip_variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Get_reputation": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/reputation",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                },
                "Set_ip_variable": {
                  "inputs": {
                    "name": "result_output_ip",
                    "value": "@body('Get_reputation')?['rules']"
                  },
                  "runAfter": {
                    "Get_reputation": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook18-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook18-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook19-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook19-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook19-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "type": "ApiConnection"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>RiskIQ Reputation: @{items('For_each_IP_Address')?['Address']}<br> Classification: @{body('Get_reputation')?['classification']} (@{body('Get_reputation')?['score']})<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "Set_ip_variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Get_reputation": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/reputation",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                },
                "Set_ip_variable": {
                  "inputs": {
                    "name": "result_output_ip",
                    "value": "@body('Get_reputation')?['rules']"
                  },
                  "runAfter": {
                    "Get_reputation": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook19-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook19-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook20-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook20-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook20-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>RiskIQ Reputation: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br> Classification: @{body('Get_reputation_for_host')?['classification']} (@{body('Get_reputation_for_host')?['score']})<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "Set_host_variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Get_reputation_for_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/reputation",
                    "queries": {
                      "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                    }
                  },
                  "type": "ApiConnection"
                },
                "Set_host_variable": {
                  "inputs": {
                    "name": "result_output_host",
                    "value": "@body('Get_reputation_for_host')?['rules']"
                  },
                  "runAfter": {
                    "Get_reputation_for_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>RiskIQ Reputation: @{items('For_each_IP_Address')?['Address']}<br> Classification: @{body('Get_reputation')?['classification']} (@{body('Get_reputation')?['score']})<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "Set_ip_variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Get_reputation": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/reputation",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                },
                "Set_ip_variable": {
                  "inputs": {
                    "name": "result_output_ip",
                    "value": "@body('Get_reputation')?['rules']"
                  },
                  "runAfter": {
                    "Get_reputation": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook20-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook20-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook21-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook21-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook21-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>RiskIQ Reputation: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br> Classification: @{body('Get_reputation_for_host')?['classification']} (@{body('Get_reputation_for_host')?['score']})<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "Set_host_variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Get_reputation_for_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/reputation",
                    "queries": {
                      "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                    }
                  },
                  "type": "ApiConnection"
                },
                "Set_host_variable": {
                  "inputs": {
                    "name": "result_output_host",
                    "value": "@body('Get_reputation_for_host')?['rules']"
                  },
                  "runAfter": {
                    "Get_reputation_for_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>RiskIQ Reputation: @{items('For_each_IP_Address')?['Address']}<br> Classification: @{body('Get_reputation')?['classification']} (@{body('Get_reputation')?['score']})<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "Set_ip_variable": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "Get_reputation": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/reputation",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                },
                "Set_ip_variable": {
                  "inputs": {
                    "name": "result_output_ip",
                    "value": "@body('Get_reputation')?['rules']"
                  },
                  "runAfter": {
                    "Get_reputation": [
                      "Succeeded"
                    ]
                  },
                  "type": "SetVariable"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook21-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook21-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook22-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook22-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook22-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Threat Article Results: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "For_each_host_article": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "For_each_host_article": {
                  "actions": {
                    "Append_to_host_array": {
                      "inputs": {
                        "name": "result_output_host",
                        "value": {
                          "Link": "@item()['link']",
                          "Title": "@item()['title']"
                        }
                      },
                      "type": "AppendToArrayVariable"
                    }
                  },
                  "foreach": "@body('Get_articles_by_indicator_host')?['articles']",
                  "runAfter": {
                    "Get_articles_by_indicator_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Get_articles_by_indicator_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/articles/indicator",
                    "queries": {
                      "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook22-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook22-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook23-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook23-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook23-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>Threat Article Results: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "For_each_host_article": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "For_each_host_article": {
                  "actions": {
                    "Append_to_host_array": {
                      "inputs": {
                        "name": "result_output_host",
                        "value": {
                          "Link": "@item()['link']",
                          "Title": "@item()['title']"
                        }
                      },
                      "type": "AppendToArrayVariable"
                    }
                  },
                  "foreach": "@body('Get_articles_by_indicator_host')?['articles']",
                  "runAfter": {
                    "Get_articles_by_indicator_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Get_articles_by_indicator_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/articles/indicator",
                    "queries": {
                      "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook23-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook23-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook24-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook24-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook24-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Threat Article Results: @{items('For_each_IP_Address')?['Address']}<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "For_each_ip_article": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "For_each_ip_article": {
                  "actions": {
                    "Append_to_array_variable": {
                      "inputs": {
                        "name": "result_output_ip",
                        "value": {
                          "Link": "@item()['link']",
                          "Title": "@item()['title']"
                        }
                      },
                      "type": "AppendToArrayVariable"
                    }
                  },
                  "foreach": "@body('Get_articles_by_indicator_ip')?['articles']",
                  "runAfter": {
                    "Get_articles_by_indicator_ip": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Get_articles_by_indicator_ip": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/articles/indicator",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook24-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook24-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook25-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook25-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook25-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "type": "ApiConnection"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>Threat Article Results: @{items('For_each_IP_Address')?['Address']}<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "For_each_ip_article": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "For_each_ip_article": {
                  "actions": {
                    "Append_to_array_variable": {
                      "inputs": {
                        "name": "result_output_ip",
                        "value": {
                          "Link": "@item()['link']",
                          "Title": "@item()['title']"
                        }
                      },
                      "type": "AppendToArrayVariable"
                    }
                  },
                  "foreach": "@body('Get_articles_by_indicator_ip')?['articles']",
                  "runAfter": {
                    "Get_articles_by_indicator_ip": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Get_articles_by_indicator_ip": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/articles/indicator",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook25-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook25-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook26-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook26-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook26-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Alert_-_Get_incident": {
              "inputs": {
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/Incidents/subscriptions/@{encodeURIComponent(triggerBody()?['WorkspaceSubscriptionId'])}/resourceGroups/@{encodeURIComponent(triggerBody()?['WorkspaceResourceGroup'])}/workspaces/@{encodeURIComponent(triggerBody()?['WorkspaceId'])}/alerts/@{encodeURIComponent(triggerBody()?['SystemAlertId'])}"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['Entities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "runAfter": {
                "Alert_-_Get_incident": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Threat Article Results: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "For_each_host_article": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "For_each_host_article": {
                  "actions": {
                    "Append_to_host_array": {
                      "inputs": {
                        "name": "result_output_host",
                        "value": {
                          "Link": "@item()['link']",
                          "Title": "@item()['title']"
                        }
                      },
                      "type": "AppendToArrayVariable"
                    }
                  },
                  "foreach": "@body('Get_articles_by_indicator_host')?['articles']",
                  "runAfter": {
                    "Get_articles_by_indicator_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Get_articles_by_indicator_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/articles/indicator",
                    "queries": {
                      "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@body('Alert_-_Get_incident')?['id']",
                      "message": "<p>Threat Article Results: @{items('For_each_IP_Address')?['Address']}<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "For_each_ip_article": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "For_each_ip_article": {
                  "actions": {
                    "Append_to_array_variable": {
                      "inputs": {
                        "name": "result_output_ip",
                        "value": {
                          "Link": "@item()['link']",
                          "Title": "@item()['title']"
                        }
                      },
                      "type": "AppendToArrayVariable"
                    }
                  },
                  "foreach": "@body('Get_articles_by_indicator_ip')?['articles']",
                  "runAfter": {
                    "Get_articles_by_indicator_ip": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Get_articles_by_indicator_ip": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/articles/indicator",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_a_response_to_an_Azure_Sentinel_alert_is_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/subscribe"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook26-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook26-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2016-06-01",
      "name": "[variables('playbook27-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "api": {
          "id": "[variables('_playbook-2-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2017-07-01",
      "name": "[parameters('playbook27-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "tags": {
        "LogicAppsCategory": "security"
      },
      "dependsOn": [
	    "[resourceId('Microsoft.Logic/workflows', parameters('playbook1-PlaybookName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook27-AzureSentinelConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Entities_-_Get_Hosts": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/host"
              },
              "type": "ApiConnection"
            },
            "Entities_-_Get_IPs": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/ip"
              },
              "type": "ApiConnection"
            },
            "For_each_Host": {
              "actions": {
                "Add_comment_to_incident_(V3)_2": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>Threat Article Results: @{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}<br> @{body('Create_Host_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_Host_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_Host_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_host')"
                  },
                  "runAfter": {
                    "For_each_host_article": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "For_each_host_article": {
                  "actions": {
                    "Append_to_host_array": {
                      "inputs": {
                        "name": "result_output_host",
                        "value": {
                          "Link": "@item()['link']",
                          "Title": "@item()['title']"
                        }
                      },
                      "type": "AppendToArrayVariable"
                    }
                  },
                  "foreach": "@body('Get_articles_by_indicator_host')?['articles']",
                  "runAfter": {
                    "Get_articles_by_indicator_host": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Get_articles_by_indicator_host": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/articles/indicator",
                    "queries": {
                      "query": "@{items('For_each_Host')?['HostName']}.@{items('For_each_Host')?['DnsDomain']}"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_Hosts')?['Hosts']",
              "runAfter": {
                "Init_Result_Host": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "For_each_IP_Address": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>Threat Article Results: @{items('For_each_IP_Address')?['Address']}<br> @{body('Create_IP_HTML_table')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Create_IP_HTML_table": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Create_IP_HTML_table": {
                  "inputs": {
                    "format": "HTML",
                    "from": "@variables('result_output_ip')"
                  },
                  "runAfter": {
                    "For_each_ip_article": [
                      "Succeeded"
                    ]
                  },
                  "type": "Table"
                },
                "For_each_ip_article": {
                  "actions": {
                    "Append_to_array_variable": {
                      "inputs": {
                        "name": "result_output_ip",
                        "value": {
                          "Link": "@item()['link']",
                          "Title": "@item()['title']"
                        }
                      },
                      "type": "AppendToArrayVariable"
                    }
                  },
                  "foreach": "@body('Get_articles_by_indicator_ip')?['articles']",
                  "runAfter": {
                    "Get_articles_by_indicator_ip": [
                      "Succeeded"
                    ]
                  },
                  "type": "Foreach"
                },
                "Get_articles_by_indicator_ip": {
                  "inputs": {
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['riskiqpassivetotal']['connectionId']"
                      }
                    },
                    "method": "get",
                    "path": "/articles/indicator",
                    "queries": {
                      "query": "@items('For_each_IP_Address')?['Address']"
                    }
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_IPs')?['IPs']",
              "runAfter": {
                "Init_Result_IP": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Init_Result_Host": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_host",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Hosts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Init_Result_IP": {
              "inputs": {
                "variables": [
                  {
                    "name": "result_output_ip",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_IPs": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook27-AzureSentinelConnectionName'))]",
                "connectionName": "[variables('playbook27-AzureSentinelConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]"
              },
              "riskiqpassivetotal": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-RiskIQConnectionName'))]",
                "connectionName": "[variables('playbook1-RiskIQConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/riskiqpassivetotal')]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "version": "1.1.0",
        "kind": "Solution",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "RiskIQ",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Nikhil Tripathi",
          "email": "v-ntripathi@microsoft.com"
        },
        "support": {
          "name": "RiskIQ",
          "tier": "Partner",
          "link": "https://www.riskiq.com/integrations/microsoft/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Baseazuredeploy1')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_alert-triggerazuredeploy2')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_incident-triggerazuredeploy3')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-PassiveDns-Domainazuredeploy4')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-PassiveDns-Ipazuredeploy5')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-PassiveDnsazuredeploy6')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_alert-triggerazuredeploy7')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_incident-triggerazuredeploy8')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_alert-triggerazuredeploy9')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_incident-triggerazuredeploy10')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_alert-triggerazuredeploy11')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_incident-triggerazuredeploy12')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-Whois-Domainazuredeploy13')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-Whois-IPazuredeploy14')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_RiskIQ-Data-Whoisazuredeploy15')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_alert-triggerazuredeploy16')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_incident-triggerazuredeploy17')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_alert-triggerazuredeploy18')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_incident-triggerazuredeploy19')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_alert-triggerazuredeploy20')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_incident-triggerazuredeploy21')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_alert-triggerazuredeploy22')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_incident-triggerazuredeploy23')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_alert-triggerazuredeploy24')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_incident-triggerazuredeploy25')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_alert-triggerazuredeploy26')]",
              "version": "1.1.0"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_incident-triggerazuredeploy27')]",
              "version": "1.1.0"
            }
          ]
        },
        "firstPublishDate": "2021-10-20",
        "providers": [
          "RiskIQ"
        ],
        "categories": {
          "domains": [
            "Security - Threat Intelligence",
            "Security – Automation (SOAR)"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
