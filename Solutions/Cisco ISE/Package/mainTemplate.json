{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Eli Forbes - v-eliforbes@microsoft.com",
    "comments": "Solution template for Cisco ISE"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[parameters('location')]",
      "metadata": {
        "description": "Region to deploy solution resources"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Cisco ISE",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic3-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic4-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic5-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic6-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic7-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic8-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic9-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic10-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "playbook1-PlaybookName": {
      "defaultValue": "CiscoISE-FalsePositivesClearPolicies",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook1-WatchlistName": {
      "defaultValue": "",
      "type": "string"
    },
    "playbook1-WatchlistFieldName": {
      "defaultValue": "",
      "type": "string"
    },
    "playbook2-PlaybookName": {
      "defaultValue": "CiscoISE-SuspendGuestUser",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook3-PlaybookName": {
      "defaultValue": "CiscoISE-TakeEndpointActionFromTeams",
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "Resource name for the logic app playbook.  No spaces are allowed"
      }
    },
    "playbook3-TeamsGroupId": {
      "defaultValue": "TeamsGroupIds",
      "type": "string",
      "minLength": 1
    },
    "playbook3-TeamsChannelId": {
      "defaultValue": "TeamsChannelId",
      "type": "string",
      "minLength": 1
    },
    "playbook3-PolicyName": {
      "defaultValue": "PolicyName",
      "type": "string",
      "minLength": 1
    },
    "playbook4-API Hostname": {
      "defaultValue": "testhost.com",
      "type": "string",
      "minLength": 1
    },
    "playbook4-API Port": {
      "defaultValue": "9060",
      "type": "string",
      "minLength": 1
    },
    "connectorName": {
      "type": "string",
      "defaultValue": "9b1d0241-e990-4618-8bbb-11ce737b318b"
    }
  },
  "variables": {
    "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
    "_workbook-source": "[variables('workbook-source')]",
    "customApis_ciscoise_name": "CiscoISE",
    "playbook1-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook1-PlaybookName'))]",
    "playbook1-AzureMonitorLogsConnectionName": "[concat('azuremonitorlogs-', parameters('playbook1-PlaybookName'))]",
    "playbook1-CiscoISEConnectionName": "[concat('ciscoise-connection-', parameters('playbook1-PlaybookName'))]",
    "playbook1-customApis_ciscoise_name": "CiscoISE",
    "playbook-1-connection-1": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuresentinel')]",
    "_playbook-1-connection-1": "[variables('playbook-1-connection-1')]",
    "playbook-1-connection-2": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/azuremonitorlogs')]",
    "_playbook-1-connection-2": "[variables('playbook-1-connection-2')]",
    "playbook-1-connection-3": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('customApis_ciscoise_name'))]",
    "_playbook-1-connection-3": "[variables('playbook-1-connection-3')]",
    "playbook2-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook2-PlaybookName'))]",
    "playbook2-CiscoISEConnectionName": "[concat('ciscoise-connection-', parameters('playbook2-PlaybookName'))]",
    "playbook2-customApis_ciscoise_name": "CiscoISE",
    "playbook3-AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('playbook3-PlaybookName'))]",
    "playbook3-TeamsConnectionName": "[concat('teams-', parameters('playbook3-PlaybookName'))]",
    "playbook3-CiscoISEConnectionName": "[concat('ciscoise-connection-', parameters('playbook3-PlaybookName'))]",
    "playbook3-customApis_ciscoise_name": "CiscoISE",
    "playbook-3-connection-2": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', parameters('workspace-location'), '/managedApis/teams')]",
    "_playbook-3-connection-2": "[variables('playbook-3-connection-2')]",
    "playbook4-customApis_CiscoISE_name": "CiscoISE",
    "operationId-SuspendGuestUser": "SuspendGuestUser",
    "_operationId-SuspendGuestUser": "[variables('operationId-SuspendGuestUser')]",
    "operationId-ANCEndpointApply": "ANCEndpointApply",
    "_operationId-ANCEndpointApply": "[variables('operationId-ANCEndpointApply')]",
    "operationId-ANCEndpointClear": "ANCEndpointClear",
    "_operationId-ANCEndpointClear": "[variables('operationId-ANCEndpointClear')]",
    "operationId-ANCEndpointGetById": "ANCEndpointGetById",
    "_operationId-ANCEndpointGetById": "[variables('operationId-ANCEndpointGetById')]",
    "operationId-ANCEndpointGetAll": "ANCEndpointGetAll",
    "_operationId-ANCEndpointGetAll": "[variables('operationId-ANCEndpointGetAll')]",
    "operationId-CreateANCPolicy": "CreateANCPolicy",
    "_operationId-CreateANCPolicy": "[variables('operationId-CreateANCPolicy')]",
    "operationId-UpdateEndpointGroup": "UpdateEndpointGroup",
    "_operationId-UpdateEndpointGroup": "[variables('operationId-UpdateEndpointGroup')]",
    "operationId-GetRejectedEndpoints": "GetRejectedEndpoints",
    "_operationId-GetRejectedEndpoints": "[variables('operationId-GetRejectedEndpoints')]",
    "operationId-ReleaseRejectedEndpoint": "ReleaseRejectedEndpoint",
    "_operationId-ReleaseRejectedEndpoint": "[variables('operationId-ReleaseRejectedEndpoint')]",
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "CiscoISEEvent": "CiscoISEEvent",
    "_CiscoISEEvent": "[variables('CiscoISEEvent')]",
    "CiscoISEDataconnector": "CiscoISE",
    "_CiscoISEDataconnector": "[variables('CiscoISEDataconnector')]",
    "CiscoISEAdminPasswordReset": "6107cba5-2974-4c22-8222-2a6f7bbea664",
    "_CiscoISEAdminPasswordReset": "[variables('CiscoISEAdminPasswordReset')]",
    "CiscoISEAttempDeleteLocalStoreLogs": "1fa0da3e-ec99-484f-aadb-93f59764e158",
    "_CiscoISEAttempDeleteLocalStoreLogs": "[variables('CiscoISEAttempDeleteLocalStoreLogs')]",
    "CiscoISEBackupFailed": "e71890a2-5f61-4790-b1ed-cf1d92d3e398",
    "_CiscoISEBackupFailed": "[variables('CiscoISEBackupFailed')]",
    "CiscoISECertExpired": "0c509e9b-121e-4951-9f9b-43722e052b4f",
    "_CiscoISECertExpired": "[variables('CiscoISECertExpired')]",
    "CiscoISECmdExecutionWithHighestPrivilegesNewIP": "548a2eda-d3eb-46cc-8d4b-1601551629e4",
    "_CiscoISECmdExecutionWithHighestPrivilegesNewIP": "[variables('CiscoISECmdExecutionWithHighestPrivilegesNewIP')]",
    "CiscoISECmdExecutionWithHighestPrivilegesNewUser": "ce171782-1643-4f21-bbb7-fa954b1e6897",
    "_CiscoISECmdExecutionWithHighestPrivilegesNewUser": "[variables('CiscoISECmdExecutionWithHighestPrivilegesNewUser')]",
    "CiscoISEDeviceChangedIP": "21d3be4c-6088-4e76-b6eb-d25479019cb9",
    "_CiscoISEDeviceChangedIP": "[variables('CiscoISEDeviceChangedIP')]",
    "CiscoISEDevicePostureStatusChanged": "e63b4d90-d0a8-4609-b187-babfcc7f86d7",
    "_CiscoISEDevicePostureStatusChanged": "[variables('CiscoISEDevicePostureStatusChanged')]",
    "CiscoISELogCollectorSuspended": "b6549a28-d61c-476e-b350-4404352ee427",
    "_CiscoISELogCollectorSuspended": "[variables('CiscoISELogCollectorSuspended')]",
    "CiscoISELogsDeleted": "4eddd44a-25e4-41af-930d-0c17218bec74",
    "_CiscoISELogsDeleted": "[variables('CiscoISELogsDeleted')]",
    "CiscoISE-FalsePositivesClearPolicies": "CiscoISE-FalsePositivesClearPolicies",
    "_CiscoISE-FalsePositivesClearPolicies": "[variables('CiscoISE-FalsePositivesClearPolicies')]",
    "CiscoISE-SuspendGuestUser": "CiscoISE-SuspendGuestUser",
    "_CiscoISE-SuspendGuestUser": "[variables('CiscoISE-SuspendGuestUser')]",
    "CiscoISE-TakeEndpointActionFromTeams": "CiscoISE-TakeEndpointActionFromTeams",
    "_CiscoISE-TakeEndpointActionFromTeams": "[variables('CiscoISE-TakeEndpointActionFromTeams')]",
    "CiscoISEConnector_LinkedTemplate": "CiscoISEConnector_LinkedTemplate",
    "_CiscoISEConnector_LinkedTemplate": "[variables('CiscoISEConnector_LinkedTemplate')]",
    "CiscoISEAuthenticationToSuspendedAccount": "3935b084-2fa1-461a-b920-1e20c1acff7b",
    "_CiscoISEAuthenticationToSuspendedAccount": "[variables('CiscoISEAuthenticationToSuspendedAccount')]",
    "CiscoISEDynamicAuthorizationFailed": "377a4eb8-ced4-4e2b-a2f5-731db8f78275",
    "_CiscoISEDynamicAuthorizationFailed": "[variables('CiscoISEDynamicAuthorizationFailed')]",
    "CiscoISEExpiredCertInClientCertChain": "32abe28a-c1c8-4eb4-adfb-858abdbacbfe",
    "_CiscoISEExpiredCertInClientCertChain": "[variables('CiscoISEExpiredCertInClientCertChain')]",
    "CiscoISEFailedAuthentication": "4fb45425-b758-41d8-80bc-843b5b0f119e",
    "_CiscoISEFailedAuthentication": "[variables('CiscoISEFailedAuthentication')]",
    "CiscoISEFailedLoginsSSHCLI": "abea259e-7d56-48d8-ae47-d159929eeed8",
    "_CiscoISEFailedLoginsSSHCLI": "[variables('CiscoISEFailedLoginsSSHCLI')]",
    "CiscoISEGuestAuthenticationFailed": "72f60667-2a6d-421d-b98d-3d7c3b37a0e5",
    "_CiscoISEGuestAuthenticationFailed": "[variables('CiscoISEGuestAuthenticationFailed')]",
    "CiscoISEGuestAuthenticationSuccess": "98d1384d-5aef-430c-875c-3b4434afb003",
    "_CiscoISEGuestAuthenticationSuccess": "[variables('CiscoISEGuestAuthenticationSuccess')]",
    "CiscoISERareUserAgent": "c6ebac93-18af-43e3-b757-d6cb147a74b9",
    "_CiscoISERareUserAgent": "[variables('CiscoISERareUserAgent')]",
    "CiscoISESourceHighNumberAuthenticationErrors": "9cb9ef9e-4f4d-4437-8abe-249589e72931",
    "_CiscoISESourceHighNumberAuthenticationErrors": "[variables('CiscoISESourceHighNumberAuthenticationErrors')]",
    "CiscoISESuspendLogCollector": "64b63d2d-a867-4451-bf74-f2310398498e",
    "_CiscoISESuspendLogCollector": "[variables('CiscoISESuspendLogCollector')]",
    "connector1-source": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',parameters('connectorName'))]",
    "_connector1-source": "[variables('connector1-source')]",
    "sourceId": "azuresentinel.azure-sentinel-solution-ciscoise",
    "_sourceId": "[variables('sourceId')]",
    "workbookContentId": "sentinel-CiscoISE",
    "_workbookContentId": "[variables('workbookContentId')]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "2020-02-12",
      "properties": {
        "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Cisco Identity Services Engine\\nCisco ISE allows you to provide highly secure network access to users and devices. It helps you gain visibility into what is happening in your network, such as who is connected, which applications are installed and running, and much more. It also shares vital contextual data, such as user and device identities, threats, and vulnerabilities with integrated solutions from Cisco technology partners, so you can identify, contain, and remediate threats faster.\",\"style\":\"info\"},\"name\":\"Text\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"88aa96e3-fc48-4b04-836e-fc2ec8ebf37f\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\" Time Range\",\"type\":4,\"value\":{\"durationMs\":2592000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":3600000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":2592000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Parameters\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoISEEvent\\r\\n| make-series TotalEvents = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by EventCategory;\",\"size\":0,\"title\":\"Events over time\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\"},\"customWidth\":\"70\",\"name\":\"EventsOverTime\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoISEEvent\\r\\n| summarize TotalEvents = count() by EventSeverity\",\"size\":4,\"title\":\"Event Severity Distribution\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"EventSeverity\",\"formatter\":1,\"numberFormat\":{\"unit\":0,\"options\":{\"style\":\"decimal\"}}},\"leftContent\":{\"columnMatch\":\"TotalEvents\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":true,\"rowLimit\":7,\"size\":\"auto\"},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"EventSeverity\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"TotalEvents\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"30\",\"name\":\"EventSeverityDistribution\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoISEEvent\\n| summarize TotalEvents = count() by EventCategory\\n| join kind = inner (CiscoISEEvent\\n      | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by EventCategory)\\n      on EventCategory\\n| project-away EventCategory1, TimeGenerated\\n| project EventCategory, TotalEvents, Trend\\n| order by TotalEvents desc\\n\\n\\n\",\"size\":4,\"title\":\"Event Categories Distribution\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"EventCategory\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"TotalEvents\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":false,\"rowLimit\":10}},\"name\":\"EventCategoriesDistribution\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoISEEvent\\r\\n| where DvcHostname != ''\\r\\n| summarize TotalEvents = count() by DvcHostname\\r\\n| join kind = inner (CiscoISEEvent\\r\\n | where DvcHostname != ''\\r\\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by DvcHostname)\\r\\n on DvcHostname\\r\\n| project-away DvcHostname1, TimeGenerated\\r\\n| project DvcHostname, TotalEvents, Trend\\r\\n| order by TotalEvents\\r\\n| take 10\\r\\n\",\"size\":0,\"title\":\"Top Reporting Devices\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"TotalEvents\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blueGreen\"}},{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"turquoise\"}}],\"rowLimit\":10,\"labelSettings\":[{\"columnId\":\"TotalEvents\",\"label\":\"Total Events\"},{\"columnId\":\"Trend\"}]}},\"customWidth\":\"31\",\"name\":\"TopReportingDevices\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoISEEvent\\r\\n| where DstUserName != ''\\r\\n| summarize TotalEvents = count() by DstUserName\\r\\n| order by TotalEvents\\r\\n| take 10\",\"size\":3,\"title\":\"Top Users Activity (Events)\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"TopUsersActivity \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoISEEvent\\r\\n| where EventId in ('5400', '5401')\\r\\n| where DstUserName != ''\\r\\n| summarize TotalEvents = count() by DstUserName\\r\\n\",\"size\":0,\"title\":\"Top Users with Failed Authentication\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"TopUsersFailedAuthentication\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoISEEvent\\r\\n| where PostureStatus != ''\\r\\n| where PostureStatus != 'Compliant'\\r\\n| summarize TotalEvents = count() by DstIpAddr\\r\\n\\r\\n\",\"size\":1,\"title\":\"Non-Compliant Posture Status\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"NonCompliantPostureStatus\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoISEEvent\\r\\n| where EventSeverity in ('FATAL', 'ERROR')\\r\\n| summarize errorCnt = count() by EventId, ErrorMessage = EventMessage\\r\\n| sort by errorCnt\\r\\n| project [' Error Code'] = EventId, ['Error Message'] = ErrorMessage , ['Error Count'] = toint(errorCnt)\",\"size\":1,\"title\":\"Details of top errors\",\"timeContext\":{\"durationMs\":2592000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"customWidth\":\"39\",\"name\":\"DetailsTopErrors\"}],\"fromTemplateId\":\"sentinel-CiscoISE\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
        "version": "1.0",
        "sourceId": "[variables('_workbook-source')]",
        "category": "sentinel"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when the ISE administrator password has been reset.",
        "displayName": "CiscoISE - ISE administrator password has been reset",
        "enabled": false,
        "query": "let lbtime = 5m;\nCiscoISEEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId == '58019'\n| project TimeGenerated, SrcIpAddr, DstUserName\n| extend AccountCustomEntity = DstUserName\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT5M",
        "queryPeriod": "PT5M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess",
          "Persistence",
          "PrivilegeEscalation",
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when attempt to delete local store logs failed.",
        "displayName": "CiscoISE - Attempt to delete local store logs",
        "enabled": false,
        "query": "let lbtime = 5m;\nCiscoISEEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId == '59103'\n| project TimeGenerated, DvcHostname, DvcIpAddr, DstUserName\n| extend HostCustomEntity = DvcHostname\n| extend IPCustomEntity = DvcIpAddr\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT5M",
        "queryPeriod": "PT5M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic3-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when backup activity failed.",
        "displayName": "CiscoISE - Backup failed",
        "enabled": false,
        "query": "let lbtime = 6h;\nCiscoISEEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId in ('60095', '60098')\n| project TimeGenerated, DvcHostname, DvcIpAddr\n| extend HostCustomEntity = DvcHostname\n| extend IPCustomEntity = DvcIpAddr\n",
        "queryFrequency": "PT6H",
        "queryPeriod": "PT6H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic4-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects certificate expiration.",
        "displayName": "CiscoISE - Certificate has expired",
        "enabled": false,
        "query": "let lbtime = 1h;\nCiscoISEEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId == '60167'\n| project SrcIpAddr, DvcIpAddr, DvcHostname, DstUserName\n| extend HostCustomEntity = DvcHostname\n| extend IPCustomEntity = SrcIpAddr\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CredentialAccess"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic5-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects command execution with PrivilegeLevel - 15 from new source.",
        "displayName": "CiscoISE -  Command executed with the highest privileges from new IP",
        "enabled": false,
        "query": "let lbperiod = 60d;\nlet lbtime = 15m;\nlet knownAdminIpList =\nCiscoISEEvent\n| where TimeGenerated between (ago(lbperiod) .. ago(lbtime))\n| where PrivilegeLevel == '15'\n| summarize makelist(SrcIpAddr)\n;\nCiscoISEEvent\n| where TimeGenerated > ago(lbtime)\n| where PrivilegeLevel == '15'\n| where SrcIpAddr !in (knownAdminIpList)\n| project TimeGenerated, SrcIpAddr, DstIpAddr, DstUserName, CmdSet\n| extend AccountCustomEntity = DstUserName\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT5M",
        "queryPeriod": "PT5M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess",
          "Persistence",
          "PrivilegeEscalation",
          "DefenseEvasion",
          "Execution"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic6-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects command execution with PrivilegeLevel - 15 by user for wich there was no such activity detected earlier.",
        "displayName": "CiscoISE - Command executed with the highest privileges by new user",
        "enabled": false,
        "query": "let lbperiod = 60d;\nlet lbtime = 15m;\nlet knownPrivUsers =\nCiscoISEEvent\n| where TimeGenerated between (ago(lbperiod) .. ago(lbtime))\n| where PrivilegeLevel == '15'\n| summarize makelist(DstUserName)\n;\nCiscoISEEvent\n| where TimeGenerated > ago(lbtime)\n| where PrivilegeLevel == '15'\n| where DstUserName !in (knownPrivUsers)\n| project TimeGenerated, SrcIpAddr, DstIpAddr, DstUserName, CmdSet\n| extend AccountCustomEntity = DstUserName\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT5M",
        "queryPeriod": "PT5M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess",
          "Persistence",
          "PrivilegeEscalation",
          "DefenseEvasion",
          "Execution"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic7-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when device changes IP address in last 24 hours.",
        "displayName": "CiscoISE - Device changed IP in last 24 hours",
        "enabled": false,
        "query": "let lbtime_48h = 48h;\nlet lbtime_24h = 24h;\nCiscoISEEvent\n| where TimeGenerated between (ago(lbtime_48h) .. ago(lbtime_24h))\n| where notempty(DvcIpAddr) and notempty(DvcHostname)\n| summarize knownIPs = make_set(DvcIpAddr) by DvcHostname\n| join (CiscoISEEvent\n      | where TimeGenerated > ago(lbtime_24h)\n      | where notempty(DvcIpAddr) and notempty(DvcHostname)\n      | summarize evts = count() by DvcHostname, DvcIpAddr\n      | project-away evts) on DvcHostname\n| project-away DvcHostname1\n| where knownIPs !contains DvcIpAddr\n| extend HostCustomEntity = DvcHostname\n| extend IPCustomEntity = DvcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic8-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when device changes PostureStatus from \"Compliant\".",
        "displayName": "CiscoISE - Device PostureStatus changed to non-compliant",
        "enabled": false,
        "query": "let lbtime_48h = 48h;\nlet lbtime_24h = 24h;\nlet lbtime_now = now();\nlet compliantIPs = CiscoISEEvent\n| where TimeGenerated between (ago(lbtime_48h) .. ago(lbtime_24h))\n| where PostureStatus == 'Compliant'\n| summarize makelist(DstIpAddr)\n;\nCiscoISEEvent\n| where TimeGenerated between (ago(lbtime_24h) .. lbtime_now)\n| where PostureStatus != 'Compliant'\n| where DstIpAddr in (compliantIPs)\n| project DstIpAddr\n| extend IPCustomEntity = DstIpAddr\n",
        "queryFrequency": "PT15M",
        "queryPeriod": "PT15M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CredentialAccess"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic9-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when log collector was suspended.",
        "displayName": "CiscoISE - Log collector was suspended",
        "enabled": false,
        "query": "let lbtime = 10m;\nCiscoISEEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId == '59207'\n| project TimeGenerated, SrcIpAddr, DstIpAddr\n| extend IPCustomEntity = DstIpAddr\n",
        "queryFrequency": "PT10M",
        "queryPeriod": "PT10M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic10-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects log file deleting activity.",
        "displayName": "CiscoISE - Log files deleted",
        "enabled": false,
        "query": "let lbtime = 5m;\nCiscoISEEvent\n| where TimeGenerated > ago(lbtime)\n| where EventId in ('58015', '59101', '59102')\n| project TimeGenerated, DvcHostname, DvcIpAddr, DstUserName\n| extend HostCustomEntity = DvcHostname\n| extend IPCustomEntity = DvcIpAddr\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT5M",
        "queryPeriod": "PT5M",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "DefenseEvasion"
        ]
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook1-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[variables('playbook1-AzureSentinelConnectionName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook1-AzureMonitorLogsConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[variables('playbook1-AzureMonitorLogsConnectionName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook1-CiscoISEConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/customApis', variables('customApis_ciscoise_name'))]"
      ],
      "kind": "V1",
      "properties": {
        "displayName": "[variables('playbook1-CiscoISEConnectionName')]",
        "parameterValues": {
          "authType": "basic"
        },
        "api": {
          "id": "[variables('_playbook-1-connection-3')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook1-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook1-AzureSentinelConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-AzureMonitorLogsConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook1-CiscoISEConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Add_comment_to_incident_(V3)": {
              "inputs": {
                "body": {
                  "incidentArmId": "@triggerBody()?['object']?['id']",
                  "message": "<p><strong></strong><strong>@{outputs('Create_logo')}</strong><strong> CiscoISE-FalsePositivesClearPolicies</strong><br> The following endpoints were released as they are in safe list @{variables('watchlist')}:<br> @{body('Create_released_endpoints_HTML_table')}<br> The following endpoints were not released because of errors although they are in safe list @{variables('watchlist')}:<br> @{body('Create_not_released_endpoints_HTML_table')}</p>"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/Incidents/Comment"
              },
              "runAfter": {
                "Create_logo": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "Create_logo": {
              "inputs": "<img src=\"https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Cisco%20ISE/Playbooks/cisco-logo.png\"  width=\"32\" height=\"32\">",
              "runAfter": {
                "Create_not_released_endpoints_HTML_table": [
                  "Succeeded"
                ]
              },
              "type": "Compose"
            },
            "Create_not_released_endpoints_HTML_table": {
              "inputs": {
                "columns": [
                  {
                    "header": "MACaddress",
                    "value": "@item()"
                  }
                ],
                "format": "HTML",
                "from": "@variables('not_released_endpoints')"
              },
              "runAfter": {
                "Create_released_endpoints_HTML_table": [
                  "Succeeded"
                ]
              },
              "type": "Table"
            },
            "Create_released_endpoints_HTML_table": {
              "inputs": {
                "columns": [
                  {
                    "header": "MACaddress",
                    "value": "@item()"
                  }
                ],
                "format": "HTML",
                "from": "@variables('released_endpoints')"
              },
              "runAfter": {
                "For_each_MACAddress": [
                  "Succeeded"
                ]
              },
              "type": "Table"
            },
            "Filter_array": {
              "inputs": {
                "from": "@variables('mac_addresses')",
                "where": "@contains(variables('rejected_endpoints'), item())"
              },
              "runAfter": {
                "For_each_alert_in_incident": [
                  "Succeeded"
                ]
              },
              "type": "Query"
            },
            "For_each_MACAddress": {
              "actions": {
                "Find_MAC_in_watchlist": {
                  "inputs": {
                    "body": "let ls = _GetWatchlist('@{variables('watchlist')}'); find in (ls) where @{variables('watchlist_mac_field')}==\"@{items('For_each_MACAddress')}\" | take 1",
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuremonitorlogs']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/queryData",
                    "queries": {
                      "resourcegroups": "@triggerBody()?['workspaceInfo']?['ResourceGroupName']",
                      "resourcename": "@triggerBody()?['workspaceInfo']?['WorkspaceName']",
                      "resourcetype": "Log Analytics Workspace",
                      "subscriptions": "@triggerBody()?['workspaceInfo']?['SubscriptionId']",
                      "timerange": "1d"
                    }
                  },
                  "type": "ApiConnection"
                },
                "If_MAC_is_in_watchlist": {
                  "actions": {
                    "Append_MAC_to_not_released_endpoints_variable": {
                      "inputs": {
                        "name": "not_released_endpoints",
                        "value": "@items('For_each_MACAddress')"
                      },
                      "runAfter": {
                        "Release_rejected_endpoint": [
                          "Failed",
                          "TimedOut"
                        ]
                      },
                      "type": "AppendToArrayVariable"
                    },
                    "Append_MAC_to_released_endpoints_variable": {
                      "inputs": {
                        "name": "released_endpoints",
                        "value": "@items('For_each_MACAddress')"
                      },
                      "runAfter": {
                        "Append_MAC_to_not_released_endpoints_variable": [
                          "Skipped"
                        ]
                      },
                      "type": "AppendToArrayVariable"
                    },
                    "Release_rejected_endpoint": {
                      "inputs": {
                        "headers": {
                          "Accept": "application/json",
                          "Content-Type": "application/json"
                        },
                        "host": {
                          "connection": {
                            "name": "@parameters('$connections')['ciscoise']['connectionId']"
                          }
                        },
                        "method": "put",
                        "path": "/ers/config/endpoint/@{encodeURIComponent(items('For_each_MACAddress'))}/releaserejectedendpoint"
                      },
                      "type": "ApiConnection"
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "greater": [
                          "@length(body('Find_MAC_in_watchlist'))",
                          0
                        ]
                      }
                    ]
                  },
                  "runAfter": {
                    "Find_MAC_in_watchlist": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                }
              },
              "foreach": "@variables('mac_addresses')",
              "runAfter": {
                "Filter_array": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "For_each_alert_in_incident": {
              "actions": {
                "Append_MACAddress_to_mac_addresses_array": {
                  "inputs": {
                    "name": "mac_addresses",
                    "value": "@body('Parse_alert_custom_details')?['MACAddress'][0]"
                  },
                  "runAfter": {
                    "Parse_alert_custom_details": [
                      "Succeeded"
                    ]
                  },
                  "type": "AppendToArrayVariable"
                },
                "Parse_alert_custom_details": {
                  "inputs": {
                    "content": "@items('For_each_alert_in_incident')?['properties']?['additionalData']?['Custom Details']",
                    "schema": {
                      "properties": {
                        "MACAddress": {
                          "items": {
                            "type": "string"
                          },
                          "type": "array"
                        }
                      },
                      "type": "object"
                    }
                  },
                  "type": "ParseJson"
                }
              },
              "foreach": "@triggerBody()?['object']?['properties']?['Alerts']",
              "runAfter": {
                "For_each_rejected_endpoint": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "For_each_rejected_endpoint": {
              "actions": {
                "Append_to_rejected_endpoints_variable": {
                  "inputs": {
                    "name": "rejected_endpoints",
                    "value": "@items('For_each_rejected_endpoint')?['value']"
                  },
                  "type": "AppendToArrayVariable"
                }
              },
              "foreach": "@body('Get_rejected_endpoints')?['OperationResult']?['resultValue']",
              "runAfter": {
                "Get_rejected_endpoints": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Get_rejected_endpoints": {
              "inputs": {
                "headers": {
                  "Accept": "application/json",
                  "Content-Type": "application/json"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['ciscoise']['connectionId']"
                  }
                },
                "method": "get",
                "path": "/ers/config/endpoint/getrejectedendpoints"
              },
              "runAfter": {
                "Initialize_variable_not_released_endpoints": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "Initialize_variable_MAC_addresses": {
              "inputs": {
                "variables": [
                  {
                    "name": "mac_addresses",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_rejected_endpoints": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_not_released_endpoints": {
              "inputs": {
                "variables": [
                  {
                    "name": "not_released_endpoints",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_released_endpoints": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_rejected_endpoints": {
              "inputs": {
                "variables": [
                  {
                    "name": "rejected_endpoints",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_watchlist_mac_field": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_released_endpoints": {
              "inputs": {
                "variables": [
                  {
                    "name": "released_endpoints",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_MAC_addresses": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_watchlist": {
              "inputs": {
                "variables": [
                  {
                    "name": "watchlist",
                    "type": "string",
                    "value": "[parameters('playbook1-WatchlistName')]"
                  }
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_watchlist_mac_field": {
              "inputs": {
                "variables": [
                  {
                    "name": "watchlist_mac_field",
                    "type": "string",
                    "value": "[parameters('playbook1-WatchlistFieldName')]"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_watchlist": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionName": "[variables('playbook1-AzureSentinelConnectionName')]",
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-AzureSentinelConnectionName'))]",
                "id": "[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',parameters('workspace-location'),'/managedApis/azuresentinel')]"
              },
              "azuremonitorlogs": {
                "connectionName": "[variables('playbook1-AzureMonitorLogsConnectionName')]",
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-AzureMonitorLogsConnectionName'))]",
                "id": "[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',parameters('workspace-location'),'/managedApis/azuremonitorlogs')]"
              },
              "ciscoise": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook1-CiscoISEConnectionName'))]",
                "connectionName": "[variables('playbook1-CiscoISEConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('playbook1-customApis_ciscoise_name'))]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook2-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[variables('playbook2-AzureSentinelConnectionName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook2-CiscoISEConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/customApis', variables('customApis_ciscoise_name'))]"
      ],
      "kind": "V1",
      "properties": {
        "displayName": "[variables('playbook2-CiscoISEConnectionName')]",
        "parameterValues": {
          "authType": "basic"
        },
        "api": {
          "id": "[variables('_playbook-1-connection-3')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook2-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook2-AzureSentinelConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook2-CiscoISEConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "Add_comment_to_incident_(V3)": {
              "inputs": {
                "body": {
                  "incidentArmId": "@triggerBody()?['object']?['id']",
                  "message": "<p><span style=\"font-size: 16px\"><strong></strong></span><span style=\"font-size: 16px\"><strong>@{outputs('Create_html_tag_with_Cisco_logo')}</strong></span><span style=\"font-size: 16px\"><strong> CiscoISE SuspendGuestUser Playbook<br> </strong></span><span style=\"font-size: 14px\">CiscoISE SuspendGuestUser playbook was triggered and suspended the following users:<br> </span><span style=\"font-size: 14px\">@{body('Create_HTML_table_with_suspended_users')}</span><span style=\"font-size: 14px\"><br> The following users are not suspended:<br> </span><span style=\"font-size: 14px\">@{body('Create_HTML_table_with_not_suspended_users')}</span><span style=\"font-size: 14px\"><br> </span></p>"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/Incidents/Comment"
              },
              "runAfter": {
                "Create_html_tag_with_Cisco_logo": [
                  "Succeeded"
                ]
              },
              "type": "ApiConnection"
            },
            "Create_HTML_table_with_not_suspended_users": {
              "inputs": {
                "columns": [
                  {
                    "header": "user",
                    "value": "@item()"
                  }
                ],
                "format": "HTML",
                "from": "@variables('not suspended users')"
              },
              "runAfter": {
                "Create_HTML_table_with_suspended_users": [
                  "Succeeded"
                ]
              },
              "type": "Table"
            },
            "Create_HTML_table_with_suspended_users": {
              "inputs": {
                "columns": [
                  {
                    "header": "user",
                    "value": "@item()"
                  }
                ],
                "format": "HTML",
                "from": "@variables('suspended users')"
              },
              "runAfter": {
                "For_each_Account_in_incident": [
                  "Succeeded"
                ]
              },
              "type": "Table"
            },
            "Create_html_tag_with_Cisco_logo": {
              "inputs": "<img src=\"https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Cisco%20ISE/Playbooks/cisco-logo.png\"  width=\"32\" height=\"32\">",
              "runAfter": {
                "Create_HTML_table_with_not_suspended_users": [
                  "Succeeded"
                ]
              },
              "type": "Compose"
            },
            "Entities_-_Get_Accounts": {
              "inputs": {
                "body": "@triggerBody()?['object']?['properties']?['relatedEntities']",
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "method": "post",
                "path": "/entities/account"
              },
              "type": "ApiConnection"
            },
            "For_each_Account_in_incident": {
              "actions": {
                "Append_user_to_\"not_suspended_users\"": {
                  "description": "Append user to \" not suspended users\" if API call was not successful",
                  "inputs": {
                    "name": "not suspended users",
                    "value": "@item()['Name']"
                  },
                  "runAfter": {
                    "Suspend_guest_user_by_name": [
                      "Failed",
                      "TimedOut"
                    ]
                  },
                  "type": "AppendToArrayVariable"
                },
                "Append_user_to_\"suspended_users\"": {
                  "description": "Append user to \"suspended users\" if API call was successful",
                  "inputs": {
                    "name": "suspended users",
                    "value": "@item()['Name']"
                  },
                  "runAfter": {
                    "Append_user_to_\"not_suspended_users\"": [
                      "Skipped"
                    ]
                  },
                  "type": "AppendToArrayVariable"
                },
                "Suspend_guest_user_by_name": {
                  "inputs": {
                    "headers": {
                      "Accept": "application/json",
                      "Cache-Control": "no-cache",
                      "Content-Type": "application/json; charset=utf-8"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['ciscoise']['connectionId']"
                      }
                    },
                    "method": "put",
                    "path": "/ers/config/guestuser/suspend/name/@{encodeURIComponent(item()['Name'])}"
                  },
                  "type": "ApiConnection"
                }
              },
              "foreach": "@body('Entities_-_Get_Accounts')?['Accounts']",
              "runAfter": {
                "Initialize_variable_\"not_suspended_users\"": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Initialize_variable_\"not_suspended_users\"": {
              "description": "This varaible will contain users that are not suspended.",
              "inputs": {
                "variables": [
                  {
                    "name": "not suspended users",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_\"suspended_users\"": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_\"suspended_users\"": {
              "description": "This varaible will contain users that are suspended.",
              "inputs": {
                "variables": [
                  {
                    "name": "suspended users",
                    "type": "array"
                  }
                ]
              },
              "runAfter": {
                "Entities_-_Get_Accounts": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionName": "[variables('playbook2-AzureSentinelConnectionName')]",
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook2-AzureSentinelConnectionName'))]",
                "id": "[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',parameters('workspace-location'),'/managedApis/azuresentinel')]"
              },
              "ciscoise": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook2-CiscoISEConnectionName'))]",
                "connectionName": "[variables('playbook2-CiscoISEConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('playbook2-customApis_ciscoise_name'))]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook3-AzureSentinelConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[variables('playbook3-AzureSentinelConnectionName')]",
        "api": {
          "id": "[variables('_playbook-1-connection-1')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook3-TeamsConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "displayName": "[variables('playbook3-TeamsConnectionName')]",
        "api": {
          "id": "[variables('_playbook-3-connection-2')]"
        }
      }
    },
    {
      "type": "Microsoft.Web/connections",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook3-CiscoISEConnectionName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/customApis', variables('customApis_ciscoise_name'))]"
      ],
      "kind": "V1",
      "properties": {
        "displayName": "[variables('playbook3-CiscoISEConnectionName')]",
        "parameterValues": {
          "authType": "basic"
        },
        "api": {
          "id": "[variables('_playbook-1-connection-3')]"
        }
      }
    },
    {
      "type": "Microsoft.Logic/workflows",
      "apiVersion": "2019-05-01",
      "name": "[parameters('playbook3-PlaybookName')]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/connections', variables('playbook3-AzureSentinelConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook3-TeamsConnectionName'))]",
        "[resourceId('Microsoft.Web/connections', variables('playbook3-CiscoISEConnectionName'))]"
      ],
      "properties": {
        "state": "Enabled",
        "definition": {
          "$schema": "https://schema.@{variables('azureManagementUrl')}/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
          "actions": {
            "For_each": {
              "actions": {
                "Add_comment_to_incident_(V3)": {
                  "inputs": {
                    "body": {
                      "incidentArmId": "@triggerBody()?['object']?['id']",
                      "message": "<p>@{outputs('Get_Cisco_Logo')} <strong>CiscoISE-TakeEndpointActionFromTeams</strong><br> Actions taken:<br> @{variables('ActionResult')}<br> @{variables('NewSeverity')}<br> @{variables('NewStatus')}</p>"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                      }
                    },
                    "method": "post",
                    "path": "/Incidents/Comment"
                  },
                  "runAfter": {
                    "Get_Cisco_Logo": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnection"
                },
                "Get_Cisco_Logo": {
                  "inputs": "<img src=\"https://github.com/Azure/Azure-Sentinel/blob/master/Solutions/Cisco%20ISE/Playbooks/cisco-logo.png\"  width=\"32\" height=\"32\">",
                  "runAfter": {
                    "Update_incident_status": [
                      "Succeeded"
                    ]
                  },
                  "type": "Compose"
                },
                "Get_MACAddress": {
                  "inputs": "@body('Parse_JSON')['MACAddress'][0]",
                  "runAfter": {
                    "Parse_JSON": [
                      "Succeeded"
                    ]
                  },
                  "type": "Compose"
                },
                "Get_Teams_card_body": {
                  "inputs": {
                    "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                    "actions": [
                      {
                        "id": "btnSubmit",
                        "title": "Submit",
                        "type": "Action.Submit"
                      },
                      {
                        "id": "btnIgnore",
                        "title": "Ignore",
                        "type": "Action.Submit"
                      }
                    ],
                    "body": [
                      {
                        "size": "large",
                        "text": "Suspicious Endpoint - Azure Sentinel",
                        "type": "TextBlock",
                        "weight": "bolder",
                        "wrap": true
                      },
                      {
                        "text": " Incident No : @{triggerBody()?['object']?['properties']?['incidentNumber']}  ",
                        "type": "TextBlock",
                        "weight": "Bolder",
                        "wrap": true
                      },
                      {
                        "text": "@{triggerBody()?['object']?['properties']?['description']}",
                        "type": "TextBlock",
                        "wrap": true
                      },
                      {
                        "text": "For more details check the incident:",
                        "type": "TextBlock",
                        "weight": "Bolder",
                        "wrap": true
                      },
                      {
                        "text": "[Click here to view the Incident](@{triggerBody()?['object']?['properties']?['incidentUrl']})",
                        "type": "TextBlock",
                        "wrap": true
                      },
                      {
                        "id": "PollQuestionAction",
                        "text": "Select the action to be taken with respect to the endpoint @{outputs('Get_MACAddress')} in Cisco ISE",
                        "type": "TextBlock",
                        "wrap": true
                      },
                      {
                        "choices": [
                          {
                            "title": "Assign policy @{variables('PolicyName')} to MAC address @{outputs('Get_MACAddress')}",
                            "value": "assign_policy"
                          },
                          {
                            "title": "Ignore",
                            "value": "ignore"
                          }
                        ],
                        "id": "action_choices",
                        "placeholder": "Select from these choices",
                        "style": "compact",
                        "type": "Input.ChoiceSet"
                      },
                      {
                        "id": "PollQuestionSeverity",
                        "text": "Select incident severity",
                        "type": "TextBlock"
                      },
                      {
                        "choices": [
                          {
                            "title": "High",
                            "value": "high"
                          },
                          {
                            "title": "Medium",
                            "value": "medium"
                          },
                          {
                            "title": "Low",
                            "value": "low"
                          },
                          {
                            "title": "Informational",
                            "value": "informational"
                          }
                        ],
                        "id": "severity_choices",
                        "placeholder": "Select from these choices",
                        "style": "compact",
                        "type": "Input.ChoiceSet"
                      },
                      {
                        "id": "PollQuestionStatus",
                        "text": "Select incident status",
                        "type": "TextBlock"
                      },
                      {
                        "choices": [
                          {
                            "title": "New",
                            "value": "new"
                          },
                          {
                            "title": "Active",
                            "value": "active"
                          },
                          {
                            "title": "Closed: True Positive - suspicious activity",
                            "value": "close_tp"
                          },
                          {
                            "title": "Closed: Benign Positive - suspicious but expected",
                            "value": "close_bp"
                          },
                          {
                            "title": "Closed: False Positive - incorrect alert logic",
                            "value": "close_fp_incorrect_logic"
                          },
                          {
                            "title": "Closed: False Positive - inaccurate data",
                            "value": "close_fp_inaccurate_data"
                          },
                          {
                            "title": "Closed: Undetermined",
                            "value": "close_undetermined"
                          }
                        ],
                        "id": "status_choices",
                        "placeholder": "Select from these choices",
                        "style": "compact",
                        "type": "Input.ChoiceSet"
                      }
                    ],
                    "type": "AdaptiveCard",
                    "version": "1.0"
                  },
                  "runAfter": {
                    "Get_MACAddress": [
                      "Succeeded"
                    ]
                  },
                  "type": "Compose"
                },
                "Make_Cisco_ISE_API_action": {
                  "actions": {
                    "Switch": {
                      "cases": {
                        "Case": {
                          "actions": {
                            "Assign_an_ANC_policy_to_an_endpoint": {
                              "inputs": {
                                "body": {
                                  "OperationAdditionalData": {
                                    "additionalData": [
                                      {
                                        "name": "macAddress",
                                        "value": "@{outputs('Get_MACAddress')}"
                                      },
                                      {
                                        "name": "policyName",
                                        "value": "@variables('PolicyName')"
                                      }
                                    ]
                                  }
                                },
                                "headers": {
                                  "Accept": "application/json",
                                  "Content-Type": "application/json"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['ciscoise']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/ers/config/ancendpoint/apply"
                              },
                              "limit": {
                                "timeout": "20S"
                              },
                              "type": "ApiConnection"
                            },
                            "Set_variable_11": {
                              "inputs": {
                                "name": "ActionResult",
                                "value": "Policy \"@{variables('PolicyName')}\" was not assigned to ANC endpoint \"@{outputs('Get_MACAddress')}\" due to errors while calling Cisco ISE API."
                              },
                              "runAfter": {
                                "Assign_an_ANC_policy_to_an_endpoint": [
                                  "Failed",
                                  "Skipped",
                                  "TimedOut"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Set_variable_12": {
                              "inputs": {
                                "name": "ActionResult",
                                "value": "Policy \"@{variables('PolicyName')}\" was assigned to ANC endpoint \"@{outputs('Get_MACAddress')}\"."
                              },
                              "runAfter": {
                                "Set_variable_11": [
                                  "Skipped"
                                ]
                              },
                              "type": "SetVariable"
                            }
                          },
                          "case": "assign_policy"
                        }
                      },
                      "expression": "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response')['data']['action_choices']",
                      "type": "Switch"
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "contains": [
                          "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response')",
                          "data"
                        ]
                      },
                      {
                        "contains": [
                          "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response').data",
                          "action_choices"
                        ]
                      }
                    ]
                  },
                  "runAfter": {
                    "Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "Parse_JSON": {
                  "inputs": {
                    "content": "@items('For_each')?['properties']?['additionalData']?['Custom Details']",
                    "schema": {
                      "properties": {
                        "MACAddress": {
                          "items": {
                            "type": "string"
                          },
                          "type": "array"
                        }
                      },
                      "type": "object"
                    }
                  },
                  "type": "ParseJson"
                },
                "Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response": {
                  "inputs": {
                    "body": {
                      "body": {
                        "messageBody": "@{outputs('Get_Teams_card_body')}",
                        "recipient": {
                          "channelId": "@variables('TeamsChannelId')"
                        },
                        "shouldUpdateCard": true
                      },
                      "notificationUrl": "@{listCallbackUrl()}"
                    },
                    "host": {
                      "connection": {
                        "name": "@parameters('$connections')['teams']['connectionId']"
                      }
                    },
                    "path": "/flowbot/actions/flowcontinuation/recipienttypes/channel/$subscriptions",
                    "queries": {
                      "groupId": "@variables('TeamsGroupId')"
                    }
                  },
                  "runAfter": {
                    "Get_Teams_card_body": [
                      "Succeeded"
                    ]
                  },
                  "type": "ApiConnectionWebhook"
                },
                "Update_incident_severity": {
                  "actions": {
                    "Switch_2": {
                      "cases": {
                        "Case": {
                          "actions": {
                            "Set_variable": {
                              "inputs": {
                                "name": "NewSeverity",
                                "value": "Incident severity was changed to \"High\""
                              },
                              "runAfter": {
                                "Update_incident": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Update_incident": {
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "severity": "High"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "case": "high"
                        },
                        "Case_2": {
                          "actions": {
                            "Set_variable_2": {
                              "inputs": {
                                "name": "NewSeverity",
                                "value": "Incident severity was changed to \"Medium\""
                              },
                              "runAfter": {
                                "Update_incident_2": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Update_incident_2": {
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "severity": "Medium"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "case": "medium"
                        },
                        "Case_3": {
                          "actions": {
                            "Set_variable_3": {
                              "inputs": {
                                "name": "NewSeverity",
                                "value": "Incident severity was changed to \"Low\""
                              },
                              "runAfter": {
                                "Update_incident_3": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Update_incident_3": {
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "severity": "Low"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "case": "low"
                        },
                        "Case_4": {
                          "actions": {
                            "Update_incident_4": {
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "severity": "Informational"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "case": "informational"
                        }
                      },
                      "expression": "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response')['data']['severity_choices']",
                      "type": "Switch"
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "contains": [
                          "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response')",
                          "data"
                        ]
                      },
                      {
                        "contains": [
                          "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response').data",
                          "severity_choices"
                        ]
                      }
                    ]
                  },
                  "runAfter": {
                    "Make_Cisco_ISE_API_action": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                },
                "Update_incident_status": {
                  "actions": {
                    "Switch_3": {
                      "cases": {
                        "Case": {
                          "actions": {
                            "Set_variable_4": {
                              "inputs": {
                                "name": "NewStatus",
                                "value": "Incident status was changed to \"New\""
                              },
                              "runAfter": {
                                "Update_incident_5": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Update_incident_5": {
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "status": "New"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "case": "new"
                        },
                        "Case_2": {
                          "actions": {
                            "Set_variable_5": {
                              "inputs": {
                                "name": "NewStatus",
                                "value": "Incident status was changed to \"Active\""
                              },
                              "runAfter": {
                                "Update_incident_6": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Update_incident_6": {
                              "inputs": {
                                "body": {
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "status": "Active"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "case": "active"
                        },
                        "Case_3": {
                          "actions": {
                            "Set_variable_6": {
                              "inputs": {
                                "name": "NewStatus",
                                "value": "Incident status was changed to \"Closed: True Positive - suspicious activity\""
                              },
                              "runAfter": {
                                "Update_incident_7": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Update_incident_7": {
                              "inputs": {
                                "body": {
                                  "classification": {
                                    "ClassificationAndReason": "TruePositive - SuspiciousActivity"
                                  },
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "status": "Closed"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "case": "close_tp"
                        },
                        "Case_4": {
                          "actions": {
                            "Set_variable_7": {
                              "inputs": {
                                "name": "NewStatus",
                                "value": "Incident status was changed to \"Closed: Benign Positive - suspicious but expected\""
                              },
                              "runAfter": {
                                "Update_incident_8": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Update_incident_8": {
                              "inputs": {
                                "body": {
                                  "classification": {
                                    "ClassificationAndReason": "BenignPositive - SuspiciousButExpected"
                                  },
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "status": "Closed"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "case": "close_bp"
                        },
                        "Case_5": {
                          "actions": {
                            "Set_variable_8": {
                              "inputs": {
                                "name": "NewStatus",
                                "value": "Incident status was changed to \"Closed: False Positive - incorrect alert logic\""
                              },
                              "runAfter": {
                                "Update_incident_9": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Update_incident_9": {
                              "inputs": {
                                "body": {
                                  "classification": {
                                    "ClassificationAndReason": "FalsePositive - IncorrectAlertLogic"
                                  },
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "status": "Closed"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "case": "close_fp_incorrect_logic"
                        },
                        "Case_6": {
                          "actions": {
                            "Set_variable_9": {
                              "inputs": {
                                "name": "NewStatus",
                                "value": "Incident status was changed to \"Closed: False Positive - inaccurate data\""
                              },
                              "runAfter": {
                                "Update_incident_10": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Update_incident_10": {
                              "inputs": {
                                "body": {
                                  "classification": {
                                    "ClassificationAndReason": "FalsePositive - InaccurateData"
                                  },
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "status": "Closed"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "case": "close_fp_inaccurate_data"
                        },
                        "Case_7": {
                          "actions": {
                            "Set_variable_10": {
                              "inputs": {
                                "name": "NewStatus",
                                "value": "Incident status was changed to \"Closed: Undetermined\""
                              },
                              "runAfter": {
                                "Update_incident_11": [
                                  "Succeeded"
                                ]
                              },
                              "type": "SetVariable"
                            },
                            "Update_incident_11": {
                              "inputs": {
                                "body": {
                                  "classification": {
                                    "ClassificationAndReason": "Undetermined"
                                  },
                                  "incidentArmId": "@triggerBody()?['object']?['id']",
                                  "status": "Closed"
                                },
                                "host": {
                                  "connection": {
                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                  }
                                },
                                "method": "put",
                                "path": "/Incidents"
                              },
                              "type": "ApiConnection"
                            }
                          },
                          "case": "close_undetermined"
                        }
                      },
                      "expression": "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response')['data']['status_choices']",
                      "type": "Switch"
                    }
                  },
                  "expression": {
                    "and": [
                      {
                        "contains": [
                          "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response')",
                          "data"
                        ]
                      },
                      {
                        "contains": [
                          "@body('Post_an_Adaptive_Card_to_a_Teams_channel_and_wait_for_a_response').data",
                          "status_choices"
                        ]
                      }
                    ]
                  },
                  "runAfter": {
                    "Update_incident_severity": [
                      "Succeeded"
                    ]
                  },
                  "type": "If"
                }
              },
              "foreach": "@triggerBody()?['object']?['properties']?['Alerts']",
              "runAfter": {
                "Initialize_variable_ActionResult": [
                  "Succeeded"
                ]
              },
              "type": "Foreach"
            },
            "Initialize_variable_ActionResult": {
              "inputs": {
                "variables": [
                  {
                    "name": "ActionResult",
                    "type": "string"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_NewStatus": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_NewSeverity": {
              "inputs": {
                "variables": [
                  {
                    "name": "NewSeverity",
                    "type": "string"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_PolicyName": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_NewStatus": {
              "inputs": {
                "variables": [
                  {
                    "name": "NewStatus",
                    "type": "string"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_NewSeverity": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_PolicyName": {
              "inputs": {
                "variables": [
                  {
                    "name": "PolicyName",
                    "type": "string",
                    "value": "[parameters('playbook3-PolicyName')]"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_TeamsChannelId": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_TeamsChannelId": {
              "inputs": {
                "variables": [
                  {
                    "name": "TeamsChannelId",
                    "type": "string",
                    "value": "[parameters('playbook3-TeamsChannelId')]"
                  }
                ]
              },
              "runAfter": {
                "Initialize_variable_TeamsGroupId": [
                  "Succeeded"
                ]
              },
              "type": "InitializeVariable"
            },
            "Initialize_variable_TeamsGroupId": {
              "inputs": {
                "variables": [
                  {
                    "name": "TeamsGroupId",
                    "type": "string",
                    "value": "[parameters('playbook3-TeamsGroupId')]"
                  }
                ]
              },
              "type": "InitializeVariable"
            }
          },
          "contentVersion": "1.0.0.0",
          "parameters": {
            "$connections": {
              "type": "Object"
            }
          },
          "triggers": {
            "When_Azure_Sentinel_incident_creation_rule_was_triggered": {
              "inputs": {
                "body": {
                  "callback_url": "@{listCallbackUrl()}"
                },
                "host": {
                  "connection": {
                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                  }
                },
                "path": "/incident-creation"
              },
              "type": "ApiConnectionWebhook"
            }
          }
        },
        "parameters": {
          "$connections": {
            "value": {
              "azuresentinel": {
                "connectionName": "[variables('playbook3-AzureSentinelConnectionName')]",
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook3-AzureSentinelConnectionName'))]",
                "id": "[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',parameters('workspace-location'),'/managedApis/azuresentinel')]"
              },
              "teams": {
                "connectionName": "[variables('playbook3-TeamsConnectionName')]",
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook3-TeamsConnectionName'))]",
                "id": "[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Web/locations/',parameters('workspace-location'),'/managedApis/teams')]"
              },
              "ciscoise": {
                "connectionId": "[resourceId('Microsoft.Web/connections', variables('playbook3-CiscoISEConnectionName'))]",
                "connectionName": "[variables('playbook3-CiscoISEConnectionName')]",
                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('playbook3-customApis_ciscoise_name'))]"
              }
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Web/customApis",
      "apiVersion": "2018-07-01-preview",
      "name": "[variables('playbook4-customApis_CiscoISE_name')]",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "connectionParameters": {
          "username": {
            "type": "securestring",
            "uiDefinition": {
              "displayName": "username",
              "description": "The username for this api",
              "tooltip": "Provide the username",
              "constraints": {
                "tabIndex": 2,
                "clearText": true,
                "required": "true",
                "capability": [
                  "gateway"
                ]
              }
            }
          },
          "password": {
            "type": "securestring",
            "uiDefinition": {
              "displayName": "password",
              "description": "The password for this api",
              "tooltip": "Provide the password",
              "constraints": {
                "tabIndex": 3,
                "clearText": false,
                "required": "true",
                "capability": [
                  "gateway"
                ]
              }
            }
          },
          "authType": {
            "type": "string",
            "allowedValues": [
              {
                "value": "basic"
              }
            ],
            "uiDefinition": {
              "displayName": "Authentication Type",
              "description": "Authentication type to connect to your API",
              "tooltip": "Authentication type to connect to your API",
              "constraints": {
                "tabIndex": 1,
                "required": "true",
                "allowedValues": [
                  {
                    "text": "basic",
                    "value": "basic"
                  }
                ],
                "capability": [
                  "gateway"
                ]
              }
            }
          },
          "gateway": {
            "type": "gatewaySetting",
            "gatewaySettings": {
              "dataSourceType": "CustomConnector"
            },
            "uiDefinition": {
              "constraints": {
                "tabIndex": 4,
                "required": "true",
                "capability": [
                  "gateway"
                ]
              }
            }
          }
        },
        "brandColor": "#FFFFFF",
        "description": "Cisco Identity Services Engine connector for on-premise gateway",
        "displayName": "[variables('playbook4-customApis_CiscoISE_name')]",
        "iconUri": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEgAAABICAMAAABiM0N1AAABdFBMVEUAAAAA//8AgP8Aqv8AgL8AmcwAmeYAotEAldUAn98AntsAodkAnNYAn9cIotgIntoHoNsHnNwHodcHndgGotoGoNsGnNYGn9cFn9sEoNgEndkEoNoEntsEntgEoNsEn9gDn9kDoNoDn9gDoNgDn9kFn9gFntgFn9kFn9oFoNoFn9gEn9kEoNkEn9oEoNgEn9kEntkEoNoEoNkEn9kEn9kEntkEoNgEntgEn9kEn9oEntoEn9gEoNgEntkEn9kEoNkEn9oEn9oEntgDn9kDn9gDoNkDn9kFn9oFn9gFn9kFntkFn9oEn9kEntoEn9gEoNkEn9kEoNkEn9oEn9gEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEn9kEntkEn9kEn9kEn9kEn9oDn9kFn9kEoNkEn9kEn9kEn9kEn9kEn9oEn9kEn9kEn9kEn9kEoNkEn9kEn9gEn9kEn9kEn9kEn9kEn9kEoNkEn9kEn9kEn9kEn9n///940Z2XAAAAenRSTlMAAQIDBAUKCwwQFRsfICEiIyQmJykrLC04Ozw+P0JGSEpTVVtdaGlqbW5wcnN1dnh5e35/gIGDhIeIiYqLjI2Oj5CRkpibnKSlp6mqsLGys7q7v8DCxMfKz9DS1NXW19jZ2t7g4+To6u3u7/Dx8vP09fb3+Pn6+/z9/h6/P2sAAAABYktHRHtP0rX8AAACB0lEQVRYw+2WaVPTYBRGb9SK4oI7dd+tAiqCra1FqKIoKu4bUFQQtJY2SUna2vPr/VCSafKmpONkHMfJ86m5OXOmN3Pfm4jEiRMnTtQZKadCkfWRHkTrlMKRcg8iIALkvxRlKsM+yq10RTLVW6qohuETuZWuSA1zi7+r/uiKBLb4z4jyxt0wUd5Ih4jyRlps7DCRjRUisrG26khpoOsdIDqR5bRmUvPhTsVFan7EKdjYMq5n2zdHK/5H6lRcJF31IU4hZ2TjNfJHolL4Qi71tLMv/xyOAInzV3LgftE0vjz1zMnRZz/qa28GAgg5PrtmrTw8onqG6oBvPQzqAJxQCe1eC4C68jExBKroOWA2NkUe4rZzwVWvZ78NzGeuZJc6RWW4qCUG+xXicBMac4X3gLXXI5oCHu0QkW2dogpcCCSmYeOkiKSACY+oCN93KofyHbReJgOIJWi/e17DgkdkwJx6uk83AWa2K4QJZ9rLE99rXQ8UyblvADcUwoCzIiJyB6pKa30B+yZx/iMsK0QR8iIi2gdY9IgKwEzC/7BFRPp+saEQD8A6JSLXgYJ3rG1g/mZq4mun6NKx/j2jsKIQh5rQfJF/CzQO9jCQm6VJlRh3B3LMP9rX7G6ihd0qoeXaR6SV05TDtm9y0dQ/z3aKXi1X9U9ju4IIST5ZtVYfJ+NlFydOnKjyG0KNPhWovN8UAAAAAElFTkSuQmCC",
        "backendService": {
          "serviceUrl": "[concat('https://', parameters('playbook4-API Hostname'), ':', parameters('playbook4-API Port'))]"
        },
        "capabilities": [
          "gateway"
        ],
        "apiType": "Rest",
        "swagger": {
          "swagger": "2.0",
          "info": {
            "version": "1.0.0",
            "title": "Cisco ISE custom connector",
            "description": "Cisco Identity Services Engine connector for on-premise gateway"
          },
          "host": "[concat(parameters('playbook4-API Hostname'), ':', parameters('playbook4-API Port'))]",
          "basePath": "/",
          "schemes": [
            "https"
          ],
          "consumes": [
            "application/json"
          ],
          "produces": [
            "application/json"
          ],
          "paths": {
            "/ers/config/guestuser/suspend/name/{guestName}": {
              "put": {
                "summary": "Suspend guest user by name",
                "parameters": [
                  {
                    "name": "Accept",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "Content-Type",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json; charset=utf-8",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "Cache-Control",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "no-cache",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "guestName",
                    "in": "path",
                    "required": true,
                    "description": "User name to suspend",
                    "type": "string",
                    "x-ms-summary": "UserName"
                  }
                ],
                "responses": {
                  "204": {
                    "description": "Indicates the REST API successfully carried out the desired action."
                  },
                  "400": {
                    "description": "Guest user is already suspended."
                  },
                  "401": {
                    "description": "This indicates that the action was undertaken with wrong credentials, no credentials or the account is not authorized to perform this action."
                  },
                  "404": {
                    "description": "Guest user is not found."
                  },
                  "500": {
                    "description": "Indicates an issue on the server side. Logs on ISE may help understand the cause."
                  }
                },
                "operationId": "[variables('_operationId-SuspendGuestUser')]"
              }
            },
            "/ers/config/ancendpoint/apply": {
              "put": {
                "responses": {
                  "default": {
                    "description": "default"
                  }
                },
                "summary": "Assign an ANC policy to an endpoint",
                "operationId": "[variables('_operationId-ANCEndpointApply')]",
                "parameters": [
                  {
                    "name": "Content-Type",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "Accept",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "body",
                    "in": "body",
                    "required": true,
                    "schema": {
                      "type": "object",
                      "properties": {
                        "OperationAdditionalData": {
                          "type": "object",
                          "properties": {
                            "additionalData": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "name": {
                                    "type": "string",
                                    "description": "name",
                                    "title": "4",
                                    "enum": [
                                      "macAddress",
                                      "ipAddress",
                                      "policyName"
                                    ]
                                  },
                                  "value": {
                                    "type": "string",
                                    "description": "value",
                                    "title": "4"
                                  }
                                },
                                "required": [
                                  "name",
                                  "value"
                                ]
                              },
                              "description": "additionalData"
                            }
                          },
                          "description": "OperationAdditionalData",
                          "required": [
                            "additionalData"
                          ]
                        }
                      },
                      "required": [
                        "OperationAdditionalData"
                      ]
                    }
                  }
                ]
              }
            },
            "/ers/config/ancendpoint/clear": {
              "put": {
                "responses": {
                  "default": {
                    "description": "default"
                  }
                },
                "summary": "Un-apply an ANC policy to an endpoint",
                "operationId": "[variables('_operationId-ANCEndpointClear')]",
                "parameters": [
                  {
                    "name": "Content-Type",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "Accept",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "body",
                    "in": "body",
                    "required": true,
                    "schema": {
                      "type": "object",
                      "properties": {
                        "OperationAdditionalData": {
                          "type": "object",
                          "properties": {
                            "additionalData": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "name": {
                                    "type": "string",
                                    "description": "name",
                                    "title": "4",
                                    "enum": [
                                      "macAddress",
                                      "ipAddress"
                                    ]
                                  },
                                  "value": {
                                    "type": "string",
                                    "description": "value",
                                    "title": "4"
                                  }
                                },
                                "required": [
                                  "name",
                                  "value"
                                ]
                              },
                              "description": "additionalData"
                            }
                          },
                          "description": "OperationAdditionalData",
                          "required": [
                            "additionalData"
                          ]
                        }
                      },
                      "required": [
                        "OperationAdditionalData"
                      ]
                    }
                  }
                ]
              }
            },
            "/ers/config/ancendpoint/{id}": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "ErsAncEndpoint": {
                          "type": "object",
                          "properties": {
                            "macAddress": {
                              "type": "string",
                              "description": "macAddress"
                            },
                            "policyName": {
                              "type": "string",
                              "description": "policyName"
                            }
                          },
                          "description": "ErsAncEndpoint"
                        }
                      }
                    }
                  }
                },
                "summary": "Get an ANC Endpoint",
                "operationId": "[variables('_operationId-ANCEndpointGetById')]",
                "parameters": [
                  {
                    "name": "id",
                    "in": "path",
                    "required": true,
                    "type": "string",
                    "x-ms-summary": "ANC Endpoint Id"
                  },
                  {
                    "name": "Content-Type",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "Accept",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  }
                ]
              }
            },
            "/ers/config/ancendpoint": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "SearchResult": {
                          "type": "object",
                          "properties": {
                            "total": {
                              "type": "integer",
                              "format": "int32",
                              "description": "Number of returned ANC endpoints",
                              "title": "total"
                            },
                            "resources": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "id": {
                                    "type": "string",
                                    "description": "ANC endpoint id"
                                  },
                                  "name": {
                                    "type": "string",
                                    "description": "ANC endpoint name"
                                  },
                                  "description": {
                                    "type": "string",
                                    "description": "ANC endpoint description"
                                  }
                                }
                              },
                              "description": "List of ANC endpoints"
                            },
                            "nextPage": {
                              "type": "object",
                              "properties": {
                                "rel": {
                                  "type": "string",
                                  "description": "rel",
                                  "title": "4",
                                  "x-ms-visibility": "internal"
                                },
                                "href": {
                                  "type": "string",
                                  "description": "Link to next page"
                                },
                                "type": {
                                  "type": "string",
                                  "description": "type",
                                  "title": "4",
                                  "x-ms-visibility": "internal"
                                }
                              },
                              "description": "nextPage"
                            },
                            "previousPage": {
                              "type": "object",
                              "properties": {
                                "rel": {
                                  "type": "string",
                                  "description": "rel",
                                  "title": "4",
                                  "x-ms-visibility": "internal"
                                },
                                "href": {
                                  "type": "string",
                                  "description": "Link to previous page"
                                },
                                "type": {
                                  "type": "string",
                                  "description": "type",
                                  "title": "4",
                                  "x-ms-visibility": "internal"
                                }
                              },
                              "description": "previousPage"
                            }
                          },
                          "description": "SearchResult"
                        }
                      }
                    }
                  }
                },
                "summary": "Get all ANC Endpoints",
                "operationId": "[variables('_operationId-ANCEndpointGetAll')]",
                "parameters": [
                  {
                    "name": "Content-Type",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "Accept",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  }
                ]
              }
            },
            "/ers/config/ancpolicy": {
              "post": {
                "responses": {
                  "default": {
                    "description": "default"
                  }
                },
                "summary": "Create an ANC Policy",
                "operationId": "[variables('_operationId-CreateANCPolicy')]",
                "parameters": [
                  {
                    "name": "Content-Type",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "Accept",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "body",
                    "in": "body",
                    "required": true,
                    "schema": {
                      "type": "object",
                      "properties": {
                        "ErsAncPolicy": {
                          "type": "object",
                          "properties": {
                            "name": {
                              "type": "string",
                              "description": "name",
                              "title": "4"
                            },
                            "actions": {
                              "type": "array",
                              "items": {
                                "type": "string",
                                "title": "4",
                                "enum": [
                                  "QUARANTINE",
                                  "PORTBOUNCE",
                                  "SHUTDOWN"
                                ]
                              },
                              "description": "actions"
                            }
                          },
                          "description": "ErsAncPolicy",
                          "required": [
                            "actions",
                            "name"
                          ]
                        }
                      },
                      "required": [
                        "ErsAncPolicy"
                      ]
                    }
                  }
                ]
              }
            },
            "/ers/config/endpoint/{id}": {
              "put": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "UpdatedFieldsList": {
                          "type": "object",
                          "properties": {
                            "updatedField": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "field": {
                                    "type": "string",
                                    "description": "field"
                                  },
                                  "oldValue": {
                                    "type": "string",
                                    "description": "oldValue"
                                  },
                                  "newValue": {
                                    "type": "string",
                                    "description": "newValue"
                                  }
                                }
                              },
                              "description": "updatedField"
                            }
                          },
                          "description": "UpdatedFieldsList"
                        }
                      }
                    }
                  }
                },
                "summary": "Update the group of an endpoint",
                "operationId": "[variables('_operationId-UpdateEndpointGroup')]",
                "parameters": [
                  {
                    "name": "id",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  },
                  {
                    "name": "Content-Type",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "Accept",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "body",
                    "in": "body",
                    "required": true,
                    "schema": {
                      "type": "object",
                      "properties": {
                        "ERSEndPoint": {
                          "type": "object",
                          "properties": {
                            "id": {
                              "type": "string",
                              "description": "id",
                              "title": "4"
                            },
                            "name": {
                              "type": "string",
                              "description": "name"
                            },
                            "description": {
                              "type": "string",
                              "description": "description",
                              "title": "4"
                            },
                            "mac": {
                              "type": "string",
                              "description": "mac",
                              "title": "4"
                            },
                            "profileId": {
                              "type": "string",
                              "description": "profileId"
                            },
                            "staticProfileAssignment": {
                              "type": "boolean",
                              "description": "staticProfileAssignment",
                              "title": "4",
                              "enum": [
                                "4",
                                true,
                                false
                              ]
                            },
                            "groupId": {
                              "type": "string",
                              "description": "groupId",
                              "title": "4"
                            },
                            "staticGroupAssignment": {
                              "type": "boolean",
                              "description": "staticGroupAssignment",
                              "title": "4",
                              "enum": [
                                "4",
                                true,
                                false
                              ]
                            },
                            "portalUser": {
                              "type": "string",
                              "description": "portalUser"
                            },
                            "identityStore": {
                              "type": "string",
                              "description": "identityStore"
                            },
                            "identityStoreId": {
                              "type": "string",
                              "description": "identityStoreId"
                            },
                            "customAttributes": {
                              "type": "object",
                              "properties": {
                                "customAttributes": {
                                  "type": "object",
                                  "properties": {
                                    "key1": {
                                      "type": "string",
                                      "description": "key1"
                                    },
                                    "key2": {
                                      "type": "string",
                                      "description": "key2"
                                    }
                                  },
                                  "description": "customAttributes"
                                }
                              },
                              "description": "customAttributes"
                            },
                            "mdmAttributes": {
                              "type": "object",
                              "properties": {
                                "mdmServerName": {
                                  "type": "string",
                                  "description": "mdmServerName"
                                },
                                "mdmReachable": {
                                  "type": "boolean",
                                  "description": "mdmReachable"
                                },
                                "mdmEnrolled": {
                                  "type": "boolean",
                                  "description": "mdmEnrolled"
                                },
                                "mdmComplianceStatus": {
                                  "type": "boolean",
                                  "description": "mdmComplianceStatus",
                                  "title": "4",
                                  "enum": [
                                    "4",
                                    true,
                                    false
                                  ]
                                },
                                "mdmOS": {
                                  "type": "string",
                                  "description": "mdmOS"
                                },
                                "mdmManufacturer": {
                                  "type": "string",
                                  "description": "mdmManufacturer"
                                },
                                "mdmModel": {
                                  "type": "string",
                                  "description": "mdmModel"
                                },
                                "mdmSerial": {
                                  "type": "string",
                                  "description": "mdmSerial"
                                },
                                "mdmEncrypted": {
                                  "type": "boolean",
                                  "description": "mdmEncrypted",
                                  "title": "4",
                                  "enum": [
                                    "4",
                                    true,
                                    false
                                  ]
                                },
                                "mdmPinlock": {
                                  "type": "boolean",
                                  "description": "mdmPinlock"
                                },
                                "mdmJailBroken": {
                                  "type": "boolean",
                                  "description": "mdmJailBroken"
                                },
                                "mdmIMEI": {
                                  "type": "string",
                                  "description": "mdmIMEI"
                                },
                                "mdmPhoneNumber": {
                                  "type": "string",
                                  "description": "mdmPhoneNumber"
                                }
                              },
                              "description": "mdmAttributes"
                            }
                          },
                          "description": "ERSEndPoint",
                          "required": [
                            "description",
                            "groupId",
                            "id",
                            "mac",
                            "staticGroupAssignment",
                            "staticProfileAssignment"
                          ]
                        }
                      },
                      "required": [
                        "ERSEndPoint"
                      ]
                    }
                  }
                ]
              }
            },
            "/ers/config/endpoint/getrejectedendpoints": {
              "get": {
                "responses": {
                  "default": {
                    "description": "default",
                    "schema": {
                      "type": "object",
                      "properties": {
                        "OperationResult": {
                          "type": "object",
                          "properties": {
                            "resultValue": {
                              "type": "array",
                              "items": {
                                "type": "object",
                                "properties": {
                                  "value": {
                                    "type": "string",
                                    "description": "value"
                                  },
                                  "name": {
                                    "type": "string",
                                    "description": "name"
                                  }
                                }
                              },
                              "description": "resultValue"
                            }
                          },
                          "description": "OperationResult"
                        }
                      }
                    }
                  }
                },
                "summary": "Get rejected endpoints",
                "operationId": "[variables('_operationId-GetRejectedEndpoints')]",
                "parameters": [
                  {
                    "name": "Content-Type",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "Accept",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  }
                ]
              }
            },
            "/ers/config/endpoint/{endpointMAC}/releaserejectedendpoint": {
              "put": {
                "responses": {
                  "default": {
                    "description": "default"
                  }
                },
                "summary": "Release rejected endpoint",
                "operationId": "[variables('_operationId-ReleaseRejectedEndpoint')]",
                "parameters": [
                  {
                    "name": "endpointMAC",
                    "in": "path",
                    "required": true,
                    "type": "string"
                  },
                  {
                    "name": "Content-Type",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  },
                  {
                    "name": "Accept",
                    "in": "header",
                    "required": true,
                    "type": "string",
                    "default": "application/json",
                    "x-ms-visibility": "internal"
                  }
                ]
              }
            }
          },
          "securityDefinitions": {
            "basic_auth": {
              "type": "basic"
            }
          },
          "security": [
            {}
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco ISE Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco ISE Data Parser",
            "category": "Samples",
            "functionAlias": "CiscoISEEvent",
            "query": "\nlet EventData = Syslog\n| where ProcessName contains \"CSCO\" or ProcessName contains \"CISE\"\n| where SyslogMessage matches regex (@'.*\\d{10}\\s(\\d{4,5})\\s.*')\n| extend EventVendor = 'CISCO'\n| extend EventProduct = 'ISE'\n| extend EventId = extract(@'.*\\d{10}\\s(\\d{4,5})\\s.*', 1, SyslogMessage)\n| extend EventSeverity = extract(@'.*(NOTICE|INFO|WARN|WARNING|ERROR|FATAL|DEBUG).*', 1, SyslogMessage)\n| extend EventCategory = extract(@'\\d{10}\\s\\d{4,5}\\s\\w+\\s(.*?):\\s.*?,', 1, SyslogMessage)\n| extend EventMessage = extract(@'\\d{10}\\s\\d{4,5}\\s\\w+\\s.*?:\\s(.*?),', 1, SyslogMessage)\n| extend ConfigVersionId = extract(@'ConfigVersionId=(.*?),', 1, SyslogMessage)\n| extend DvcIpAddr = extract(@'Device IP Address=(.*?),', 1, SyslogMessage)\n| extend DvcHostname = extract(@'NetworkDeviceName=(.*?),', 1, SyslogMessage)\n| extend DstIpAddr = extract(@'DestinationIPAddress=(.*?),', 1, SyslogMessage)\n| extend DstPortNumber = extract(@'DestinationPort=(.*?),', 1, SyslogMessage)\n| extend DstUserName = extract(@'UserName=(.*?),', 1, SyslogMessage)\n| extend NetworkProtocol = extract(@'Protocol=(.*?),', 1, SyslogMessage)\n| extend RequestLatency = extract(@'RequestLatency=(.*?),', 1, SyslogMessage)\n| extend NasIpAddress = extract(@'NAS-IP-Address=(.*?),', 1, SyslogMessage)\n| extend NasPort = extract(@'NAS-Port=(.*?),', 1, SyslogMessage)\n| extend NasPortType = extract(@'NAS-Port-Type=(.*?),', 1, SyslogMessage)\n| extend NasIdentifier = extract(@'NAS-Identifier=(.*?),', 1, SyslogMessage)\n| extend ServiceType = extract(@'Service-Type=(.*?),', 1, SyslogMessage)\n| extend FramedMtu = extract(@'Framed-MTU=(.*?),', 1, SyslogMessage)\n| extend CalledStationId = extract(@'Called-Station-ID=(.*?),', 1, SyslogMessage)\n| extend CallingStationId = extract(@'Calling-Station-ID=(.*?),', 1, SyslogMessage)\n| extend EventType = extract(@'Type=(.*?),', 1, SyslogMessage)\n| extend DvcAction = extract(@'Action=(.*?),', 1, SyslogMessage)\n| extend PrivilegeLevel = extract(@'Privilege-Level=(.*?),', 1, SyslogMessage)\n| extend SrcIpAddr = extract(@'Remote-Address=(.*?),', 1, SyslogMessage)\n| extend NetworkDeviceProfileId = extract(@'NetworkDeviceProfileId=(.*?),', 1, SyslogMessage)\n| extend AcsSessionId = extract(@'AcsSessionID=(.*?),', 1, SyslogMessage)\n| extend AcctSessionId = extract(@'Acct-Session-Id=(.*?),', 1, SyslogMessage)\n| extend AuthenType = extract(@'Authen-Type=(.*?),', 1, SyslogMessage)\n| extend AuthenticationIdentityStore = extract(@'AuthenticationIdentityStore=(.*?),', 1, SyslogMessage)\n| extend AuthenticationMethod = extract(@'AuthenticationMethod=(.*?),', 1, SyslogMessage)\n| extend SelectedAccessService = extract(@'SelectedAccessService=(.*?),', 1, SyslogMessage)\n| extend SelectedShellProfile = extract(@'SelectedShellProfile=(.*?),', 1, SyslogMessage)\n| extend IdentityGroup = extract(@'IdentityGroup=(.*?),', 1, SyslogMessage)\n| extend Service = extract(@'Service=(.*?),', 1, SyslogMessage)\n| extend ServiceArgument = extract(@'Service-Argument=(.*?),', 1, SyslogMessage)\n| extend CmdSet = extract(@'CmdSet=(.*?),', 1, SyslogMessage)\n| extend MatchedCommandSet = extract(@'MatchedCommandSet=(.*?),', 1, SyslogMessage)\n| extend AuthenMethod = extract(@'Authen-Method=(.*?),', 1, SyslogMessage)\n| extend SelectedCommandSet = extract(@'SelectedCommandSet=(.*?),', 1, SyslogMessage)\n| extend NetworkDeviceProfileName = extract(@'NetworkDeviceProfileName=(.*?),', 1, SyslogMessage)\n| extend PostureStatus = extract(@'PostureStatus=(.*?),', 1, SyslogMessage)\n| extend SelectedAuthorizationProfiles = extract(@'SelectedAuthorizationProfiles=(.*?),', 1, SyslogMessage)\n| extend AuthorizationPolicyMatchedRule = extract(@'AuthorizationPolicyMatchedRule=(.*).', 1, SyslogMessage)\n| extend DvcMacAddr = extract(@'device-mac=(.*?),', 1, SyslogMessage)\n| extend DevicePublicMac = extract(@'device-public-mac=(.*?),', 1, SyslogMessage)\n| extend DevicePlatform = extract(@'device-platform=(.*?),', 1, SyslogMessage)\n| extend DevicePlatformVersion = extract(@'device-platform-version=(.*?)\\s', 1, SyslogMessage)\n| extend DeviceType = extract(@'device-type=(.*?),', 1, SyslogMessage)\n| extend HttpUserAgentOriginal = extract(@'ac-user-agent=(.*).', 1, SyslogMessage)\n| extend MisconfiguredClientFixReason = extract(@'MisconfiguredClientFixReason=(.*?),', 1, SyslogMessage)\n| extend RadiusPacketType = extract(@'RadiusPacketType=(.*?),', 1, SyslogMessage)\n| extend EventTypeDetailed = extract(@'FailureReason=(.*?),', 1, SyslogMessage)\n| extend EventResultDetails = extract(@'DetailedInfo=(.*?).', 1, SyslogMessage)\n;\nlet EventName=datatable(EventId:string, EventDescription:string)[\"5200\",\"User authentication ended successfully\",\"5201\", \"User authentication ended successfully\",\"5202\",\"The requested Command Authorization passed\",\"5203\",\"The requested Session Authorization passed\",\"5205\",\"Dynamic Authorization succeeded\",\"5231\",\"Guest Authentication Passed\",\"5236\",\"Authorize-Only ended successfully\",\"5238\",\"\",\"5240\",\"Previously rejected endpoint was released to continue authentications\",\"5400\",\"User authentication failed. See FailureReason for more information\",\"5401\",\"User authentication failed. See FailureReason for more information\",\"5405\",\"RADIUS request dropped\",\"5406\",\"\",\"5407\",\"TACACS+ Authorization failed\",\"5411\",\"Supplicant did not respond to the last message that ISE sent to it\",\"5417\",\"Dynamic Authorization failed\",\"5434\",\"Endpoint conducted several failed authentications of the same scenario\",\"5436\",\"Ignoring this request because it is a duplicate of another packet that is currently being processed\",\"5440\",\"Endpoint started new authentication while previous is still in progress. Most probable that supplicant on that endpoint stopped conducting the previous authentication and started the new one. Closing the previous authentication\",\"5449\",\"Endpoint failed authentication of the same scenario several times and all further requests will be rejected for the duration of the Request Rejection Interval\",\"12508\",\"EAP-TLS handshake failed\",\"12514\",\"EAP-TLS failed SSL/TLS handshake because of an unknown CA in the client certificates chain\",\"12516\",\"EAP-TLS failed SSL/TLS handshake because of an expired certificate in the client certificates chain\",\"60114\",\"ISE server shutdown has been initiated\",\"60166\",\"Certificate Expiration warning\",\"60167\",\"Certificate has expired\",\"80002\",\"This message is generated when a profiler endpoint is profiled\",\"86009\",\"Guest user record is not found in the database\",\"86010\",\"Guest user authentication failed. Please check your password and account permission\",\"86011\",\"Guest user authentication failed. User is not enabled. Please contact your System Administrator\",\"86012\",\"Guest User must accept Access-Use policy before network access is granted\",\"86013\",\"Portal is not found in the database. Please contact your System Administrator\",\"86014\",\"User authentication failed. User account is suspended\",\"86015\",\"Invalid password change. Use correct password based on the password policy\",\"86016\",\"Timeout from server has exceeded the threshold. Please contact your System Administrator\",\"86017\",\"SessionID is missing. Please contact your System Administrator\",\"86018\",\"Guest Change of Authorization has failed. Please contact your System Administrator\",\"86019\",\"User access is restricted based on time profile. Please contact your System Administrator\",\"86020\",\"User authentication failed. Please contact your System Administrator\"];\nEventData\n| lookup EventName on EventId\n| project TimeGenerated\n        , EventVendor\n        , EventProduct\n        , EventId\n        , EventSeverity\n        , EventCategory\n        , EventMessage\n        , EventDescription\n        , ConfigVersionId\n        , DvcIpAddr\n        , DvcHostname\n        , DstIpAddr\n        , DstPortNumber\n        , DstUserName\n        , NetworkProtocol\n        , RequestLatency\n        , NasIpAddress\n        , NasPort\n        , NasPortType\n        , NasIdentifier\n        , ServiceType\n        , FramedMtu\n        , CalledStationId\n        , CallingStationId\n        , EventType\n        , DvcAction\n        , PrivilegeLevel\n        , SrcIpAddr\n        , NetworkDeviceProfileId\n        , AcsSessionId\n        , AuthenType\n        , AuthenticationIdentityStore\n        , AuthenticationMethod\n        , SelectedAccessService\n        , SelectedShellProfile\n        , IdentityGroup\n        , Service\n        , ServiceArgument\n        , CmdSet\n        , MatchedCommandSet\n        , AuthenMethod\n        , SelectedCommandSet\n        , NetworkDeviceProfileName\n        , PostureStatus\n        , SelectedAuthorizationProfiles\n        , AuthorizationPolicyMatchedRule\n        , DvcMacAddr\n        , DevicePublicMac\n        , DevicePlatform\n        , DevicePlatformVersion\n        , DeviceType\n        , HttpUserAgentOriginal\n        , MisconfiguredClientFixReason\n        , RadiusPacketType\n        , EventTypeDetailed\n        , EventResultDetails",
            "version": 1
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco ISE Hunting Query 1",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "CiscoISE - Authentication attempts to suspended user account",
            "category": "Hunting Queries",
            "query": "CiscoISEEvent\n| where TimeGenerated > ago(24h)\n| where EventId == '86014'\n| extend AccountCustomEntity = DstUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Search authentication attempts to suspended user account."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,CredentialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco ISE Hunting Query 2",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "CiscoISE - Dynamic authorization failed",
            "category": "Hunting Queries",
            "query": "let threshold = 10;\nCiscoISEEvent\n| where TimeGenerated > ago(24h)\n| where EventId == '5417'\n| summarize TotalEvents = count() by SrcIpAddr\n| where TotalEvents > threshold\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Search for dynamic authorization failed events."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco ISE Hunting Query 3",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "CiscoISE - Expired certificate in the client certificates chain",
            "category": "Hunting Queries",
            "query": "CiscoISEEvent\n| where TimeGenerated > ago(24h)\n| where EventId == '12516'\n| extend IPCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Search for expired certificates in the client certificates chain."
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco ISE Hunting Query 4",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "CiscoISE - Failed authentication events",
            "category": "Hunting Queries",
            "query": "CiscoISEEvent\n| where TimeGenerated > ago(24h)\n| where EventId in ('5400', '5401', '5412', '12508', '12514', '12516')\n| summarize count() by DstUserName\n| sort by count_\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Search for failed authentication events."
              },
              {
                "name": "tactics",
                "value": "CredentialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco ISE Hunting Query 5",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "CiscoISE - Failed login attempts via SSH CLI (users)",
            "category": "Hunting Queries",
            "query": "CiscoISEEvent\n| where TimeGenerated > ago(24h)\n| where EventId in ('60081', '60082')\n| summarize TotalEvents = count() by DstUserName\n| sort by TotalEvents\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Search for Failed login attempts via SSH CLI users."
              },
              {
                "name": "tactics",
                "value": "LateralMovement"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco ISE Hunting Query 6",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "CiscoISE - Guest authentication failed",
            "category": "Hunting Queries",
            "query": "CiscoISEEvent\n| where TimeGenerated > ago(24h)\n| where EventId in ('86009', '86010', '86011', '86012', '86013', '86014', '86015', '86016', '86017', '86018', '86019', '86020')\n| project TimeGenerated, DstUserName, SrcIpAddr, DstIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Search Guest authentication failed events."
              },
              {
                "name": "tactics",
                "value": "CredentialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco ISE Hunting Query 7",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "CiscoISE - Guest authentication succeeded",
            "category": "Hunting Queries",
            "query": "CiscoISEEvent\n| where TimeGenerated > ago(24h)\n| where EventId in ('5231', '5236')\n| project TimeGenerated, DstUserName, SrcIpAddr, DstIpAddr\n| extend AccountCustomEntity = DstUserName\n| extend IPCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Search for successful Guest authentication events."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,Persistence,PrivilegeEscalation,DefenseEvasion"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco ISE Hunting Query 8",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "CiscoISE - Rare or new useragent",
            "category": "Hunting Queries",
            "query": "let dt_lookBackPeriod = 30d;\nlet dt_lookBackTime = 24h;\nlet knownUserAgents =\nCiscoISEEvent \n| where TimeGenerated between (ago(dt_lookBackPeriod) .. ago(dt_lookBackTime))\n| where HttpUserAgentOriginal != ''\n| summarize makelist(HttpUserAgentOriginal)\n;\nCiscoISEEvent\n| where TimeGenerated > ago(dt_lookBackTime)\n| where HttpUserAgentOriginal !in (knownUserAgents)\n| summarize EventCount = count() by HttpUserAgentOriginal\n| project-away EventCount\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Search for rare useragent values."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco ISE Hunting Query 9",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "CiscoISE - Sources with high number of 'Failed Authentication' events",
            "category": "Hunting Queries",
            "query": "let threshold = 10;\nCiscoISEEvent\n| where TimeGenerated > ago(24h)\n| where EventId in ('5400', '5401')\n| summarize TotalEvents = count() by SrcIpAddr\n| where TotalEvents > threshold\n| project SrcIpAddr, TotalEvents\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Search sources with high number of Failed Authentication events."
              },
              {
                "name": "tactics",
                "value": "CredentialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco ISE Hunting Query 10",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "CiscoISE - Attempts to suspend the log collector",
            "category": "Hunting Queries",
            "query": "CiscoISEEvent\n| where TimeGenerated > ago(24h)\n| where EventId in ('59206', '59208')\n| extend IPCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Search for attempts to suspend the log collector."
              },
              {
                "name": "tactics",
                "value": "DefenseEvasion"
              }
            ]
          }
        }
      ]
    },
    {
      "id": "[variables('_connector1-source')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connectorName'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": " Cisco Identity Services Engine",
          "publisher": "Cisco",
          "descriptionMarkdown": "The Cisco Identity Services Engine (ISE) data connector provides the capability to ingest [Cisco ISE](https://www.cisco.com/c/en/us/products/security/identity-services-engine/index.html) events with Azure Sentinel. It helps you gain visibility into what is happening in your network, such as who is connected, which applications are installed and running, and much more. Refer to [Cisco ISE logging mechanism documentation](https://www.cisco.com/c/en/us/td/docs/security/ise/2-7/admin_guide/b_ise_27_admin_guide/b_ISE_admin_27_maintain_monitor.html#reference_BAFBA5FA046A45938810A5DF04C00591) for more information.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "CiscoISE",
              "baseQuery": "CiscoISEEvent"
            }
          ],
          "sampleQueries": [
            {
              "description": "Top 10 Reporting Devices",
              "query": "CiscoISEEvent\n | summarize count() by DvcHostname\n | top 10 by count_"
            }
          ],
          "dataTypes": [
            {
              "name": "Syslog(CiscoISE)",
              "lastDataReceivedQuery": "CiscoISEEvent\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CiscoISEEvent\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "write permission is required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "delete": true
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected. [Follow these steps](https://aka.ms/sentinel-ciscoise-parser) to create the Kusto Functions alias, **CiscoISEEvent**"
            },
            {
              "description": "Typically, you should install the agent on a different computer from the one on which the logs are generated.\n\n>  Syslog logs are collected only from **Linux** agents.",
              "instructions": [
                {
                  "parameters": {
                    "title": "Choose where to install the agent:",
                    "instructionSteps": [
                      {
                        "title": "Install agent on Azure Linux Virtual Machine",
                        "description": "Select the machine to install the agent on and then click **Connect**.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxVirtualMachine"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      },
                      {
                        "title": "Install agent on a non-Azure Linux Machine",
                        "description": "Download the agent on the relevant machine and follow the instructions.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxNonAzure"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      }
                    ]
                  },
                  "type": "InstructionStepsGroup"
                }
              ],
              "title": "1. Install and onboard the agent for Linux"
            },
            {
              "description": "Configure the facilities you want to collect and their severities.\n\n1.  Under workspace advanced settings **Configuration**, select **Data** and then **Syslog**.\n2.  Select **Apply below configuration to my machines** and select the facilities and severities.\n3.  Click **Save**.",
              "instructions": [
                {
                  "parameters": {
                    "linkType": "OpenSyslogSettings"
                  },
                  "type": "InstallAgent"
                }
              ],
              "title": "2. Configure the logs to be collected"
            },
            {
              "description": "[Follow these instructions](https://www.cisco.com/c/en/us/td/docs/security/ise/2-7/admin_guide/b_ise_27_admin_guide/b_ISE_admin_27_maintain_monitor.html#ID58) to configure remote syslog collection locations in your Cisco ISE deployment.",
              "title": "3. Configure Cisco ISE Remote Syslog Collection Locations"
            }
          ],
          "additionalRequirementBanner": "This data connector depends on a parser based on Kusto Function to work as expected. Follow the steps to use this Kusto Function alias **CiscoISEEvent** in queries and workbooks. [Follow steps to get this Kusto Function>](https://aka.ms/sentinel-ciscoise-parser)"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "contentId": "[variables('_sourceId')]",
        "version": "1.0.7",
        "kind": "Solution",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "CiscoISE",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Eli Forbes",
          "email": "v-eliforbes@microsoft.com"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "providers": ["Cisco"],
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoISEAdminPasswordReset')]",
              "version": "1.0.7"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoISEAttempDeleteLocalStoreLogs')]",
              "version": "1.0.7"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoISEBackupFailed')]",
              "version": "1.0.7"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoISECertExpired')]",
              "version": "1.0.7"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoISECmdExecutionWithHighestPrivilegesNewIP')]",
              "version": "1.0.7"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoISECmdExecutionWithHighestPrivilegesNewUser')]",
              "version": "1.0.7"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoISEDeviceChangedIP')]",
              "version": "1.0.7"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoISEDevicePostureStatusChanged')]",
              "version": "1.0.7"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoISELogCollectorSuspended')]",
              "version": "1.0.7"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoISELogsDeleted')]",
              "version": "1.0.7"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoISEAuthenticationToSuspendedAccount')]",
              "version": "1.0.7"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoISEDynamicAuthorizationFailed')]",
              "version": "1.0.7"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoISEExpiredCertInClientCertChain')]",
              "version": "1.0.7"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoISEFailedAuthentication')]",
              "version": "1.0.7"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoISEFailedLoginsSSHCLI')]",
              "version": "1.0.7"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoISEGuestAuthenticationFailed')]",
              "version": "1.0.7"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoISEGuestAuthenticationSuccess')]",
              "version": "1.0.7"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoISERareUserAgent')]",
              "version": "1.0.7"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoISESourceHighNumberAuthenticationErrors')]",
              "version": "1.0.7"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoISESuspendLogCollector')]",
              "version": "1.0.7"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CiscoISE-FalsePositivesClearPolicies')]",
              "version": "1.0.7"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CiscoISE-SuspendGuestUser')]",
              "version": "1.0.7"
            },
            {
              "kind": "Playbook",
              "contentId": "[variables('_CiscoISE-TakeEndpointActionFromTeams')]",
              "version": "1.0.7"
            },
            {
              "kind": "PlaybookTemplate",
              "contentId": "[variables('_CiscoISEConnector_LinkedTemplate')]",
              "version": "1.0.7"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_CiscoISEDataconnector')]",
              "version": "1.0.7"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_CiscoISEEvent')]",
              "version": "1.0.7"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_workbookContentId')]",
              "version": "1.0.7"
            }
          ]
        },
        "categories": {
          "domains": [
            "Security - Others"
          ]
        }
      }
    }
  ],
  "outputs": {}
}
