{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "author": "Eli Forbes - v-eliforbes@microsoft.com",
        "comments": "Solution template for VMWare Carbon Black"
    },
    "parameters": {
        "formattedTimeNow": {
            "type": "string",
            "defaultValue": "[utcNow('g')]",
            "metadata": {
                "description": "Appended to workbook displayNames to make them unique"
            }
        },
        "location": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
            }
        },
        "workspace-location": {
            "type": "string",
            "minLength": 1,
            "defaultValue": "[parameters('location')]",
            "metadata": {
                "description": "Region to deploy solution resources"
            }
        },
        "workspace": {
            "defaultValue": "",
            "type": "string",
            "metadata": {
                "description": "Workspace name for Log Analytics where Sentinel is setup"
            }
        },
        "analytic1-id": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "minLength": 1,
            "metadata": {
                "description": "Unique id for the scheduled alert rule"
            }
        },
        "analytic2-id": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "minLength": 1,
            "metadata": {
                "description": "Unique id for the scheduled alert rule"
            }
        },
        "workbook1-id": {
            "type": "string",
            "defaultValue": "[newGuid()]",
            "minLength": 1,
            "metadata": {
                "description": "Unique id for the workbook"
            }
        },
        "workbook1-name": {
            "type": "string",
            "defaultValue": "VMWare Carbon Black",
            "minLength": 1,
            "metadata": {
                "description": "Name for the workbook"
            }
        },
        "CarbonBlack_CustomConnector_Name": {
            "defaultValue": "CarbonBlackConnector",
            "type": "string",
            "metadata": {
                "description": "Name of the custom connector"
            }
        },
        "Service EndPoint": {
            "defaultValue": "https://{CarbonblackBaseURL}",
            "type": "string",
            "metadata": {
                "description": "enter the Carbon Black base URL (ex: https://defense.conferdeploy.net)"
            }
        },
        "CarbonBlack-TakeDeviceActionFromTeams_Playbook_Name": {
            "defaultValue": "CarbonBlack-TakeDeviceActionFromTeams",
            "type": "string",
            "metadata": {
                "description": "Name of the Playbook"
            }

        },
        "CarbonBlack-DeviceEnrichment_Playbook_Name": {
            "defaultValue": "CarbonBlack-DeviceEnrichment",
            "type": "string",
            "metadata": {
                "description": "Name of the Playbook"
            }
        },
        "CarbonBlack-QuarantineDevice_Playbook_Name": {
            "defaultValue": "CarbonBlack-QuarantineDevice",
            "type": "string",
            "metadata": {
                "description": "Name of the Playbook"
            }
        },
        "OrganizationKey": {
            "defaultValue": "OrganizationKey",
            "type": "string",
            "metadata": {
                "description": "Carbon Black Org Key"
            }
        },
        "PolicyId": {
            "defaultValue": "0",
            "type": "string",
            "metadata": {
                "description": "(Optional: can be configured in the playbook) For playbook which allows update policy, supply the policy ID from Carbon Black"
            }
        },
        "Teams_GroupId": {
            "defaultValue": "Teams_GroupId",
            "type": "string",
            "metadata": {
                "description": "(Optional: can be configured in the playbook) For playbook which sends an adaptive card to response from Teams. This is the Group ID of the Team channel"
            }
        },
        "Teams_ChannelId": {
            "defaultValue": "Teams_ChannelId",
            "type": "string",
            "metadata": {
                "description": "(Optional: can be configured in the playbook) For playbook which sends an adaptive card to response from Teams. This is the Channel ID of the Team channel"
            }
        }
    },
    "variables": {
        "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
        "_workbook-source": "[variables('workbook-source')]",
        "sourceId": "azuresentinel.azure-sentinel-solution-vmwarecarbonblack",
        "_sourceId": "[variables('sourceId')]",
        "analytic1": "89bd5523-17e6-41f7-9d2f-bb84f8e4544d",
        "_analytic1": "[variables('analytic1')]",
        "analytic2": "fa1bee4c-7467-46e3-b387-b0ae801f2cd3",
        "_analytic2": "[variables('analytic2')]",
        "playbookTakeDeviceActionFromTeams": "CarbonBlack-TakeDeviceActionFromTeams",
        "playbookDeviceEnrichment": "CarbonBlack-DeviceEnrichment",
        "playbookQuarantineDevice": "CarbonBlack-QuarantineDevice",
        "_playbookTakeDeviceActionFromTeams": "[variables('playbookTakeDeviceActionFromTeams')]",
        "_playbookDeviceEnrichment": "[variables('playbookDeviceEnrichment')]",
        "_playbookQuarantineDevice": "[variables('playbookQuarantineDevice')]",
        "linkedTemplate": "CarbonBlackConnector_LinkedTemplate",
        "_linkedTemplate": "[variables('linkedTemplate')]",
        "workbook": "sentinel-VMWareCarbonBlackWorkbook",
        "_workbook": "[variables('workbook')]"
    },
    "resources": [
        {
            "apiVersion": "2020-06-01",
            "name": "pid-ee5bee28-0b1d-4567-baf9-f7305ef17e6f-partnercenter",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
            "apiVersion": "2020-01-01",
            "kind": "Scheduled",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "description": "This creates an incident in the event a critical threat was identified on a Carbon Black managed endpoint.",
                "displayName": "Critical Threat Detected",
                "enabled": false,
                "query": "let timeframe = ago(1h);\n let threshold = 8;\n CarbonBlackNotifications_CL\n | where TimeGenerated > timeframe\n | where threatHunterInfo_score_d >= threshold\n | extend eventTime = datetime(1970-01-01) + tolong(threatHunterInfo_time_d/1000) * 1sec\n | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), count() by eventTime, Threat_Name = threatHunterInfo_reportName_s, Device_Name = deviceInfo_deviceName_s,  Internal_IP = deviceInfo_internalIpAddress_s, External_IP = deviceInfo_externalIpAddress_s, Threat_Score = threatHunterInfo_score_d\n | project-away count_\n | extend timestamp = StartTime, HostCustomEntity = Device_Name, IPCustomEntity = Internal_IP",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "tactics": [ "LateralMovement" ],
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "alertRuleTemplateName": "2ca4e7fc-c61a-49e5-9736-5da8035c47e0"
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
            "apiVersion": "2020-01-01",
            "kind": "Scheduled",
            "location": "[parameters('workspace-location')]",
            "properties": {
                "description": "This creates an incident when a known Malware is detected on a endpoint managed by a Carbon Black.",
                "displayName": "Known Malware Detected",
                "enabled": false,
                "query": "let timeframe = ago(1h);\n CarbonBlackEvents_CL\n | where TimeGenerated > timeframe\n | extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\n | where targetApp_effectiveReputation_s =~ \"KNOWN_MALWARE\"\n | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), count() by eventTime, deviceDetails_deviceName_s, deviceDetails_deviceIpAddress_s, processDetails_fullUserName_s, processDetails_targetName_s\n | extend timestamp = StartTime, AccountCustomEntity = processDetails_fullUserName_s, HostCustomEntity = deviceDetails_deviceName_s, IPCustomEntity = deviceDetails_deviceIpAddress_s",
                "queryFrequency": "PT1H",
                "queryPeriod": "PT1H",
                "severity": "Medium",
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "tactics": [ "Execution" ],
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "alertRuleTemplateName": "9f86885f-f31f-4e66-a39d-352771ee789e"
            }
        },
        {
            "type": "Microsoft.Insights/workbooks",
            "name": "[parameters('workbook1-id')]",
            "location": "[parameters('workspace-location')]",
            "kind": "shared",
            "apiVersion": "2020-02-12",
            "properties": {
                "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
                "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"7276a9d6-ba34-4f06-9a14-785f03cedf52\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"label\":\"Time Range\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":2419200000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true}},{\"id\":\"e10ce65c-0f31-4def-a81b-2c565d36a1d6\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"EventType\",\"label\":\"Event Type\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CarbonBlackEvents_CL\\n| distinct eventType_s\\n| sort by eventType_s asc\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"b7f7d6bb-20af-4f36-9d0e-389147598e04\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"ThreatIndicator\",\"label\":\"Threat Indicator\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| distinct tostring(threatIndicators_s)\\r\\n| sort by threatIndicators_s asc\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"34e19468-ad9e-4170-bd1e-d9970cc6df5b\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"PriorityType\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(deviceDetails_targetPriorityType_s)\\r\\n| distinct tostring(deviceDetails_targetPriorityType_s)\\r\\n| sort by deviceDetails_targetPriorityType_s asc\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"label\":\"Priority Type\"},{\"id\":\"b06c1de8-163e-4f8a-8cc5-5aa0fe3fccfc\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Location\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CarbonBlackEvents_CL\\r\\n| summarize count() by deviceDetails_deviceLocation_countryName_s\\r\\n| project deviceDetails_deviceLocation_countryName_s\\r\\n| order by deviceDetails_deviceLocation_countryName_s asc\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"046ce247-834a-49d5-9896-9d2bd5a559ce\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"SensorOS\",\"label\":\"Sensor OS\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"CarbonBlackEvents_CL\\n| distinct deviceDetails_deviceVersion_s\\n| sort by deviceDetails_deviceVersion_s asc\",\"value\":[\"value::all\"],\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"]},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"above\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize count() by bin(eventTime,{TimeRange:grain}), tostring(threatIndicators_s)\",\"size\":0,\"title\":\"Total Events by Threat Indicators\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"threatIndicators_s\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize count() by bin(eventTime, {TimeRange:grain}), deviceDetails_targetPriorityType_s\",\"size\":0,\"title\":\"Total Events by Priority Type\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"MEDIUM\",\"color\":\"orange\"},{\"seriesName\":\"HIGH\",\"color\":\"redBright\"}]}},\"customWidth\":\"50\",\"name\":\"query - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\n| mvexpand todynamic(threatIndicators_s)\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\n| summarize count() by City = netFlow_peerLocation_city_s, netFlow_peerLocation_countryName_s, latitude = netFlow_peerLocation_latitude_d, longitude = netFlow_peerLocation_longitude_d\\n| where isnotempty(City)\",\"size\":0,\"title\":\"Net Data Flow by City\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude\",\"longitude\":\"longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"City\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"},\"numberFormatSettings\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}}},\"customWidth\":\"50\",\"name\":\"query - 17 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\n| mvexpand todynamic(threatIndicators_s)\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\n| summarize count() by City = deviceDetails_deviceLocation_city_s, IPAddress = deviceDetails_deviceIpV4Address_s, Country = deviceDetails_deviceLocation_countryName_s, latitude = deviceDetails_deviceLocation_latitude_d, longitude = deviceDetails_deviceLocation_longitude_d\",\"size\":0,\"title\":\"Endpoint Generated Events by City\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude\",\"longitude\":\"longitude\",\"sizeSettings\":\"count_\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"City\",\"legendMetric\":\"count_\",\"legendAggregation\":\"Sum\",\"itemColorSettings\":{\"nodeColorField\":\"count_\",\"colorAggregation\":\"Sum\",\"type\":\"heatmap\",\"heatmapPalette\":\"greenRed\"},\"numberFormatSettings\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}}},\"customWidth\":\"50\",\"name\":\"query - 17\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize HIGH = countif(deviceDetails_targetPriorityType_s == \\\"HIGH\\\"), MEDIUM = countif(deviceDetails_targetPriorityType_s == \\\"MEDIUM\\\"), LOW = countif(deviceDetails_targetPriorityType_s == \\\"LOW\\\"),  Total = count() by ParentProcess = processDetails_name_s\\r\\n| top 10 by Total\",\"size\":0,\"title\":\"Top 10 Parent Processes\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"HIGH\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}},{\"columnMatch\":\"MEDIUM\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}}},{\"columnMatch\":\"LOW\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"yellowOrangeRed\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"Count\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}],\"labelSettings\":[{\"columnId\":\"ParentProcess\",\"label\":\"Parent Process\"},{\"columnId\":\"HIGH\"},{\"columnId\":\"MEDIUM\"},{\"columnId\":\"LOW\"},{\"columnId\":\"Total\"}]},\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ApplicationName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 9 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize count() by eventType_s\",\"size\":0,\"title\":\"Event Types\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 7\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize count() by targetApp_effectiveReputation_s\",\"size\":0,\"title\":\"Trageted Application Reputation Types\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"50\",\"name\":\"query - 7 - Copy\",\"styleSettings\":{\"progressStyle\":\"squares\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize Sensors = dcount(deviceDetails_deviceName_s)\",\"size\":0,\"title\":\"Total Sensors\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Count\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}}}]},\"tileSettings\":{\"titleContent\":{\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Sensors\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"}},\"showBorder\":false,\"size\":\"auto\"}},\"customWidth\":\"20\",\"name\":\"query - 9 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize Total = count() by Sensor = deviceDetails_deviceName_s\\r\\n| top 10 by Total\",\"size\":0,\"title\":\"Top 10 Event Generating Sensors\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"hotCold\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}}},{\"columnMatch\":\"Count\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true,\"maximumFractionDigits\":1}}}]}},\"customWidth\":\"40\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| where deviceDetails_deviceVersion_s in ({SensorOS}) or '*' in ({SensorOS})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| summarize Total = dcount(deviceDetails_deviceName_s) by ['OS Version'] = deviceDetails_deviceVersion_s\",\"size\":0,\"title\":\"Top 10 Sensor Operating Systems\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"blue\"}}]}},\"customWidth\":\"40\",\"name\":\"query - 9 - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| where targetApp_effectiveReputation_s == \\\"KNOWN_MALWARE\\\"\\r\\n| summarize count() by eventTime, processDetails_fullUserName_s, deviceDetails_deviceName_s, processDetails_targetName_s, targetApp_applicationName_s\\r\\n| project-away count_\\r\\n| sort by eventTime desc, deviceDetails_deviceName_s asc\",\"size\":0,\"title\":\"Recent Known Malware Detected\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"HIGH\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}},{\"columnMatch\":\"MEDIUM\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}}},{\"columnMatch\":\"LOW\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"yellowOrangeRed\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"Count\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}],\"labelSettings\":[{\"columnId\":\"eventTime\",\"label\":\"Event Time\"},{\"columnId\":\"processDetails_fullUserName_s\",\"label\":\"User\"},{\"columnId\":\"deviceDetails_deviceName_s\",\"label\":\"Endpoint\"},{\"columnId\":\"processDetails_targetName_s\",\"label\":\"Process Name\"},{\"columnId\":\"targetApp_applicationName_s\",\"label\":\"Application Name\"}]},\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ApplicationName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 9 - Copy - Copy\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CarbonBlackEvents_CL\\r\\n| mvexpand todynamic(threatIndicators_s)\\r\\n| where threatIndicators_s in ({ThreatIndicator}) or '*' in ({ThreatIndicator})\\r\\n| where deviceDetails_deviceLocation_countryName_s in ({Location}) or '*' in ({Location})\\r\\n| where deviceDetails_targetPriorityType_s in ({PriorityType}) or '*' in ({PriorityType})\\r\\n| where eventType_s in ({EventType}) or '*' in ({EventType})\\r\\n| extend eventTime = datetime(1970-01-01) + tolong(eventTime_d/1000) * 1sec\\r\\n| where targetApp_effectiveReputation_s == \\\"KNOWN_MALWARE\\\"\\r\\n| summarize count() by deviceDetails_deviceName_s, bin(TimeGenerated,{TimeRange:grain})\",\"size\":0,\"title\":\"Known Malware Activity by Endpoint\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"HIGH\",\"formatter\":8,\"formatOptions\":{\"palette\":\"redDark\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":true}}},{\"columnMatch\":\"MEDIUM\",\"formatter\":8,\"formatOptions\":{\"palette\":\"orange\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":1}}},{\"columnMatch\":\"LOW\",\"formatter\":8,\"formatOptions\":{\"palette\":\"blue\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}},{\"columnMatch\":\"Total\",\"formatter\":3,\"formatOptions\":{\"palette\":\"yellowOrangeRed\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":1}}},{\"columnMatch\":\"Count\",\"formatter\":0,\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2}}}],\"labelSettings\":[{\"columnId\":\"eventTime\",\"label\":\"Event Time\"},{\"columnId\":\"processDetails_fullUserName_s\",\"label\":\"User\"},{\"columnId\":\"deviceDetails_deviceName_s\",\"label\":\"Endpoint\"},{\"columnId\":\"processDetails_targetName_s\",\"label\":\"Process Name\"},{\"columnId\":\"targetApp_applicationName_s\",\"label\":\"Application Name\"}]},\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"ApplicationName\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"Count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"50\",\"name\":\"query - 9 - Copy - Copy - Copy\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/419581d6-4853-49bd-83b6-d94bb8a77887/resourcegroups/eco-connector-test/providers/microsoft.operationalinsights/workspaces/eco-connector-test\"],\"fromTemplateId\":\"sentinel-UserWorkbook\"}",
                "version": "1.0",
                "sourceId": "[variables('_workbook-source')]",
                "category": "sentinel"
            }
        },
        {
            "name": "CarbonBlack_Customconnector_LinkedTemplate",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Playbooks/CarbonBlack/CarbonBlackConnector/azuredeploy.json"
                },
                "parameters": {
                    "CustomConnectorName": {
                        "value": "[parameters('CarbonBlack_CustomConnector_Name')]"
                    },
                    "Service EndPoint": {
                        "value": "[parameters('Service EndPoint')]"
                    }
                }
            }
        },
        {
            "name": "CarbonBlack-TakeDeviceActionFromTeams_LinkedTemplate",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'CarbonBlack_Customconnector_LinkedTemplate')]"
            ],
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Playbooks/CarbonBlack/Playbooks/CarbonBlack-TakeDeviceActionFromTeams/azuredeploy.json"
                },
                "parameters": {
                    "PlaybookName": {
                        "Value": "[parameters('CarbonBlack-TakeDeviceActionFromTeams_Playbook_Name')]"
                    },
                    "OrganizationKey": {
                        "Value": "[parameters('OrganizationKey')]"
                    },
                    "PolicyId": {
                        "Value": "[int(parameters('PolicyId'))]"
                    },
                    "Teams GroupId": {
                        "Value": "[parameters('Teams_GroupId')]"
                    },
                    "Teams ChannelId": {
                        "Value": "[parameters('Teams_ChannelId')]"
                    }
                }
            }
        },
        {
            "name": "CarbonBlack-DeviceEnrichment_LinkedTemplate",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'CarbonBlack_Customconnector_LinkedTemplate')]"
            ],
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Playbooks/CarbonBlack/Playbooks/CarbonBlack-DeviceEnrichment/azuredeploy.json"
                },
                "parameters": {
                    "PlaybookName": {
                        "Value": "[parameters('CarbonBlack-DeviceEnrichment_Playbook_Name')]"
                    },
                    "OrganizationKey": {
                        "Value": "[parameters('OrganizationKey')]"
                    }
                }
            }
        },
        {
            "name": "CarbonBlack-QuarantineDevice_LinkedTemplate",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'CarbonBlack_Customconnector_LinkedTemplate')]"
            ],
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/Playbooks/CarbonBlack/Playbooks/CarbonBlack-QuarantineDevice/azuredeploy.json"
                },
                "parameters": {
                    "PlaybookName": {
                        "Value": "[parameters('CarbonBlack-QuarantineDevice_Playbook_Name')]"
                    },
                    "OrganizationKey": {
                        "Value": "[parameters('OrganizationKey')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "version": "1.0.6",
                "kind": "Solution",
                "contentId": "[variables('_sourceId')]",
                "parentId": "[variables('_sourceId')]",
                "source": {
                    "kind": "Solution",
                    "name": "VMWare Carbon Black",
                    "sourceId": "[variables('_sourceId')]"
                },
                "author": {
                    "name": "Eli Forbes",
                    "email": "v-eliforbes@microsoft.com"
                },
                "support": {
                    "tier": "Microsoft",
                    "email": "support@microsoft.com",
                    "name": "Azure Sentinel, Microsoft Corporation",
                    "link": "https://support.microsoft.com/"
                },
                "firstPublishDate": "2020-12-23",
                "providers": [ "VMWare" ],
                "dependencies": {
                    "operator": "AND",
                    "criteria": [
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('_analytic1')]",
                            "version": "1.0.6"
                        },
                        {
                            "kind": "AnalyticsRule",
                            "contentId": "[variables('_analytic2')]",
                            "version": "1.0.6"
                        },
                        {
                            "kind": "Playbook",
                            "contentId": "[variables('_playbookTakeDeviceActionFromTeams')]",
                            "version": "1.0.6"
                        },
                        {
                            "kind": "Playbook",
                            "contentId": "[variables('_playbookDeviceEnrichment')]",
                            "version": "1.0.6"
                        },
                        {
                            "kind": "Playbook",
                            "contentId": "[variables('_playbookQuarantineDevice')]",
                            "version": "1.0.6"
                        },
                        {
                            "kind": "PlaybookTemplate",
                            "contentId": "[variables('_linkedTemplate')]",
                            "version": "1.0.6"
                        },
                        {
                            "kind": "Workbook",
                            "contentId": "[variables('_workbook')]",
                            "version": "1.0.6"
                        }
                    ]
                },
                "categories": {
                    "domains": [ "Security - Endpoint Protection" ]
                }
            }
        }
    ],
    "outputs": {
    }
}