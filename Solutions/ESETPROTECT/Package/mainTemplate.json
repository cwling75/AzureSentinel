{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Nikhil Tripathi - v-ntripathi@microsoft.com",
    "comments": "Solution template for ESETPROTECT"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[parameters('location')]",
      "metadata": {
        "description": "Region to deploy solution resources"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "connector1-name": {
      "type": "string",
      "defaultValue": "b0cfd772-7b6e-42e8-b591-e5c0c2cabf4f"
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "ESETPROTECT",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "connector1-source": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',parameters('connector1-name'))]",
    "_connector1-source": "[variables('connector1-source')]",
    "ESETPROTECTConnector": "ESETPROTECTConnector",
    "_ESETPROTECTConnector": "[variables('ESETPROTECTConnector')]",
    "ESETThreatDetected_AnalyticalRules": "ESETThreatDetected_AnalyticalRules",
    "_ESETThreatDetected_AnalyticalRules": "[variables('ESETThreatDetected_AnalyticalRules')]",
    "ESETWebsiteBlocked_AnalyticalRules": "ESETWebsiteBlocked_AnalyticalRules",
    "_ESETWebsiteBlocked_AnalyticalRules": "[variables('ESETWebsiteBlocked_AnalyticalRules')]",
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "ESETPROTECT_Parser": "ESETPROTECT_Parser",
    "_ESETPROTECT_Parser": "[variables('ESETPROTECT_Parser')]",
    "ESETPROTECT_workbook": "ESETPROTECT_workbook",
    "_ESETPROTECT_workbook": "[variables('ESETPROTECT_workbook')]",
    "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
    "_workbook-source": "[variables('workbook-source')]",
    "sourceId": "cyberdefensegroupbv1625581149103.eset_protect",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "id": "[variables('_connector1-source')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connector1-name'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "ESET PROTECT",
          "publisher": "ESET",
          "descriptionMarkdown": "This connector gathers all events generated by ESET software through the central management solution ESET PROTECT (formerly ESET Security Management Center). This includes Anti-Virus detections, Firewall detections but also more advanced EDR detections. For a complete list of events please refer to [the documentation](https://help.eset.com/protect_admin/latest/en-US/events-exported-to-json-format.html).",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "ESETPROTECT",
              "baseQuery": "ESETPROTECT"
            }
          ],
          "sampleQueries": [
            {
              "description": "ESET threat events",
              "query": "ESETPROTECT\n| where EventType == 'Threat_Event'\n| sort by TimeGenerated desc"
            },
            {
              "description": "Top 10 detected threats",
              "query": "ESETPROTECT\n| where EventType == 'Threat_Event'\n| summarize ThreatCount = count() by tostring(ThreatName)\n| top 10 by ThreatCount"
            },
            {
              "description": "ESET firewall events",
              "query": "ESETPROTECT\n| where EventType == 'FirewallAggregated_Event'\n| sort by TimeGenerated desc"
            },
            {
              "description": "ESET threat events",
              "query": "ESETPROTECT\n| where EventType == 'Threat_Event'\n| sort by TimeGenerated desc"
            },
            {
              "description": "ESET threat events from Real-time file system protection",
              "query": "ESETPROTECT\n| where EventType == 'Threat_Event'\n| where ScanId == 'Real-time file system protection'\n| sort by TimeGenerated desc"
            },
            {
              "description": "Query ESET threat events from On-demand scanner",
              "query": "ESETPROTECT\n| where EventType == 'Threat_Event'\n| where ScanId == 'On-demand scanner'\n| sort by TimeGenerated desc"
            },
            {
              "description": "Top hosts by number of threat events",
              "query": "ESETPROTECT\n| where EventType == 'Threat_Event'\n| summarize threat_events_count = count() by HostName\n| sort by threat_events_count desc"
            },
            {
              "description": "ESET web sites filter",
              "query": "ESETPROTECT\n| where EventType == 'FilteredWebsites_Event'\n| sort by TimeGenerated desc"
            },
            {
              "description": "ESET audit events",
              "query": "ESETPROTECT\n| where EventType == 'Audit_Event'\n| sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "Syslog (ESETPROTECT)",
              "lastDataReceivedQuery": "ESETPROTECT\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "ESETPROTECT\n| summarize LastLogReceived = max(TimeGenerated)\n| project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "write permission is required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "delete": true
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">This data connector depends on a parser based on a Kusto Function to work as expected. [Follow these steps](https://aka.ms/sentinel-esetprotect-parser) to create the Kusto Functions alias, **ESETPROTECT**"
            },
            {
              "description": "Typically, you should install the agent on a different computer from the one on which the logs are generated.\n\n>  Syslog logs are collected only from **Linux** agents.",
              "instructions": [
                {
                  "parameters": {
                    "title": "Choose where to install the agent:",
                    "instructionSteps": [
                      {
                        "title": "Install agent on Azure Linux Virtual Machine",
                        "description": "Select the machine to install the agent on and then click **Connect**.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxVirtualMachine"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      },
                      {
                        "title": "Install agent on a non-Azure Linux Machine",
                        "description": "Download the agent on the relevant machine and follow the instructions.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxNonAzure"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      }
                    ]
                  },
                  "type": "InstructionStepsGroup"
                }
              ],
              "title": "1. Install and onboard the agent for Linux"
            },
            {
              "description": "Configure the facilities you want to collect and their severities.\n\n1.  Under workspace advanced settings **Configuration**, select **Data** and then **Syslog**.\n2.  Select **Apply below configuration to my machines** and select the facilities and severities. The default ESET PROTECT facility is **user**.\n3.  Click **Save**.",
              "instructions": [
                {
                  "parameters": {
                    "linkType": "OpenSyslogSettings"
                  },
                  "type": "InstallAgent"
                }
              ],
              "title": "2. Configure the logs to be collected"
            },
            {
              "description": "Configure ESET PROTECT to send all events thorugh Syslog.\n\n1.  Follow [these instructions](https://help.eset.com/protect_admin/latest/en-US/admin_server_settings_syslog.html) to configure syslog output. Make sure to select **BSD** as the format and **TCP** as the transport.\n\n2.  Follow [these instructions](https://help.eset.com/protect_admin/latest/en-US/admin_server_settings_export_to_syslog.html) to export all logs to syslog. Select **JSON** as the output format.",
              "instructions": [
                {
                  "parameters": {
                    "linkType": "OpenSyslogSettings"
                  },
                  "type": "InstallAgent"
                }
              ],
              "title": "3. Configure ESET PROTECT"
            }
          ],
          "additionalRequirementBanner": "This data connector depends on a parser based on Kusto Function to work as expected. Follow the steps to use this Kusto Function alias **ESETPROTECT** in queries and workbooks. [Follow steps to get this Kusto Function>](https://aka.ms/sentinel-esetprotect-parser)"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Escalates threats detected by ESET.",
        "displayName": "Threats detected by ESET",
        "enabled": false,
        "query": "ESETPROTECT\n| where EventType == \"Threat_Event\"\n| extend HostCustomEntity = DvcHostname, AccountCustomEntity = SrcUserName, IPCustomEntity = DvcIpAddr, FileHashCustomEntity = FileHashSha1, FileHashAlgo = \"SHA1\"\n",
        "queryFrequency": "PT5M",
        "queryPeriod": "PT5M",
        "severity": "Low",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Execution"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
      "apiVersion": "2020-01-01",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Create alert on websites blocked by ESET.",
        "displayName": "Website blocked by ESET",
        "enabled": false,
        "query": "ESETPROTECT\n| where EventType == 'FilteredWebsites_Event'\n| extend AccountCustomEntity = SrcUserName, URLCustomEntity = FilePath, HostCustomEntity = DvcHostname, IPCustomEntity = DvcIpAddr\n",
        "queryFrequency": "PT5M",
        "queryPeriod": "PT5M",
        "severity": "Low",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration",
          "CommandAndControl",
          "InitialAccess"
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "ESETPROTECT Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "ESETPROTECT Data Parser",
            "category": "Samples",
            "functionAlias": "ESETPROTECT",
            "query": "\n\r\nlet LogHeader = Syslog\r\n    | where ProcessName == \"ERAServer\"\r\n    | project-rename EventProduct = ProcessName \r\n    | extend EventVendor = \"ESET\",\r\n        Message = parse_json(SyslogMessage)\r\n    | extend EventType = Message['event_type'],\r\n        DvcIpAddr = Message['ipv4'],\r\n        EventResourceId = Message['source_uuid'],\r\n        EventCreationTime = make_datetime(Message['occured']),\r\n        EventSeverity = Message['severity'],\r\n        DvcHostname = Message['hostname'];\r\nlet ThreatEvents = LogHeader\r\n    | where EventType == \"Threat_Event\"\r\n    | extend ThreatCategory = Message['threat_type'],\r\n        ThreatName = Message['threat_name'],\r\n        ThreatFlags = Message['threat_flags'],\r\n        EventSubType = Message['scanner_id'],\r\n        EngineVersion = Message['engine_version'],\r\n        ObjectType = Message['object_type'],\r\n        FilePath = Message['object_uri'],\r\n        EventResult = Message['action_taken'],\r\n        EventError = Message['action_error'],\r\n        ScanId = Message['scanner_id'],\r\n        ThreatHandled = Message['threat_handled'],\r\n        NeedRestart = Message['need_restart'],\r\n        ProcessFilePath = Message['processname'],\r\n        EventMessage = Message['circumstances'],\r\n        FileHashSha1 = Message['hash'],\r\n        SrcUserDomain = todynamic(iff(Message['username'] contains '\\\\', split(Message['username'], '\\\\')[0], '')),\r\n        SrcUserName = todynamic(iff(Message['username'] contains '\\\\', split(Message['username'], '\\\\')[1], Message['username'])),\r\n        FirstSeen = make_datetime(Message['firstseen']);\r\nlet FirewallEvents = LogHeader\r\n    | where EventType == \"FirewallAggregated_Event\"\r\n    | extend EventMessage = Message['event'],\r\n        SrcDvcIpAddr = Message['source_address'],\r\n        SrcIpIsIpv6 = tobool(iff(Message['source_address_type'] == \"IPv6\", true, false)),\r\n        SrcPortNumber = Message['source_port'],\r\n        DstDvcIpAddr = Message['target_address'],\r\n        DstIpIsIpv6 = tobool(iff(Message['target_address_type'] == \"IPv6\", true, false)),\r\n        DstPortNumber = Message['target_port'],\r\n        NetworkProtocol = Message['protocol'],\r\n        DstUserDomain = todynamic(iff(tobool(Message['inbound']), iff(Message['account'] contains '\\\\', split(Message['account'], '\\\\')[0], ''), '')),\r\n        DstUserName = todynamic(iff(tobool(Message['inbound']), iff(Message['account'] contains '\\\\', split(Message['account'], '\\\\')[1], Message['account']), '')),\r\n        SrcUserDomain = todynamic(iff(tobool(Message['inbound']), '', iff(Message['account'] contains '\\\\', split(Message['account'], '\\\\')[0], ''))),\r\n        SrcUserName = todynamic(iff(tobool(Message['inbound']), '', iff(Message['account'] contains '\\\\', split(Message['account'], '\\\\')[1], Message['account']))),\r\n        ProcessFilePath = Message['process_name'],\r\n        NetworkRuleName = Message['rule_name'],\r\n        NetworkRuleNumber = Message['rule_id'],\r\n        NetworkDirection = todynamic(iff(tobool(Message['inbound']), \"Inbound\", \"Outbound\")),\r\n        ThreatName = Message['threat_name'],\r\n        EventCount = Message['aggregate_count'];\r\nlet HipsEvents = LogHeader\r\n    | where EventType == \"HIPSAggregated_Event\"\r\n    | extend ProcessFilePath = Message['application'],\r\n        EventSubType = Message['action'],\r\n        NetworkRuleName = Message['rule_name'],\r\n        NetworkRuleNumber = Message['rule_id'],\r\n        EventCount = Message['aggregate_count'];\r\nlet AuditEvents = LogHeader\r\n    | where EventType == \"Audit_Event\"\r\n    | extend SrcUserDomain = todynamic(iff(Message['action'] == 'Login attempt', '', Message['domain'])),\r\n        DstUserDomain = todynamic(iff(Message['action'] != 'Login attempt', '', Message['domain'])),\r\n        EventSubType = Message['action'],\r\n        EventMessage = Message['detail'],\r\n        DstUserName = Message['target'],\r\n        SrcUserName = Message['user'],\r\n        EventResult = Message['result'];\r\nlet EnterpriseInspectorAlertEvents = LogHeader\r\n    | where EventType == \"EnterpriseInspectorAlert_Event\"\r\n    | extend ProcessFilePath = Message['processname'],\r\n        SrcUserDomain = todynamic(iff(Message['username'] contains '\\\\', split(Message['username'], '\\\\')[0], '')),\r\n        SrcUserName = todynamic(iff(Message['username'] contains '\\\\', split(Message['username'], '\\\\')[1], Message['username'])),\r\n        NetworkRuleName = Message['rulename'],\r\n        FileHashSha1 = Message['hash'],\r\n        EventCount = Message['count'],\r\n        EventReportUrl = Message['eiconsolelink'];\r\nlet BlockedFilesEvents = LogHeader\r\n    | where EventType == \"BlockedFiles_Event\"\r\n    | extend ProcessFilePath = Message['processname'],\r\n        SrcUserDomain = todynamic(iff(Message['username'] contains '\\\\', split(Message['username'], '\\\\')[0], '')),\r\n        SrcUserName = todynamic(iff(Message['username'] contains '\\\\', split(Message['username'], '\\\\')[1], Message['username'])),\r\n        ThreatHandled = Message['resolved'],\r\n        FileHashSha1 = Message['hash'],\r\n        FilePath = Message['object_uri'],\r\n        EventSubType = Message['action'],\r\n        FirstSeen = make_datetime(Message['firstseen']),\r\n        EventMessage = Message['cause'];\r\nlet FilteredWebsiteEvents = LogHeader\r\n    | where EventType == \"FilteredWebsites_Event\"\r\n    | extend ProcessFilePath = Message['processname'],\r\n        SrcUserDomain = todynamic(iff(Message['username'] contains '\\\\', split(Message['username'], '\\\\')[0], '')),\r\n        SrcUserName = todynamic(iff(Message['username'] contains '\\\\', split(Message['username'], '\\\\')[1], Message['username'])),\r\n        ThreatHandled = Message['resolved'],\r\n        FileHashSha1 = Message['hash'],\r\n        EventMessage = Message['event'],\r\n        NetworkRuleNumber = Message['rule_id'],\r\n        EventResult = Message['action_taken'],\r\n        ScanId = Message['scanner_id'],\r\n        FilePath = Message['object_uri'],\r\n        UrlOriginal = Message['target_address'];\r\nunion ThreatEvents, AuditEvents, FirewallEvents, HipsEvents, BlockedFilesEvents, FilteredWebsiteEvents, EnterpriseInspectorAlertEvents\r\n| project-away SyslogMessage, Message\r\n",
            "version": 1
          }
        }
      ]
    },
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "2020-02-12",
      "properties": {
        "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## ESET PROTECT\\n**NOTE**: This workbook depends on a parser based on Kusto Function to work as expected [**ESETPROTECT**](https://aka.ms/sentinelgithubparsersesetprotect) which is deployed with the Azure Sentinel Solution.\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"c84a31aa-79fc-45f8-8991-8b56e0545a8c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":259200000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ESETPROTECT\\r\\n| where TimeGenerated {TimeRange}\\r\\n| summarize events_count = count() by tostring(EventType), bin(TimeGenerated, {TimeRange:grain})\",\"size\":0,\"title\":\"Events\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"allEventsOverTIme\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ESETPROTECT\\r\\n| where TimeGenerated {TimeRange}\\r\\n| where EventType == \\\"Threat_Event\\\"\\r\\n| summarize events_count = count() by tostring(ThreatName), bin(TimeGenerated, {TimeRange:grain})\",\"size\":0,\"title\":\"Threats\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"customWidth\":\"50\",\"name\":\"queryThreatsOverTime\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ESETPROTECT\\r\\n| where TimeGenerated {TimeRange}\\r\\n| where EventType == 'Threat_Event'\\r\\n| summarize events_count = count() by tostring(EventType)\",\"size\":3,\"title\":\"Top threats\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"threat_name_s\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"events_count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"customWidth\":\"33\",\"name\":\"queryTopThreats\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ESETPROTECT\\r\\n| where TimeGenerated {TimeRange}\\r\\n| where EventType == 'Threat_Event'\\r\\n| summarize events_count = count() by tostring(ThreatCategory)\",\"size\":3,\"title\":\"Top threats by type\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"queryTopThreatsByType\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ESETPROTECT\\r\\n| where TimeGenerated {TimeRange}\\r\\n| where EventType == 'Threat_Event'\\r\\n| summarize events_count = count() by HostName\",\"size\":3,\"title\":\"Most attacked hosts\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"queryMostAttackedHosts\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ESETPROTECT\\r\\n| where TimeGenerated {TimeRange}\\r\\n| where EventType == 'Threat_Event'\\r\\n| summarize events_count = count() by tostring(SrcUserName)\",\"size\":3,\"title\":\"Most attacked users\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"queryMostAttackedUsers\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ESETPROTECT\\r\\n| where TimeGenerated {TimeRange}\\r\\n| where EventType == \\\"FirewallAggregated_Event\\\"\\r\\n| where not(\\r\\n    ipv4_is_match(tostring(SrcDvcIpAddr), '192.168.0.0/24') or\\r\\n    ipv4_is_match(tostring(SrcDvcIpAddr), '172.16.0.0/12') or\\r\\n    ipv4_is_match(tostring(SrcDvcIpAddr), '10.0.0.0/8')\\r\\n    )\\r\\n| summarize count() by tostring(SrcDvcIpAddr)\",\"size\":3,\"title\":\"Top remote attackers\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"queryTopRemoteAttackers\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ESETPROTECT\\r\\n| where TimeGenerated {TimeRange}\\r\\n| where EventType == \\\"FilteredWebsites_Event\\\"\\r\\n| where EventResult == \\\"blocked\\\"\\r\\n| summarize count() by tostring(FilePath)\",\"size\":3,\"title\":\"Most blocked sites\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"queryMostBlockedSites\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"ESETPROTECT\\r\\n| where TimeGenerated {TimeRange}\\r\\n| where EventType == \\\"Threat_Event\\\"\\r\\n| project TimeGenerated, HostName, SrcUserName, ThreatCategory, ThreatName, ProcessFilePath, EventResult\\r\\n| sort by TimeGenerated desc\",\"size\":0,\"showAnalytics\":true,\"title\":\"Latest threats\",\"showExportToExcel\":true,\"exportToExcelOptions\":\"all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"rowLimit\":1000,\"filter\":true}},\"name\":\"queryLatestThreats\"}],\"fromTemplateId\":\"sentinel-ESETPROTECT\",\"$schema\":\"https://raw.githubusercontent.com/microsoft/Application-Insights-Workbooks/master/schema/workbook.json\"}\r\n",
        "version": "1.0",
        "sourceId": "[variables('_workbook-source')]",
        "category": "sentinel"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "version": "1.1.0",
        "kind": "Solution",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "ESETPROTECT",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Nikhil Tripathi",
          "email": "v-ntripathi@microsoft.com"
        },
        "support": {
          "name": "ESET Netherlands",
          "tier": "Partner",
          "link": "https://techcenter.eset.nl/en/"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_ESETPROTECTConnector')]",
              "version": "1.1.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_ESETThreatDetected_AnalyticalRules')]",
              "version": "1.1.0"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_ESETWebsiteBlocked_AnalyticalRules')]",
              "version": "1.1.0"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_ESETPROTECT_Parser')]",
              "version": "1.1.0"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_ESETPROTECT_workbook')]",
              "version": "1.1.0"
            }
          ]
        },
        "firstPublishDate": "2021-10-20",
        "providers": [
          "Cyber Defense Group B.V."
        ],
        "categories": {
          "domains": [
            "Security-ThreatProtection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
